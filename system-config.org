# -*- eval: (require 'ob-shell); -*-
:PROPERTIES:
:ID:       5ac04e2b-1128-4238-80b2-8b0814710be9
:header-args: :eval no :noweb yes
:END:
#+ARCHIVE: ::* Archived

* HOLD [#B] System: Gentoo Linux :COMMON:@home:HOLD:
:PROPERTIES:
:ID:       9fe29e54-81b8-47a1-888f-f1721f9dae54
:END:
:LOGBOOK:
- State "HOLD"       from "NEXT"          [2021-01-31 Sun 23:08]
- State "NEXT"       from "HOLD"          [2020-12-13 Sun 18:07]
- State "HOLD"       from "NEXT"          [2020-12-11 Fri 16:00] \\
  Get full installation first
:END:

System upgrade:

#+begin_src bash :eval (yes-or-no-p "Run Gentoo system upgrade? ")
;; FIXME: TBD
true
#+end_src

** Basic toolchain
*** System setup

The system is configured with full disk encryption, removed trusted
Windows EFI key, and Linux kernel stored on USB drive. I used Sakaki's
guide: [[id:273a40e160b2bac3abab5110fbee51a2f9c3b0ac][[Wiki.Gentoo]
User:Sakaki/Sakaki's EFI Install Guide - Gentoo Wiki]]

[2023-01-07 Sat] Using more up-to-date
https://wiki.gentoo.org/wiki/Full_Disk_Encryption_From_Scratch_Simplified#Create_partitions
but also mixing it with some parts of Sakaki guide.

*** =fstab=
:PROPERTIES:
:ID:       53823446-7763-4d86-b05f-ecea10718908
:END:

#+begin_src conf :tangle /sudo::/etc/fstab
  UUID=ea7aa879-3483-45c2-81cd-ecf40b49fb15		/				btrfs		defaults,noatime,discard			0 1
  UUID=46237a3e-f0de-4118-9071-4b2df1981729		none				swap		defaults,noatime,discard			0 0
  UUID=f78c1b6c-53f3-4d56-97b0-bd972090a257		/home				ext4		defaults,noatime,discard			0 2
  efivarfs						/sys/firmware/efi/efivars	efivarfs	rw,nosuid,nodev,noexec,relatime			0 0
  UUID=3244-9D07						/boot				vfat		noauto,noatime					1 2
#+end_src

*** Portage
:PROPERTIES:
:ID:       6723441a-8121-44b1-87f7-e32474f6c95c
:END:
**** Main package repository 
:PROPERTIES:
:ID:       11c8a8ef-978d-4dce-b88c-499999c9db28
:END:

#+begin_src conf :tangle /sudo::/etc/portage/repos.conf/gentoo.conf :mkdirp yes
[DEFAULT]
main-repo = gentoo

[gentoo]
location = /var/db/repos/gentoo
sync-type = webrsync
#sync-type = rsync
sync-uri = rsync://rsync.gentoo.org/gentoo-portage
auto-sync = yes

sync-rsync-verify-jobs = 1
sync-rsync-verify-metamanifest = yes
sync-rsync-verify-max-age = 24
sync-openpgp-key-path = /usr/share/openpgp-keys/gentoo-release.asc
sync-openpgp-keyserver = hkps://keys.gentoo.org
sync-openpgp-key-refresh-retry-count = 40
sync-openpgp-key-refresh-retry-overall-timeout = 1200
sync-openpgp-key-refresh-retry-delay-exp-base = 2
sync-openpgp-key-refresh-retry-delay-max = 60
sync-openpgp-key-refresh-retry-delay-mult = 4
sync-webrsync-verify-signature = yes
#+end_src

**** COMMENT Local repository
:PROPERTIES:
:ID:       ee57f631-c3e7-45eb-ad61-76712050d46d
:END:

Following [[id:dcc59f22a86ea7748f29708ce543e88f1d38c87a][[Wiki.Gentoo] Handbook:Parts/Portage/CustomTree - Gentoo Wiki]]

No comments on tangling - the file does not accept comments
#+begin_src conf :tangle /home/yantar92/Git/yantar92-overlay/profiles/repo_name :mkdirp yes :comments no
localrepo
#+end_src

#+begin_src conf :tangle /home/yantar92/Git/yantar92-overlay/metadata/layout.conf :mkdirp yes
masters = gentoo
auto-sync = false
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/repos.conf/localrepo.conf
[localrepo]
location = /var/db/repos/localrepo
priority = 50
sync-uri = file:///home/yantar92/Git/yantar92-overlay/
sync-type = git
auto-sync = yes
#+end_src

Instructions how to add new ebuilds: [[id:9bf6534c91e9c1bcc7ec03647dacb1b91eb8a4ce][[Wiki.Gentoo] Custom ebuild repository - Gentoo Wiki]]

Need to install repoman for managing repository.
**** Eclass docs: =eclass-manpages=

**** =make.conf=
***** Compiler flags
:PROPERTIES:
:ID:       850c2184-be3f-4a06-b0aa-a06feb74253b
:END:

#+name: numcpus
#+begin_src emacs-lisp :results silent :eval yes
(string-to-number (string-remove-suffix "\n" (shell-command-to-string "nproc")))
#+end_src

#+name: numcpusplusone
#+begin_src emacs-lisp :results silent :eval yes
(+ 1 <<numcpus()>>)
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/make.conf
# C, C++ and FORTRAN options for GCC.
MAKEOPTS="-j<<numcpusplusone()>> -l<<numcpus()>>"
EMERGE_DEFAULT_OPTS="--jobs=<<numcpusplusone()>> --load-average=<<numcpus()>>"
COMMON_FLAGS="-march=native -O3 -pipe"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"
#+END_SRC

***** Branch
:PROPERTIES:
:ID:       08a646ae-b6dd-438d-b156-99609e02bd56
:END:

Use the 'unstable' branch
#+BEGIN_SRC conf  :tangle /sudo::/etc/portage/make.conf
ACCEPT_KEYWORDS="~amd64"
#+END_SRC
***** Global use flags
:PROPERTIES:
:ID:       1f13c011-d5cc-42fa-bcd5-fce998e2ca77
:END:

- =vulkan=: graphic hardware acceleration

#+BEGIN_SRC conf  :tangle /sudo::/etc/portage/make.conf
USE="$USE X truetype bash-completion unicode emacs fontconfig gnuplot latex libnotify syslog udev pulseaudio"
USE="$USE -qt4 -qt3support -dvd -dvdr -firefox -gnome"
USE="$USE jit"
USE="$USE elogind -consolekit -systemd"
USE="$USE cjk"
USE="$USE vulkan"
CPU_FLAGS_X86="aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3"
#+END_SRC
***** Portage directories
:PROPERTIES:
:ID:       8ccb1316-8738-4930-96f4-ee671f8b68e7
:END:

#+BEGIN_SRC conf  :tangle /sudo::/etc/portage/make.conf
PORTDIR="/var/db/repos/gentoo"
DISTDIR="/var/cache/distfiles"
PKGDIR="/var/cache/binpkgs"
#+END_SRC
***** Language for build output
:PROPERTIES:
:ID:       9fff29b3-f207-4652-ac1c-736494e4bce1
:END:
#+BEGIN_SRC conf  :tangle /sudo::/etc/portage/make.conf
# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C
#+END_SRC
***** Emerge logging
:PROPERTIES:
:ID:       978c188c-bb0a-4e96-b5c0-52a441835213
:END:

#+BEGIN_SRC conf  :tangle /sudo::/etc/portage/make.conf
# Turn on logging - see http://gentoo-en.vfose.ru/wiki/Gentoo_maintenance
PORTAGE_ELOG_CLASSES="info warn error log qa"
# Echo messages after emerge, also save to /var/log/portage/elog
PORTAGE_ELOG_SYSTEM="echo save"

# Ensure elogs saved in category subdirectories.
# Build binary packages as a byproduct of each emerge, a useful backup
FEATURES="split-elog buildpkg"
#+END_SRC
***** Video cards
:PROPERTIES:
:ID:       54fb6f46-276e-4ca9-aeba-f705227788b4
:END:
#+BEGIN_SRC conf  :tangle /sudo::/etc/portage/make.conf
# Settings for X11
VIDEO_CARDS="intel i965"
INPUT_DEVICES="libinput"
#+END_SRC

***** Gentoo mirrors
:PROPERTIES:
:ID:       928605a8-3229-4371-bffb-df87937d83ac
:END:

#+BEGIN_SRC conf  :tangle /sudo::/etc/portage/make.conf
GENTOO_MIRRORS="https://mirror.yandex.ru/gentoo-distfiles/ http://gentoo.aditsu.net:8000/ http://mirror.rise.ph/gentoo http://ftp.daum.net/gentoo/ http://ftp.kaist.ac.kr/pub/gentoo/ https://ftp.lanet.kr/pub/gentoo/"
#+end_src
***** Languages
:PROPERTIES:
:ID:       dcd6e07f-4fff-48ec-a549-28fd1f391c99
:END:

#+BEGIN_SRC conf  :tangle /sudo::/etc/portage/make.conf
LINGUAS="en ru uk zh-CN"
L10N="en ru uk zh-CN"
#+end_src

*** Linux kernel

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-kernel/gentoo-sources
#+end_src

Firmware for Linux
#+begin_src conf  :tangle /sudo::/etc/portage/package.license/linux-firmware
sys-kernel/linux-firmware linux-fw-redistributable no-source-code
#+end_src

**** Disk encryption support

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-fs/cryptsetup
#+end_src

**** Building and installing the kernel (=genkernel= and =grub=)

Installing after update
#+begin_src bash :tangle no :eval no
genkernel --menuconfig all
grub-mkconfig -o /boot/grub/grub.cfg
#+end_src

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-kernel/genkernel
sys-boot/grub
# kernel signature and EFI trust certificate manipulation
app-crypt/efitools
#+end_src

#+begin_src conf :tangle /sudo::/etc/genkernel.conf
LUKS="yes"
LVM="yes"
ZFS="no"
GPG="yes"
NOCOLOR="false"
GK_SHARE="${GK_SHARE:-/usr/share/genkernel}"
CACHE_DIR="/var/cache/genkernel"
DISTDIR="${GK_SHARE}/distfiles"
LOGFILE="/var/log/genkernel.log"
LOGLEVEL=1
DEFAULT_KERNEL_SOURCE="/usr/src/linux"
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/make.conf
USE="$USE lvm"
#+end_src

#+begin_src bash :eval yes :tangle no
rc-update add lvm default
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/grub
sys-boot/grub:2 device-mapper
#+end_src

#+begin_src conf :tangle /sudo::/etc/default/grub
GRUB_DISTRIBUTOR="Gentoo"
GRUB_CMDLINE_LINUX="dolvm crypt crypt_root=UUID=b074fbfd-65b3-4830-971c-0dd07b8977b5 root_trim=yes root_key=luks-key.gpg"
GRUB_TIMEOUT="1"
#+end_src

*** Pip
:PROPERTIES:
:ID:       788b7100-b75c-4855-9427-7098fa62d354
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-python/pip
#+end_src
*** System logging =sysklogd=

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-admin/sysklogd
#+end_src

#+begin_src bash :tangle no :dir /sudo::/ :eval yes
rc-update add sysklogd default
#+end_src


*** cron
:PROPERTIES:
:ID:       d27b8294-d9d8-4007-8f5d-105acf6458de
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-process/cronie
#+end_src

#+begin_src bash :tangle no :dir /sudo::/ :eval yes
rc-update add cronie default
#+end_src


#+begin_src conf :tangle /sudo::/var/spool/cron/crontabs/yantar92 :mkdirp yes
SHELL=/bin/bash
PATH=/bin:/usr/bin:/home/yantar92/.local/bin
HOME=/home/yantar92
DISPLAY=:0
#+end_src

*** Hibernation \ Suspend (elogind)

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-auth/elogind
#+end_src


[2021-01-23 Sat] pm-utils is removed from Gentoo because upstream is abandoned. elogind should be sufficient though.

Note that it does not work automatically. Need to change [[id:2618d4b3-3cc6-41b6-b5aa-990c65a01ad0][ACPI(d)]] config.

**** Lock screen after resuming from suspend
:PROPERTIES:
:ID:       d2e3c848-dc21-46a8-80a4-336248e09ed1
:END:

#+begin_src bash :tangle /sudo::/etc/pm/sleep.d/01_lockscreen :shebang #!/bin/bash :mkdirp yes
case $1 in
    resume)
	export DISPLAY=:0
        sudo -u yantar92 xtrlock
esac
#+end_src

*** ntfs mount using ntfs3g
:PROPERTIES:
:ID:       ff4d23e0-4ca8-42b9-930b-8a1cebfb1579
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-fs/ntfs3g
#+end_src

*** COMMENT USB automount
:PROPERTIES:
:ID:       ea330abd-32a7-424f-ba95-1cdb7a400de4
:END:

I setup automount using udev rules linked with custom scripts for user
The rule assumes that user has sudo access (without password) to several programs.

#+PROPERTY: sudo-commands-list+ /bin/mount
#+PROPERTY: sudo-commands-list+ /bin/umount
#+PROPERTY: sudo-commands-list+ /usr/bin/ntfs-3g

Info on writing udev rules: [[id:9dbb819e99f9b83488b3cb901bd93828a3a5de1b][[Weng-Blog] Linux udev rule to create persistent device name | Wenwei's tech Blog]]

#+name: boot-id
#+begin_src emacs-lisp :results silent
yant/boot-pendrive-id
#+end_src

#+begin_src conf :tangle /sudo::/etc/udev/rules.d/99-automount.rules :noweb tangle
#skip boot pendrive
ENV{ID_SERIAL_SHORT}=="<<boot-id()>>", GOTO="media_by_label_auto_mount_end"
#skip non-pendrives
KERNEL!="sd[a-z][0-9]", GOTO="media_by_label_auto_mount_end"

# Import FS infos
IMPORT{program}="/sbin/blkid -o udev -p %N"

# Get a label if present, otherwise specify one
ENV{ID_FS_LABEL}!="", ENV{dir_name}="%E{ID_FS_LABEL}-%k"
ENV{ID_FS_LABEL}=="", ENV{dir_name}="usb%k"

# Global mount options
ACTION=="add", ENV{mount_options}="relatime"
# Filesystem-specific mount options
ACTION=="add", ENV{ID_FS_TYPE}=="vfat|ntfs", ENV{mount_options}="$env{mount_options},utf8,gid=100,umask=006,fmask=006"
ACTION=="add", ENV{ID_FS_TYPE}!="ntfs", ENV{mount_prog}="/bin/mount"
ACTION=="add", ENV{ID_FS_TYPE}=="ntfs", ENV{mount_prog}="/usr/bin/ntfs-3g"

# Mount the device
ACTION=="add", RUN+="/bin/mkdir -p /mnt/%E{dir_name}", RUN+="/usr/bin/sudo -u yantar92 /bin/touch /tmp/%E{dir_name}", RUN+="/bin/ln -s %E{mount_prog} /mnt/%E{dir_name}/%k"
ACTION=="add", RUN+="%E{mount_prog} -O $env{mount_options} /dev/%k /mnt/%E{dir_name}"

# Clean up after removal
ACTION=="remove", ENV{dir_name}!="", RUN+="/bin/umount -l /mnt/%E{dir_name}", RUN+="/bin/rm /mnt/%E{dir_name}/%k", RUN+="/bin/rmdir /mnt/%E{dir_name}"

# Exit
LABEL="media_by_label_auto_mount_end"
#+end_src

**** Monitor mounted pen drives
:PROPERTIES:
:ID:       e4a44d0f-6067-4952-88e0-4c3309beab6d
:END:

#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash
pgrep mount-pop.sh || while true; do mount-pop.sh 2>&1 >> /home/yantar92/.log/mount-pop.log; sleep 5; done &
#+end_src
*** USB automount with =udiskie=
:PROPERTIES:
:ID:       7b9bc636-1cfa-4a88-bb82-307452843023
:END:
[[id:github_coldfix_coldf_udisk_autom_remov_media][coldfix [Github] Coldfix Udiskie: Automounter for Removable Media]]

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-fs/udiskie
#+end_src

#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash
udiskie &
#+end_src

*** ACPI(d)
:PROPERTIES:
:ID:       2618d4b3-3cc6-41b6-b5aa-990c65a01ad0
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-power/acpid
#+end_src

Must run acpid service 
#+begin_src bash :tangle no :dir /sudo::/ :eval yes
rc-update add acpid default
#+end_src

**** Default handler 
:PROPERTIES:
:ID:       94815b9d-8ffb-44b9-8f71-2257299eb1af
:END:

#+begin_src bash :tangle /sudo::/etc/acpi/default.sh :shebang #!/bin/sh :mkdirp yes
# $Header: /etc/acpi/default.sh                          Exp $
# $Author: (c) 2012-2014 -tclover <tokiclover@dotfiles.> Exp $
# $License: MIT (or 2-clause/new/simplified BSD)         Exp $
# $Version: 2014/12/24 21:09:26                          Exp $
#
 
log() { logger -p daemon "ACPI: $*"; }
uhd() { log "event unhandled: $*"; }
 
set $*
group=${1%/*}
action=${1#*/}
device=$2
id=$3
value=$4
 
[ -d /dev/snd ] && alsa=true || alsa=false
[ -d /dev/oss ] && oss=true || oss=false
amixer="amixer -q set Master"
ossmix="ossmix -- vmix0-outvol"
 
case $group in
    # ac_adapter)
    # 	case $value in
    # 		*0) log "switching to power.bat power profile"
    # 			hprofile power.bat;;
    # 		*1) log "switching to power.adp power profile"
    # 			hprofile power.adp;;
    # 		*) uhd $*;;
    # 	esac
    # 	;;
    # battery)
    # 	case $value in
    # 		*0) log "switching to power.adp power profile"
    # 			hprofile power.adp;;
    # 		*1) log "switching to power.adp power profile"
    # 			hprofile power.adp;;
    # 		*) uhd $*;;
    # 	esac
    # 	;;
    button)
	case $action in
	    lid)
		case "$id" in
		    close) loginctl suspend;;
		    open) :;;
		    ,*) uhd $*;;
		esac
		;;
	    power) shutdown -H now;;
	    sleep) loginctl hibernate;;
	    #			mute) 
	    #				$alsa && $amixer toggle;;
	    #			volumeup) 
	    #				$alsa && $amixer 3dB+
	    #				$oss && $ossmix +3;;
	    #			volumedown) 
	    #				$alsa && $amixer 3dB-
	    #				$oss && $ossmix -3;;
	    ,*) uhd $*;;
	esac
	;;
    # cd)
    # 	case $action in
    # 	    play) :;;
    # 	    stop) :;;
    # 	    prev) :;;
    # 	    next) :;;
    # 	    *) uhd $*;;
    # 	esac
    # 	;;
    # jack)
    # 	case $id in
    # 	    *plug) :;;
    # 	    *) uhd $*;;
    # 	esac
    # 	;;
    video)
	case $action in
	    displayoff) :;;
	    brightnessup) log "Increasing brightness..."
			  /etc/acpi/actions/Fn-brightnessup.sh;;
	    brightnessdown) log "Decreasing brightness..."
			    /etc/acpi/actions/Fn-brightnessdown.sh;;
	    ,*) uhd $*;;
	esac
	;;
    ,*) uhd $*;;
esac
 
unset alsa oss amixer ossmix group action device id
#+end_src

**** Default screen brightness (on startup)
:PROPERTIES:
:ID:       89d3d2a6-422a-4147-a4df-5c0d274f8d51
:END:

#+begin_src conf :tangle /sudo::/etc/udev/rules.d/81-backlight.rules
SUBSYSTEM=="backlight", ACTION=="add", KERNEL=="intel_backlight", ATTR{brightness}="700"
#+end_src

**** Screen brightness key bindings
:PROPERTIES:
:ID:       5f8691a9-c348-49ce-b857-f2194e236a88
:END:

#+begin_src bash :tangle /sudo::/etc/acpi/actions/Fn-brightnessdown.sh :shebang #!/bin/bash :mkdirp yes
# Set the static decrement value.  Keep in mind that this will 
# be done twice. 
DecVal=150
LowDecVal=4 
 
# Set the Minimum we will accept. 
MinVal=0 
 
# Get the current brightness value. 
#CurrVal=$(cat /sys/class/backlight/intel_backlight/brightness); 
read -r CurrVal < "/sys/class/backlight/intel_backlight/brightness"
 
# Set the new value minus the decrement value. 
NewVal=$(($CurrVal<=$DecVal?($CurrVal - $LowDecVal):($CurrVal - $DecVal))); 
echo $NewVal 
 
# Set it to the threshold of the min value. 
ThresholdVal=$(($NewVal>$MinVal?$NewVal:$MinVal)) 
echo $ThresholdVal 
 
# Set the new value directly. 
echo -n $ThresholdVal > /sys/class/backlight/intel_backlight/brightness 
 
logger "[ACPI] brightnessdown |$CurrVal<nowiki>| |</nowiki>$NewVal| |$ThresholdVal|"
#+end_src

#+begin_src bash :tangle /sudo::/etc/acpi/actions/Fn-brightnessup.sh :shebang #!/bin/bash
# Set the static increment value.  Keep in mind that this will 
# be done twice. 
IncVal=150
LowIncVal=4 
 
# Get the Maximum value for use. 
#MaxVal=$(cat /sys/class/backlight/intel_backlight/max_brightness); 
read -r MaxVal < "/sys/class/backlight/intel_backlight/max_brightness"
 
# Get the current brightness value. 
#CurrVal=$(cat /sys/class/backlight/intel_backlight/brightness); 
read -r CurrVal < "/sys/class/backlight/intel_backlight/brightness"
 
# Set the new value minus the decrement value. 
NewVal=$(($CurrVal<$IncVal?($CurrVal + $LowIncVal):($CurrVal + $IncVal))); 
echo $NewVal 
 
# Set it to the threshold of the max value. 
ThresholdVal=$(($NewVal<$MaxVal?$NewVal:$MaxVal)) 
echo $ThresholdVal 
 
# Set the new value directly. 
echo -n $ThresholdVal > /sys/class/backlight/intel_backlight/brightness 
 
logger "[ACPI] brightnessup |$CurrVal| |$NewVal| |$ThresholdVal|"
#+end_src

*** gpg
:PROPERTIES:
:ID:       f34430cf-bc29-43a5-bcab-6d900bfb15c5
:END:

I had to copy pubring.gpg, pubring.kbx, trustdb.gpg, secring.gpg, and private-keys-v1.d
****************** TODO store them in attachment (personal)
****************** END

**** Yubikey settings 
:PROPERTIES:
:ID:       417d3116-ff38-4c30-9e35-729f888e50e6
:END:

***** Solving the issue with no card detection by =gnupg=
:PROPERTIES:
:ID:       e2bbff71-3798-4970-8bc9-57ab64fcec5a
:END:

Need to enable =libusb= explicitly (otherwise cannot detect the Yubikey):

#+begin_src conf :tangle /sudo::/etc/portage/package.use/gnupg
app-crypt/gnupg usb
#+end_src

***** Configuration tool: =yubikey-personalization-gui=
:PROPERTIES:
:ID:       e7e56336-d1e6-4619-9339-a9c22005e561
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-auth/yubikey-personalization-gui
#+end_src

***** Graphical password dialogue (pinentry)
:PROPERTIES:
:ID:       1bc946d6-358a-40fb-9e16-d42cfc7b7a7a
:END:

[[id:67113260e2a4d7c02a3868d0198dd7651949524b][[Wiki.Gentoo] GnuPG - Gentoo Wiki]]: Need =pinentry=

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-crypt/pinentry
#+end_src


Use GTK dialogue and allow password keyring
#+begin_src conf :tangle /sudo::/etc/portage/package.use/pinentry
app-crypt/pinentry gtk gnome-keyring
#+end_src

#+begin_src bash :tangle no :dir /sudo::/ :results none :eval yes
eselect pinentry set pinentry-gnome3
#+end_src

**** Password cache
:PROPERTIES:
:ID:       ec822407-901a-4b8f-b93b-3e6520e5a69f
:END:

#+begin_src conf :tangle /home/yantar92/.gnupg/gpg-agent.conf
# Set the default cache time to 1 day.
default-cache-ttl       86400
default-cache-ttl-ssh   86400

# Set the max cache time to 30 days.
max-cache-ttl           2592000
max-cache-ttl-ssh       2592000
#+end_src

*** ssh

I need to copy over my ssh key id_rsa and id_rsa.pub
****************** TODO store them in safe place
****************** END

*** lsof
:PROPERTIES:
:ID:       5bd3a13e-a1ad-4ee7-a653-3647f6ff2237
:END:

Useful to check what is using usb drive

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-process/lsof
#+end_src

*** alsa-utils
:PROPERTIES:
:ID:       0b604546-7e99-462d-8d49-24e1ec843547
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-sound/alsa-utils
#+end_src

*** Card reader
:PROPERTIES:
:ID:       c8c66d90-59ab-4429-be71-dab2eb71b34c
:END:

[[id:273a40e160b2bac3abab5110fbee51a2f9c3b0ac][[Wiki.Gentoo] User:Sakaki/Sakaki's EFI Install Guide - Gentoo Wiki]]:
There is issue with some card readers when kernel modules are available, but the hardware is not loaded:
#+begin_quote
Although the necessary kernel options (MMC_SDHCI and MMC_SDHCI_PCI) for this card are modularized in the minimal install kernel, there is a bug impacting the CF-AX3 (and many other machines) which prevents correct initialization when a card is inserted. To fix this, still in the second terminal, issue:
#+end_quote

#+begin_src conf :tangle /sudo::/etc/modprobe.d/sd-card-fix.conf :mkdirp yes
options sdhci debug_quirks=0x40
#+end_src

*** Network
**** WiFi configuration :crypt:TANGLE:
:PROPERTIES:
:ID:       2be6d6d0-1b92-44a4-a5d7-ea5cb77ab87d
:END:

-----BEGIN PGP MESSAGE-----

hQEMA3SKBiQ2zhL6AQf/dm+vDpfhdnfelU3xcajiCHfIeTX7yivx8Yj2trk471QY
PEsNFiou1Bg8XOL+OVi2LCLhCLJtOIATul8FFc+RhXR4BfuVaHuNVKFI1twpZii/
dJUzgVXkr3nnPumNach9Enkd8OrbMsAkoaMIp11pnH9cJhEO+flbnKPANg+V5YKd
foiopeCV/vzqKPzesniMLkGEmTAo4E//p1oAmCBFUwHS33aUcKxmu/p6vvftjYFH
0h4gwJHLtaAyhizT67xvh/p9Ltij6znEG1Zr7bvw+FM5bbykOKUFmEKKpSkooNNd
A65oyRqHkX6UWv970kQn2/tjald/kQSQCjV1pDy389LqAa2k6QsGUZ6edLUJIfP2
8ie8oeOOfzGpUI8CpmIynfMOkKPD+Uf60bfkf1oKa8+5SIx1BVdJGq/wo/SUeUNi
DRDPWHUeeF40IeHqtu3JhKLa5MtoqG06DE0KjCN4RmXiHdnWmPaTojqzS2Lzc5dA
1iCQlCBOPc2T7A/yiv4BHp9MnYSHUC2S27hHg/8/jutqhWXcUi21GEF+yn8JS+Xj
mdz4m97mWVp4vUwVW9nScEy/kWDMMbXI9y/XNCmF9WNRkzpUE/yrmmECLf5kxeDo
t7Uzhbc5QNXTmc/wAmQDJT4kqHB8tnegiR5V2nZE1TabIg9dSWcz3I+nWtxqRYP0
+JM9qCKgjtoIbBPfME/Pg9QrGjZnRGwEvG0m4OfmwGtSYCjX01ga6Qn7iOv4xeM/
dlWB0zT6GXoQlzFVWwfY3g7b66khDMC1xV3mReQui07XzJvxdCkKQLKDt2nWWyYa
t8mQFuK6jk9S2/hknA8ui2HUPOJczVAx5GlgqkHsSppgJe4s9ZQMEjh7HK29+VEh
w1UeYVt3sc35fq0zWREjjziNXEjArDtW7+TU6UVwOjK5v+Y22xfNsZUtmwh5e48F
S6ztOYGsuEQHFy5O0IT6YDM2hOPOGQv8eogFiWFvsRQ7q4+5gKhHB0G5AsSfi/A/
5GFj7tk1fZFx4TSxH8sBNe4sWcoc675SH65Q9ndb0QL2OTapFzgc6lf8mnt+80x1
Nh6DuPpxN4udm4KqlcvqA05kXDgEGbyyDYFEBIGo8XKoTX5z9Hrk4sdkYZ09k/1v
1ZHrpItjn25dgFUDo3gozFDXPMiU48vwpBcNVoume9xTpDCr9u8MZ/4+O5DwDR0W
S0xUCc0lvAOQmhnWP/ePhK0NSTGe7fslQLTMgSqrQ7rbaf34nNmT8jDxeB14Mfcj
be8CnzAbfqcTagpQroMakysrI+TCyFUIfsFwDpt1k/oPq4X7JYAHVejxOHrkh/rZ
6P5Oe9NiPNe59xJzWpAlZEDicBYaAo0p3VPQUOze0h/BZAtT7OMnh7SrLfHabqYN
2EtoQVwY37WTHCW0xWuSMP5E/B6gQm3NysGMCuaDnCGxHLdEd/WAwOUjoeqiRe9j
c6oeKarkAVeVtRXKGWhSPZQWHIvMWAaciQW94LYiVSp1APIGbzhojswHWocA9pcl
2B22u8obHWiCKygYrt9UmqjKWgH+z8pnoXfRc8xez8PQPqQZX/ZiFIHhrJpfI+YS
pn0miCmzONHXeJi5MVygk71eZctV3pbeDTqc2aP79lZTNl5V71DKfK0MBg71vXCj
yCI0DAHDzvAnCrtCAcEUwb2X6nrtWAdAqZLQrawYW9mtxxHYNOndwu18s0i4HEXC
wumIJWt8G6hSU6Av8EwPXYQytX+lKjVOpb4iQbUAefUUUJ5JPpxGRQonUi5wQWmD
Bkmzlv1nngF+fd9FSDy46AFDHomjD2p69O0M0H4LDhu6V+fUIGQiRyOy83h8KJjZ
3KoxkJUc4f1BI1ZescLl3jyGjA4igfH8cWl1Ll0kLxFbJeyQjlV8GzJh2kG2+y3f
9fKdmmcE2dgwTMwLvyr4M0auYtI2+krjA2ZOqcw3ptAX2m2uAVRDByJK1EbLovxy
AV+cUT63eMk33U0fXAmxHVjkwnAXT5TmUbVlLjYTCzuU8IyW/VPNHXKpl1o5GFUr
wQfxqnHmCw0EAYAAmDGIvEErqe6VR9J48k+xmgktYyL7butDiwyNySvXB0skbP5M
8PGAX0WNxweGs9MSxjm9CY82LPw+xNUtS2BtQzcrllIHYEfI8gj+gMbhPrz9cZND
OlsIG2BamZ4IdMxsJdBdiUN+Jk2a3j3Hawf0wTA0vbE68b149OPGmEpIRYaSXY9R
naVO1vbTLBDLAMOuGfe6VGzcociqsTnzmnvq6oiAPJdYydSKTfBZ2D0EImYDe8zV
m0VVRcpdLLEcgtYc4JSG2SykSjM0YTa3tzQRncLsg1rkWWy+J3aNKAno+2HDwXa7
f2yVR3/HILsOQx4rOYwarzSIk0V6lzGie8ODm25AowAoTIPZ++MjbXS5SfkwuN1h
eTWhKtNjFFspHc2r+LAVlr6uVCy93IInSljXBg6cDPZ6jo5rZ7/sAG8SJV9qriVG
X/6KtagIwCUI/OqMgg/G+JXm1DSpy2kR4rPVfULeMhBAnPx+rrYmrVeOg1+2pjV8
301W3N4tfORv/RQqulbzstZTLB9CwA==
=JVP8
-----END PGP MESSAGE-----
**** User access to wpa_supplicant gui + TKIP support for common WiFi routers in China
:PROPERTIES:
:ID:       61f8e36a-9e49-4407-9cb6-44b8d2d2f131
:END:

I need to grant superuser access for calling wpa_gui if I want to be able to change networks on-the-fly.
[2022-04-03 Sun] After update, I am suddenly unable to connect to all the password-protected WiFi in the area (except my phone). The WiFi is working, but there is no connection. Seems to be crypto support issue with changed defaults after update.
#+PROPERTY: sudo-commands-list+ /usr/bin/wpa_gui

#+begin_src conf :tangle /sudo::/etc/portage/package.use/wpa_supplicant
net-wireless/wpa_supplicant qt5 tkip
#+end_src

**** wireless-tools
:PROPERTIES:
:ID:       1f3dda9d-68c9-408b-bae0-7cdec63a0882
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-wireless/wireless-tools
#+end_src

**** VPN

***** Kernel configuration

[[id:bdff11995982e871875b024ba60a988d82aa66c8][[Wiki.Gentoo] OpenVPN - Gentoo Wiki]]
[[id:f7a56a1f03ef6bebbec21cea94a22a6a7d39ee11][[Wiki.Gentoo] Wireguard - Gentoo Wiki]]
***** VPN service :crypt:TANGLE:
-----BEGIN PGP MESSAGE-----

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
=6v6D
-----END PGP MESSAGE-----
*** Docker
:PROPERTIES:
:ID:       8abca0b9-a070-4362-ab0b-abe6bafaddae
:END:

Installing following [[id:6ac6c92eec714e52a7fb5cf0e1a70ef62b789b83][[Wiki.Gentoo] Docker - Gentoo Wiki]]

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-containers/docker
#+end_src

#+begin_src bash :eval yes :tangle no
rc-update add docker default
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/docker
app-containers/docker btrfs cli
#+end_src
*** Podman - alternative to docker
:PROPERTIES:
:ID:       11c49d2f-6a8a-4d5c-87a3-48442c266795
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-containers/podman
#+end_src

Also, need to manually install config and policy files.
#+begin_src bash :eval yes :tangle no :dir /sudo::/
cp /etc/containers/policy.json.example /etc/containers/policy.json
cp /etc/containers/registries.conf.example /etc/containers/registries.conf
# see https://forums.gentoo.org/viewtopic-t-1145234-start-0.html
sed -i -e 's|location="quay.io/libpod"|location="docker.io/library"|' /etc/containers/registries.conf
#+end_src

#+RESULTS:
**** Rake - automation for [[id:Email-<bzg@gnuorg>2022-re-using-sr-17d][https://git.sr.ht/~bzg/org-mode-tests Bastien <bzg@gnu.org> [Email] (2022) Re: Using sr.ht CI for Org tests]]

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-ruby/rake
#+end_src

*** 7z (p7zip)
:PROPERTIES:
:ID:       678f1405-0f29-4886-bb4b-18559732a348
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-arch/p7zip
#+end_src

*** Calculator (bc)
:PROPERTIES:
:ID:       d847e7b7-e885-44db-8f02-0dcf43a0c96c
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-devel/bc
#+end_src

*** sudo :crypt:TANGLE:
:PROPERTIES:
:ID:       ba3805aa-10c2-4636-a953-b08441fdec0d
:END:

-----BEGIN PGP MESSAGE-----

hQEMA3SKBiQ2zhL6AQf/UmaANBYo8ctQHfyL1h0ZGAUyb+zkbg1m2H4/TiMmLSxm
3n2VxTiUSdvszWuSVCg388icDfp5HOB4Bd4fL8TJ6xFAh+LVejvZvXEVwp1SKW2E
U7qyVpoyld/UA7hi/ueO2eS6eWve15Cc2m5hw4oGHPTnrxZ3rRl4T7PSU7jcihCd
ZeUj5MbANuvx+mQ0VlNLEY0C9FHNPlp+d6nH5XcYCHmmTdz/KsKNtzCMgOBGvSrH
7aHwfa5vBXIhGIGlZ7uVhDf0h2NLHf5kIB1SV2T1ea2XrUv2MlRE/XxleHs/sxPf
SO6Oclt32ftDDzjVoUWt44dW+/O0YFUp2wWN03CvMtLA0QGmYDh68gb6/otFZCv0
kAiD4UVuIrulfTWCr5akvuN7dpMOaV9iM7v2DmV5UFSsJzDBTE+xsejlEtLFekDO
+9bfvBWkpvl2uEPq2ukgaCWCWwdnLP50PIs/ZCKzo2oXxaH4DdUwCv/a6W93UjXw
iNQm8iIwVabR6XJVQaj97/k0k7Eja56zs/tb/2CBa22miIpr8GOxc4rUOjhJoGAr
6m4mb8OfdOysB2FDXmeM//YK/pXBfrmxl3JQxSD2J3yaYkBpeb5yH5vm1omelGWy
iEy5YHiVJ2CAN/hiN9YwI4jazPR04k+0McYzDt6P92Q9PxsHYl7NTKnpGtwakSZW
9lfJtflKM9oE+eThyDmuIehER/QiywYlhJAEET5hWg1rYf4RAwkGb+b3ug4Fl0Di
hskd2bDSEcPUE30mzsEnL70nEZgU+eayP9qYRYR9DsJOajwKACsFAemMRw9Z3iBK
meGrojRTkmhMViEBO0t3Mj4eTX1U7fhcY79iJi5BI39kbO+1qrSHEk/WgjTv4EMo
BFav
=Bv4S
-----END PGP MESSAGE-----
*** btrfs-progs
:PROPERTIES:
:ID:       ca039703-1aea-4deb-b397-9156376a5c7d
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-fs/btrfs-progs
#+end_src

*** restic backup
:PROPERTIES:
:ID:       aa43745e-4d5a-4500-bf22-fa6db3733519
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-backup/restic
#+end_src

** GUI
*** X window system
**** =Wmctrl=
:PROPERTIES:
:ID:       fd2bc4f6-1e80-4c2b-bde0-09896a65f351
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-misc/wmctrl
#+end_src

**** Xdotool
:PROPERTIES:
:ID:       178a01b9-7a71-445c-8863-6f57d5908ed5
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-misc/xdotool
#+end_src

**** Xprop
:PROPERTIES:
:ID:       6916bb34-cb1f-47fc-bdfb-04cbec940f52
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-apps/xprop
#+end_src

**** Xtrlock
:PROPERTIES:
:ID:       03f33817-8d26-47be-a0ff-2f7d1b7d1a77
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-misc/xtrlock
#+end_src

**** setxkbmap
:PROPERTIES:
:ID:       665fed18-4fb9-4787-9aa2-819c05614f03
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-apps/setxkbmap
#+end_src

**** notification-daemon

**** Liberation fonts
:PROPERTIES:
:ID:       664622ad-1ee5-4b2f-ac67-7bfb4e625d96
:END:
These are needed for high-resolution fonts in most apps.

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-fonts/liberation-fonts
#+end_src

*** X window defaults for all the apps
:PROPERTIES:
:ID:       c4a747d8-e2ca-4f8f-b725-6111958b008b
:END:

Defaults same as in bash
#+begin_src conf :tangle /home/yantar92/.xinitrc
source .profile
#+end_src

*** Xorg

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-base/xorg-server
#+end_src

*** Display manager: LightDM
:PROPERTIES:
:ID:       5af43d68-7955-45c5-a396-8888f4d98197
:END:

Setup is trivial
https://wiki.gentoo.org/wiki/LightDM

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-misc/lightdm
gui-libs/display-manager-init
#+end_src

#+begin_src bash :dir / :eval yes
rc-update add dbus default
rc-update add display-manager default
#+end_src

#+begin_src conf :tangle /sudo::/etc/conf.d/display-manager
  # We always try and start the DM on a static VT. The various DMs normally
  # default to using VT7. If you wish to use the display-manager init
  # script, then you should ensure that the VT checked is the same VT your
  # DM wants to use.
  # We do this check to ensure that you haven't accidentally configured
  # something to run on the VT in your /etc/inittab file so that
  # you don't get a dead keyboard.
  CHECKVT=7

  # What display manager do you use ?
  #     [ xdm | greetd | gdm | sddm | gpe | lightdm | entrance ]
  # NOTE: If this is set in /etc/rc.conf, that setting will override this one.
  DISPLAYMANAGER="lightdm"
#+end_src

*** Window manager: Awesome WM
:PROPERTIES:
:CATEGORY: AwesomeConf
:END:
**** Installation
:PROPERTIES:
:ID:       5fa7c055-68fe-4ffa-a843-19a08dbafb06
:END:

https://wiki.gentoo.org/wiki/Awesome

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-wm/awesome
#+end_src

Also need to use X flag for dbus. Otherwise, cannot connect to awesome-client.
#+begin_src conf :tangle /sudo::/etc/portage/package.use/awesome
x11-wm/awesome dbus doc
sys-apps/dbus X
#+end_src
 
**** Configuration
:PROPERTIES:
:header-args:lua: :tangle /home/yantar92/.config/awesome/rc.lua :mkdirp yes :comments link
:END:
****************** TODO this should be reviewed and compared with modern API and example config
****************** END

***** Includes 
:PROPERTIES:
:ID:       bfccc431-afe0-4714-a7b7-199e9754926a
:END:

Vicious module:
https://github.com/vicious-widgets/vicious.git
****************** TODO write ebuild and install properly (and delete local folder)
****************** END
****************** TODO it also requires iwconfig command ([[id:1f3dda9d-68c9-408b-bae0-7cdec63a0882][wireless-tools]]) for wifi widget
****************** END


#+BEGIN_SRC lua
  -- Standard awesome library
  gears = require("gears")
  awful = require("awful")
  require("awful.autofocus")
  -- Widget and layout library
  wibox = require("wibox")
  -- Theme handling library
  beautiful = require("beautiful")
  -- Notification library
  naughty = require("naughty")
  menubar = require("menubar")
  vicious = require("vicious")
#+END_SRC

***** Error handling
:PROPERTIES:
:ID:       ebbc595a-d2b0-44c8-ac65-286791d3dbfb
:END:

#+BEGIN_SRC lua
-- Check if awesome encountered an error during startup and fell back to
-- another config (This code will only ever execute for the fallback config)
if awesome.startup_errors then
   naughty.notify({ preset = naughty.config.presets.critical,
		    title = "Oops, there were errors during startup!",
		    text = awesome.startup_errors })
end

-- Handle runtime errors after startup
do
   local in_error = false
   awesome.connect_signal("debug::error", function (err)
			     -- Make sure we don't go into an endless error loop
			     if in_error then return end
			     in_error = true

			     naughty.notify({ preset = naughty.config.presets.critical,
					      title = "Oops, an error happened!",
					      text = tostring(err) })
			     in_error = false
					  end)
end
#+END_SRC

***** Theme
:PROPERTIES:
:ID:       e52ad2cc-5b08-417d-917f-bd7e3407f813
:END:
****************** TODO create git repo for the theme and unify it
****************** END
****************** TODO copy wallpaper to the theme itself
****************** END

#+BEGIN_SRC lua
-- Themes define colours, icons, font and wallpapers.
home_dir = "/home/yantar92/"
beautiful.init(home_dir .. ".config/awesome/themes/powerarrowf/theme.lua")

-- {{ These are the power arrow dividers/separators }} --
arr1 = wibox.widget.imagebox()
arr1:set_image(beautiful.arr1)
#+END_SRC

***** Widgets
:PROPERTIES:
:ID:       2871b14c-431e-4634-a9b5-42505a36cac0
:END:

****** Time and date 
:PROPERTIES:
:ID:       aee5a678-292f-40b6-b0f9-ebe99f312237
:END:

#+BEGIN_SRC lua
--{{-- Time and Date Widget }} --
tdwidget = wibox.widget.textbox()
--local strf = '<span font="' .. beautiful.font .. '" color="#EEEEEE" background="#777E76">%a %b %d %H:%M</span>'
local strf = '<span font="' .. beautiful.font .. '"> %a %b %d %H:%M </span>'
vicious.register(tdwidget, vicious.widgets.date, strf, 20)
clockicon = wibox.widget.imagebox()
clockicon:set_image(beautiful.clock)
#+END_SRC

****** Battery
:PROPERTIES:
:ID:       8decec17-f443-4396-bf2b-484563522515
:END:

The widget show battery charge and status (charging / discharging).
Also, it notifies the user if the battery level drops too low and automatically hibernates the system in such a case.
The hibernation requires superuser access and is allowed in [[id:ba3805aa-10c2-4636-a953-b08441fdec0d][sudo configuration]]:

#+PROPERTY: sudo-commands-list+ /usr/sbin/loginctl

#+BEGIN_SRC bash :tangle /home/yantar92/.local/bin/battery_status.sh :mkdirp yes :shebang #!/bin/bash
STATUS="$(cat /sys/class/power_supply/BAT0/uevent | grep POWER_SUPPLY_POWER_NOW | cut -d= -f2)"
STATUS2="$(cat /sys/class/power_supply/BAT0/uevent | grep POWER_SUPPLY_POWER_STATUS | cut -d= -f2)"
if [[ "$STATUS2" == "Charging" ]]; then
    echo 0;
else
    [[ "$STATUS" == "0" ]] && echo 0 || echo 1
fi

#+END_SRC

#+BEGIN_SRC lua
  baticon = wibox.widget.imagebox()
  vicious.register(baticon, vicious.widgets.bat, function(widget, args)
		      stdout=assert(io.popen("battery_status.sh", 'r'))
		      local file_adapter = stdout:read('*all')
		      stdout:close()
		      if tonumber(file_adapter)==1 then
			 baticon:set_image(beautiful.baticon)
		      else
			 baticon:set_image(beautiful.chargeicon)
		      end
						 end, 5, "BAT0")

  batwidget = wibox.widget.textbox()
  vicious.register(batwidget, vicious.widgets.bat, function(widget, args)
		      textcolor=beautiful.fg_normal
		      stdout=assert(io.popen("battery_status.sh", 'r'))
		      local file_adapter = stdout:read('*all')
		      stdout:close()
		      if args[2] < 10 then
			 textcolor="#FF0000"
		      end
		      if args[2]<5 and tonumber(file_adapter)==1 then
			 naughty.notify({ preset = naughty.config.presets.critical,
					  title = "Low battery level! "..args[2]..'%',
					  text = '--------------------------------------------------' })
		      end
		      if args[2]<4 and tonumber(file_adapter)==1 then
			 awful.util.spawn("sudo loginctl hibernate")
		      end
		      return '<span font="'.. beautiful.font ..'"><span font="'.. beautiful.font ..'" color="'..textcolor..'">'..args[2]..'%</span></span>  ' end, 30, "BAT0" )
#+END_SRC

****** Net  ssid widget 
:PROPERTIES:
:ID:       08e4c076-cfa5-4d10-8941-2f0d338192be
:END:

We need to find the WiFi interface name:
#+name: wifi-name
#+begin_src bash :eval yes
iwconfig 2>&1 | grep -oE "wlp[^ ]+"
#+end_src

#+begin_src lua :noweb tangle
netwidget = wibox.widget.textbox()
vicious.register(netwidget, vicious.widgets.wifi, function(widget, args)
		    cur_ssid=args["{ssid}"];
		    if cur_ssid:len() > 15 then
		       cur_ssid=cur_ssid:sub(1,12).."..."
		    end
		    if cur_ssid=="N/A" then
		       cur_ssid='<span font="'.. beautiful.font ..'" color="#FF0000">N/A</span>'
		    end
		    return '<span font="'.. beautiful.font ..'"><span font ="'.. beautiful.font ..'">'..cur_ssid..' </span></span>' end, 10, "<<wifi-name()>>")
#+end_src

****** Wifi widget
:PROPERTIES:
:ID:       bc50f99d-38f4-455b-a8a3-a2c751ddbd1f
:END:

#+BEGIN_SRC lua :noweb tangle
neticon = wibox.widget.imagebox()
vicious.register(neticon, vicious.widgets.wifi, function(widget, args)
		    local sigstrength = tonumber(args["{linp}"])
		    if sigstrength > 69 then
		       neticon:set_image(beautiful.nethigh)
		    elseif sigstrength > 40 and sigstrength < 70 then
		       neticon:set_image(beautiful.netmedium)
		    elseif sigstrength > 0 then
		       neticon:set_image(beautiful.netlow)
		    else
		       neticon:set_image(beautiful.netno)
		    end
						end, 10, '<<wifi-name()>>')
#+END_SRC

****** Volume 
:PROPERTIES:
:ID:       eec38fc7-d960-4212-b039-06705e4d0d99
:END:

This requires amixer ([[id:0b604546-7e99-462d-8d49-24e1ec843547][alsa-utils]])
****************** TODO should be dependency for vicious
****************** END

#+BEGIN_SRC lua
volume = wibox.widget.textbox()
vicious.register(volume, vicious.widgets.volume,
		 '<span font="'.. beautiful.font ..'"><span font="'.. beautiful.font ..'">$1% </span></span>', 1, "Master")
volumeicon = wibox.widget.imagebox()
vicious.register(volumeicon, vicious.widgets.volume, function(widget, args)
		    local paraone = tonumber(args[1])
		    if args[2] == "" or paraone == 0 then
		       volumeicon:set_image(beautiful.mute)
		    elseif paraone >= 67 and paraone <= 100 then
		       volumeicon:set_image(beautiful.volhi)
		    elseif paraone >= 33 and paraone <= 66 then
		       volumeicon:set_image(beautiful.volmed)
		    else
		       volumeicon:set_image(beautiful.vollow)
		    end
						     end, 1, "Master")
#+END_SRC

****** CPU
:PROPERTIES:
:ID:       1bdb7523-15e8-4847-8be1-b72fcec13301
:END:

#+BEGIN_SRC lua
cpuwidget = wibox.widget.textbox()
vicious.register(cpuwidget, vicious.widgets.cpu,
		 function(widget, args)
		    text="";
		    if args[1] < 10 then
		       text=args[1].."%   "
		    elseif args[1] < 100 then
		       text=args[1].."% "
		    else
		       text=args[1].."%"
		    end
		    return '<span font="'.. beautiful.font ..'"><span font="'.. beautiful.font ..'">'..text..' </span></span>'
		 end, 1)
cpuicon = wibox.widget.imagebox()
cpuicon:set_image(beautiful.cpuicon)
#+END_SRC

****** Memory
:PROPERTIES:
:ID:       2d106e6f-7b17-4b33-b6bf-d623c7da7ded
:END:

#+BEGIN_SRC lua
memwidget = wibox.widget.textbox()
vicious.register(memwidget, vicious.widgets.mem, '<span font="'.. beautiful.font ..'"><span font="'.. beautiful.font ..'">$1% </span></span>', 1)
memicon = wibox.widget.imagebox()
memicon:set_image(beautiful.mem)
#+END_SRC

****** VPN status :crypt:
:PROPERTIES:
:ID:       0e4353ec-6f0a-40b2-b140-0840d28e557b
:END:

-----BEGIN PGP MESSAGE-----

hQEMA3SKBiQ2zhL6AQgAq2DuhMJquAK+9JkJQveANaF0ToFxB55NIrEjaXRZ9oVV
qjjdItCWKxLLmiR44Nvf4Djv2hJ9scP2irosFKUMrRC1PCEOlsF/9s7VdRkH4rFq
+40w/1K6wHlcWHM9NRjOfph/46nVnStxk6Y6UTgwwFAg9z3LVv5NBsTXAIKhq29X
B3rKfZ1qZ+4BtLiFiFxTKLSEgSmyK5BEbbFqF4FOoi+FlVmUH105rGPtC4Yb2Vp2
hl8ZXRJyn/vRwdCOrW+p79BzsPl2tBASCMxjgne0l+/HEaTMn+D3zesn9HH5sK60
hq+XSL+rWPkbE/tMMntrff7FmxWoRfiCzJlsWsPpYdLBKwHAdZXmJ0Q6li/6j32H
OrLxEqSxSVcqU9Og5A0rjc1va+mFN1R+9u508f18B1CdV90RCavxn+hyM0c6/YNF
aX35hEEZOEoJ8ycgHEj0apQ3T12/REAQfAfhcS9N08yijZqTKnLRyP6d5MARi25U
5BiHcEtx0OROmOTHAs/N+UqO8GiZYcbKg+9ZIrM/g+zeMV+MI5KAsVRguV9qY2Db
9ERrIHOoBy56YzzC5N1UqUYBLnPRCpBND+Ci0kmK3V9WN3yDc5KKMZlizPb317wX
h8IcvaoY2tQhy3Hkwo5xUb92sucqfEan5zI44PHW+qVXyxclJ5slRlJfzWJ6FUM5
nYhvDojNtUzW1CmlY31Y0HxU/D/Ac0lzD2kmRE4fckMZW3+FirIyzdTfwuNtcI2f
HutshwnBvOpkXz003A3l+yJrygS7td0eQOgDj1/sHx3BFxyUXlbSzgYEi9WCdLwB
u6Kh+qckVI5PK0hHfC4AEtDPwgGUNyIkg62O+MjSs1JYD9aZVpVDG0uwcdsu7LlS
0FzEmxa9Ynl88gmjY5bFOjZBq1aog5vivw21h/xadP+x5D/aI/rBWg7tdPHawkkO
dHYC9m6NBkgEBYNfYkztdvXYJr+47cbPQpGk7F+mTrNK0NSh+HYPYapFItiX
=6HTV
-----END PGP MESSAGE-----
****** Externally controlled widgets
:PROPERTIES:
:ID:       a086f86e-5436-4aeb-9bb2-b1d5cf0364a8
:END:

#+BEGIN_SRC lua
--{{--|Org status message |----------------
orgstatus = wibox.widget.textbox()
orgstatus:set_text("...")

--{{--|Current balance of important money/time |----------------
balance = wibox.widget.textbox()
balance:set_text("N/A")

--spacing
spacing = wibox.widget.textbox()
spacing:set_text(" ")
#+END_SRC

****** System tray
:PROPERTIES:
:ID:       3f341583-9a23-4d22-a512-f6e40fc52b39
:END:

I use vertical system tray.

#+BEGIN_SRC lua
-- systray
mysystray = wibox.widget.systray()
mysystray:set_horizontal(false)
#+END_SRC

****** Diagonal icon spacer
:PROPERTIES:
:ID:       0cd32409-d172-4366-bfb8-348175369575
:END:

#+BEGIN_SRC lua
diagicon = wibox.widget.imagebox()
diagicon:set_image(beautiful.diag)
#+END_SRC

***** Default apps
:PROPERTIES:
:ID:       2ff678c0-ae44-4b8f-b442-f0adb5cb3d69
:END:

#+BEGIN_SRC lua
terminal = "kitty"
editor = os.getenv("EDITOR") or "nano"
editor_cmd = "emacsclient -c -n -e '(switch-to-buffer nil)'"
#+END_SRC

***** Modkey
:PROPERTIES:
:ID:       675b84ce-b132-4190-8491-857392b90450
:END:

#+BEGIN_SRC lua
-- Default modkey.
-- Usually, Mod4 is the key with a logo between Control and Alt.
-- If you do not like this or do not have such a key,
-- I suggest you to remap Mod4 to another key using xmodmap or other tools.
-- However, you can use another modifier like Mod1, but it may interact with others.
modkey = "Mod4"
#+END_SRC

***** Tiling layouts
:PROPERTIES:
:ID:       b13627b6-8982-408d-b3a2-2b549561a4e9
:END:

#+BEGIN_SRC lua
-- Table of layouts to cover with awful.layout.inc, order matters.
awful.layout.layouts = {
   awful.layout.suit.tile.bottom,
   awful.layout.suit.tile,
   awful.layout.suit.tile.left,
   awful.layout.suit.tile.top,
   --    awful.layout.suit.spiral,
   awful.layout.suit.spiral.dwindle,
   awful.layout.suit.fair,
   awful.layout.suit.fair.horizontal,
   --    awful.layout.suit.max,
   --    awful.layout.suit.max.fullscreen,
   -- awful.layout.suit.magnifier,
   -- awful.layout.suit.corner.nw,
   -- awful.layout.suit.corner.ne,
   -- awful.layout.suit.corner.sw,
   -- awful.layout.suit.corner.se,
   awful.layout.suit.floating,
}
#+END_SRC

***** Menubar config
:PROPERTIES:
:ID:       02d0c1f4-a60d-4ce4-921a-601a68145563
:END:

#+BEGIN_SRC lua
menubar.utils.terminal = terminal -- Set the terminal for applications that require it
#+END_SRC

***** Conky integration
:PROPERTIES:
:ID:       35944e3b-9790-4617-b294-7034e6f69d79
:END:

#+BEGIN_SRC lua
function get_conky()
   local clients = client.get()
   local conky = { }
   local j = 1
   local i = 1
   while clients[i]
   do
      if clients[i].class == "conky"
      then
	 conky[j] = clients[i]
	 j = j + 1
      end
      i = i + 1
   end
   return conky
end
function raise_conky()
   local conky = get_conky()
   local i = 1
   while conky[i]
   do
      conky[i].ontop = true
      i = i + 1
   end
end
function lower_conky()
   local conky = get_conky()
   local i = 1
   while conky[i]
   do
      conky[i].ontop = false
      i = i + 1
   end
end
#+END_SRC

***** Wallpaper
:PROPERTIES:
:ID:       a697d982-c539-434f-84c3-53711cf43432
:END:

#+BEGIN_SRC lua
local function set_wallpaper(s)
   -- Wallpaper
   if beautiful.wallpaper then
      local wallpaper = beautiful.wallpaper
      -- If wallpaper is a function, call it with the screen
      if type(wallpaper) == "function" then
	 wallpaper = wallpaper(s)
      end
      gears.wallpaper.maximized(wallpaper, s, true)
   end
end

  -- Re-set wallpaper when a screen's geometry changes (e.g. different resolution)
  screen.connect_signal("property::geometry", set_wallpaper)
#+END_SRC

***** Per-window keyboard layout
:PROPERTIES:
:ID:       7c9f07cd-960e-4046-9fff-93435e4ed54e
:END:

#+begin_src lua
require("kbdlayout")
#+end_src

Credit: https://gist.github.com/necauqua/4faa6a2cba66435e23fa98578862a0c8
#+begin_src lua :tangle /home/yantar92/.config/awesome/kbdlayout.lua
local layout = require 'awful.widget.keyboardlayout'
local menubar = require 'menubar'

local kbdlayout = {
    globally_preferred = 'us',
    menubar_preferred = 'us',
}

local function get_idx_by_name(name)
    if not name then
        return 
    end
    for i, v in ipairs(layout.get_groups_from_group_names(awesome.xkb_get_group_names())) do
        if v.file == name then
            return i - 1
        end
    end
end

require 'awful.client' .property.persist('last_layout', 'number')

local oneshot_lock = false

local function on_layout_change()
    -- so that it does not override the last_layout
    -- when we set it, e.g. from menubar.show
    if oneshot_lock then
        oneshot_lock = false
        return
    end
    local c = client.focus
    if c then
        local idx = awesome.xkb_get_layout_group()
        c.last_layout = idx
    end
end

local function on_focus_changed(c)
    local idx = c.last_layout or get_idx_by_name(c.preferred_layout or kbdlayout.globally_preferred)
    if idx and awesome.xkb_get_layout_group() ~= idx then
        awesome.xkb_set_layout_group(idx)
    end
end

awesome.connect_signal('xkb::map_changed', on_layout_change)
awesome.connect_signal('xkb::group_changed', on_layout_change)
client.connect_signal('focus', on_focus_changed)

-- menubar has no signals or anything, so just plain old monkeypatching

local menubar_show = menubar.show
local menubar_hide = menubar.hide

function menubar.show(...)
    menubar_show(...)
    local idx = get_idx_by_name(kbdlayout.menubar_preferred)
    if idx then
        oneshot_lock = true
        awesome.xkb_set_layout_group(idx)
    end
end

function menubar.hide(...)
    menubar_hide(...)
    local c = client.focus
    if c then
        on_focus_changed(c)
    end
end

return kbdlayout
#+end_src

***** Screen layouts
:PROPERTIES:
:ID:       64eab01e-d3ac-4b50-80b4-571a59484ca5
:END:

#+BEGIN_SRC lua
  awful.screen.connect_for_each_screen(
     function(s)
	-- Wallpaper
	set_wallpaper(s)

	-- Each screen has its own tag table.
	-- if s.index == 1 then
	awful.tag({ "emacs", "web", "tile", "float", "steam" }, s, { awful.layout.suit.tile.bottom, awful.layout.suit.tile.left, awful.layout.suit.spiral.dwindle, awful.layout.suit.floating, awful.layout.suit.floating })
	root.tags()[1].master_width_factor = 0.65
	root.tags()[1].useless_gap = 0
	-- else
	--    awful.tag({"present","data"}, s, awful.layout.layouts[1])
	-- end

	-- Create an imagebox widget which will contains an icon indicating which layout we're using.
	-- We need one layoutbox per screen.
	s.mylayoutbox = awful.widget.layoutbox(s)
	-- Create a taglist widget
	s.mytaglist = awful.widget.taglist(s, awful.widget.taglist.filter.all, taglist_buttons)

	-- Create a tasklist widget

	s.mytasklist_nofocus = awful.widget.tasklist(s, function (c,screen) return awful.widget.tasklist.filter.currenttags (c, screen) end, nil, nil, nil, wibox.layout.flex.horizontal())

	-- Create the wibox
	s.mywibox = awful.wibar({ position = "top", screen = s })
	s.mywibox_status = awful.wibar({ position = "bottom", screen = s })
	s.mywibox_right = awful.wibar({ position = "right", screen = s })

	-- Add widgets to the wibox
	s.mywibox:setup {
	   layout = wibox.layout.align.horizontal,
	   s.mylayoutbox,
	   s.mytasklist_nofocus,
	   { -- Right widgets
	      layout = wibox.layout.fixed.horizontal,
	      s.index == 1 and spacing,
	      s.index == 1 and balance,
	      arr1,
	      spacing
	   },
	}
	s.mywibox_right:setup {
	   layout = wibox.layout.align.vertical,
	   {
	      layout = wibox.layout.fixed.vertical,
	      s.index == 1 and spacing,
	      s.index == 1 and mysystray,
	   },
	   {
	      layout = wibox.layout.fixed.vertical,
	   },
	   {
	      s.mytaglist,
	      direction = 'west',
	      layout = wibox.container.rotate,
	   },
	}
	s.mywibox_status:setup {
	   layout = wibox.layout.align.horizontal,
	   expand = "none",
	   s.index == 1 and orgstatus,
	   {
	      layout =  wibox.layout.fixed.horizontal,
	      forced_width = 1,
	      spacing,
	   },
	   {
	      layout =  wibox.layout.fixed.horizontal,
	      cpuicon,
	      cpuwidget,
	      memicon,
	      memwidget,
	      volumeicon,
	      volume,
	      baticon,
	      batwidget,
	      neticon,
	      netwidget,
	      clockicon,
	      tdwidget,
	      -- vpnicon,
	      diagicon,
	   },
	}
  end)
  -- }}}

#+END_SRC

***** Key bindings
:PROPERTIES:
:ID:       23de5ad2-4320-4f72-91f0-ca909e3abbab
:END:
#+BEGIN_SRC lua  
  function initflagmove ()
     keynumber = 0
     -- Bind all key numbers to tags.
     -- Be careful: we use keycodes to make it works on any keyboard layout.
     -- This should map on the top row of your keyboard, usually 1 to 9.
     tagkeys={"x","z","s","d","f"}
     for s in screen do
	keynumber = math.min(9, math.max(#s.tags, keynumber));
     end

     for i = 1, keynumber do
	globalkeys = awful.util.table.join(globalkeys,
					   -- View tag only.
					   awful.key({ modkey, "Control" }, tagkeys[i],
					      function ()
							local screen = awful.screen.focused()
							local tag = screen.tags[i]
							if tag then
							   tag:view_only()
							end
						     end,
						     {description = "view tag #"..i, group = "tag"}),
					   -- Move client to tag.
					   awful.key({ modkey, "Shift" }, tagkeys[i],
					      function ()
							if client.focus then
							   local tag = client.focus.screen.tags[i]
							   if tag then
							      client.focus:move_to_tag(tag)
							   end
							end
						     end,
						     {description = "move focused client to tag #"..i, group = "tag"})
					   -- -- Toggle tag on focused client.
					   -- awful.key({ modkey, "Alt_L", "Shift" }, tagkeys[i],
					   -- 	   function ()
					   -- 	      if client.focus then
					   -- 		 local tag = client.focus.screen.tags[i]
					   -- 		 if tag then
					   -- 		    client.focus:toggle_tag(tag)
					   -- 		 end
					   -- 	      end
					   -- 	   end,
					   -- 	   {description = "toggle focused client on tag #" .. i, group = "tag"})
	)
     end
  end

  globalkeys = awful.util.table.join(
     awful.key({ modkey}, "j",
	function ()
		  awful.client.focus.byidx( 1)
		  if client.focus then client.focus:raise() end
	       end),
     awful.key({ modkey }, "k",
	function ()
		  awful.client.focus.byidx(-1)
		  if client.focus then client.focus:raise() end
	       end),
     awful.key({ modkey}, "w", function () awful.spawn("bash -c 'nice -n 17 show-menu'") end),
     -- Layout manipulation
     awful.key({ modkey, "Shift" }, "j", function () awful.client.swap.byidx( 1) awful.client.focus.byidx(-1) end),
     awful.key({ modkey, "Shift" }, "k", function () awful.client.swap.byidx(-1) awful.client.focus.byidx( 1) end),
     awful.key({ modkey,           }, "Tab",
	function (t)
		  awful.tag.history.restore(awful.tag.getscreen(t))
	       end),
     awful.key({ modkey,          }, "q",
	function (t)
		  awful.client.focus.history.previous()
		  if client.focus then
		     client.focus:raise()
		  end
	       end),
     -- Standard program
     awful.key({ modkey         }, "Return", function() awful.spawn("bash -c \"trackball-toggle.sh enable && xtrlock && trackball-toggle.sh disable\"") end),
     awful.key({ modkey},"r", function() awful.spawn("bash -c 'PATH=\"/home/yantar92/.local/bin:$PATH\" nice -n 17 emacs-helm-menu'") end),
     awful.key({ modkey},"y", function() awful.spawn("bash -c 'passmenu --type'") end),
     awful.key({ modkey},"u", function() awful.spawn("bash -c 'passmenu --type --user'") end),
     awful.key({ modkey}, "t", function () awful.spawn("bash -c 'run_single_window.sh \"Kitty\" \"kitty\"'") end),
     awful.key({ modkey}, "=", function () awful.spawn("show-dictionary.sh") end),
     awful.key({ modkey}, "-", function () awful.spawn("show-translation.sh") end),
     awful.key({ modkey, "Control" }, "c", function () awful.spawn("mingus-start.sh") end),
     awful.key({ modkey, "Control", "Shift" }, "c", function () awful.spawn("mingus-del-current.sh") end),
     -- awful.key({ modkey, "Control" }, "w", function () awful.spawn("elfeed-start.sh") end),
     -- awful.key({ modkey, "Control" }, "g", function () awful.spawn("notmuch-emacs-start.sh --inbox") end),
     -- awful.key({ modkey, "Control", "Shift" }, "g", function () awful.spawn("notmuch-emacs-start.sh --newsonly") end),
     awful.key({ modkey }, "e", function () awful.spawn("emacs-start.sh") end),
     awful.key({ modkey }, "i", function () awful.spawn("qutebrowser-start.sh") end),
     awful.key({ modkey }, "v", function () awful.spawn("clipmenu.sh") end),
     -- awful.key({ modkey, "Control" }, "u", function () awful.spawn("urxvt -e rtorrent-start.sh") end),
     -- awful.key({ modkey, "Control" }, "b", function () awful.spawn("urxvt -e start_bc") end),
     awful.key({ modkey, "Shift" }, "p", function () awful.spawn("mpd-toggle.sh") end),
     -- awful.key({ modkey, "Shift" }, "=", function () awful.spawn("mpc -q volume +5") end),
     -- awful.key({ modkey, "Shift" }, "-", function () awful.spawn("mpc -q volume -5") end),
     awful.key({ modkey, "Shift" }, ".", function () awful.spawn("mpd-next.sh") end),
     awful.key({ modkey, "Shift" }, ",", function () awful.spawn("mpd-prev.sh") end),
     awful.key({ }, "XF86AudioNext", function () awful.spawn("mpd-next.sh") end),
     awful.key({ }, "XF86AudioPrev", function () awful.spawn("mpd-prev.sh") end),
     awful.key({ }, "XF86AudioPlay", function () awful.spawn("mpd-toggle.sh") end),
     -- awful.key({ }, "XF86Tools", function () awful.spawn("vpn-select-server.sh") end),
     -- awful.key({ }, "F9", function () awful.spawn("vpn-toggle.sh") end),
     -- awful.key({ modkey, "Control" }, "q", function () awful.spawn("equalizer-start.sh") end),
     awful.key({modkey, "Control", "Shift" }, "o",     function () awful.screen.focus_relative(1) end),
     --   awful.key({ "Control" }, "1", function () awful.spawn("seltr") end),
     awful.key({ }, "XF86AudioMute", function () awful.spawn("mute.sh", false) end),
     awful.key({ }, "XF86AudioLowerVolume", function () awful.spawn("dec_volume.sh", false) end),
     awful.key({ }, "XF86AudioRaiseVolume", function () awful.spawn("inc_volume.sh", false) end),
     awful.key({ }, "XF86Favorites", function () awful.spawn("trackball-toggle.sh") end),
     -- awful.key({ }, "Print", function () awful.spawn("sh -c '(cd ~/ && import -window root screenshot.jpg && mv screenshot.jpg screenshot.`date +%d.%m.%Y-%H.%M.%S`.jpg)'") end),
     awful.key({ }, "Print", function () awful.spawn("sh -c 'flameshot gui'") end),
     awful.key({ modkey, "Shift" }, "i", function () awful.spawn("org-clock-in-organization.sh", false) end),
     awful.key({ modkey, "Shift" }, "5", function () awful.spawn("org-clock-in-bookmarks.sh", false) end),
     awful.key({ modkey, "Shift" }, "6", function () awful.spawn("org-clock-out.sh", false) end),
     awful.key({ modkey }, "c", function () awful.spawn("bash -c 'emacsclient -e \"(org-capture)\"'", false) end),
     -- Tilewidth manupulation
     awful.key({ modkey, "Shift"}, "l",     function () awful.tag.incmwfact( 0.05)    end),
     awful.key({ modkey, "Shift"}, "h",     function () awful.tag.incmwfact(-0.05)    end),
     awful.key({ modkey, "Control", "Shift" }, "h",     function () awful.tag.incncol( 1)         end),
     awful.key({ modkey, "Control", "Shift" }, "l",     function () awful.tag.incncol(-1)         end),
     awful.key({ modkey,           }, "space", function () awful.layout.inc(awful.layout.layouts,  1) end),
     awful.key({ modkey, "Shift"   }, "space", function () awful.layout.inc(awful.layout.layouts, -1) end),
     awful.key({ modkey}, "BackSpace", function ()
		  for s in pairs(naughty.notifications) do
		     for p in pairs(naughty.notifications[s]) do
			for i,notification in pairs(naughty.notifications[s][p]) do
			   if notification then
			      naughty.destroy(notification)
			      return notification
			   end
			end
		     end
		  end
				       end),
     awful.key({ modkey, "Control", "Shift" }, "n", function()
		  c=awful.client.restore()
		  if c==nil then return end
		  client.focus=c
		  if client.focus then
		     client.focus:raise()
		  end
						    end),
     -- Prompt
     awful.key({}, "F11", function() raise_conky() end, function() lower_conky() end)
     -- awful.key({ modkey, "Shift", "Control" }, "n",
     -- 	     function()
     -- 		local tag = awful.tag.selected()
     -- 		for i=1, #tag:clients() do
     -- 		   tag:clients()[i].minimized=false
     -- 		end
     -- 	     end),
     -- awful.key({ modkey, "Shift"       }, "n",
     -- 	       function()
     -- 		  -- client_list={}
     -- 		  -- local tag = awful.tag.selected()
     -- 		  -- for i=1, #tag:clients() do
     -- 		  --    cl=tag:clients()[i]
     -- 		  --    if tag:clients()[i].minimized then
     -- 		  --       prefix = "_ "
     -- 		  --    else
     -- 		  --       prefix = "* "
     -- 		  --    end
     -- 		  --    if not awful.rules.match(cl, {class= "conky"}) then
     -- 		  --       client_list[i]=
     -- 		  -- 	 {prefix .. cl.name.."</span>",
     -- 		  -- 	  function()
     -- 		  -- 	     cl_menu:hide()
     -- 		  -- 	     tag:clients()[i].minimized=not tag:clients()[i].minimized
     -- 		  -- 	  end,
     -- 		  -- 	  cl.icon
     -- 		  -- 	 }
     -- 		  --    end
     -- 		  -- end
     -- 		  -- cl_menu=awful.menu({items = client_list, theme = {width=300}})
     -- 		  -- mouse.coords({x=533,y=354})
     -- 		  -- cl_menu:show({keygrabber = true})
     -- 		  awful.spawn("windowcd.sh")
     -- 	       end
     -- )
  )

  clientkeys = awful.util.table.join(
     awful.key({ modkey, "Control"   }, "m",      function (c) c.fullscreen = not c.fullscreen  end),
     awful.key({ modkey, "Shift"   }, "'",      function (c) c:kill()                         end),
     awful.key({ modkey, "Shift"   }, "q",      function (c)
		  for _,c2 in pairs(c.screen.clients) do
		     if c2 ~= c then
			c2:kill()
		     end
		  end
						end),
     awful.key({ modkey, "Control" }, "space",  awful.client.floating.toggle                     ),
     awful.key({ modkey, "Shift"   }, "o",      awful.client.movetoscreen                        ),
     awful.key({ modkey, "Control", "Shift" }, "t",      function (c) c.ontop = not c.ontop            end),
     -- awful.key({ modkey,           }, "u", function (c) c.marked = not c.marked end ),
     awful.key({ modkey, "Control"}, "n",
	       function (c)
		  c.minimized = true
	       end),
     awful.key({ modkey }, "m",
	       function (c)
		  c.maximized_horizontal = not c.maximized_horizontal
		  c.maximized_vertical   = not c.maximized_vertical
	       end)
  )


  initflagmove()

  clientbuttons = awful.util.table.join(
     --    awful.button({ }, 1, function (c) client.focus = c; c:raise() end),
     awful.button({ modkey }, 1, function(c) awful.mouse.client.move() end),
     awful.button({ modkey }, 3, function(c) awful.mouse.client.resize() end))

  -- Set keys
  root.keys(globalkeys)
  -- }}}
#+END_SRC
***** Client rules
:PROPERTIES:
:ID:       ba88fac8-f4d0-4888-b078-b66e3341795f
:CATEGORY: AwesomeRules
:END:

#+BEGIN_SRC lua  
  -- Rules to apply to new clients (through the "manage" signal).
  awful.rules.rules = {
	<<awesome-default-client-rule>>,
	<<awesome-default-titlebar-rule>>,
	<<awesome-default-dialog-rule>>,
	<<awesome-default-emacs-rule>>,
	<<awesome-default-pinentry-rule>>,
	<<awesome-default-keyring-rule>>,
	<<awesome-default-kitty-rule>>,
	<<awesome-default-gnuplot-rule>>,
	<<awesome-default-conky-rule>>,
	<<awesome-default-mpv-rule>>,
	<<awesome-default-astrill-rule>>,
	<<awesome-default-cr3-rule>>,
  }
#+END_SRC

****** Default
:PROPERTIES:
:ID:       281f68cd-c10f-43f4-908a-314210a361cb
:END:

#+name: awesome-default-client-rule
#+begin_src lua :tangle no
     -- All clients will match this rule.
     { rule = { },
       properties = { border_width = beautiful.border_width,
		      border_color = beautiful.border_normal,
		      focus = awful.client.focus.filter,
		      raise = true,
		      keys = clientkeys,
		      buttons = clientbuttons,
		      screen = awful.screen.preferred,
		      placement = awful.placement.no_overlap+awful.placement.no_offscreen
       }
     }
#+end_src

****** Clients with titlebar
:PROPERTIES:
:ID:       19299207-9595-40cd-9f8d-b992854be336
:END:

#+name: awesome-default-titlebar-rule
#+begin_src lua :tangle no
     -- Add titlebars to normal clients and dialogs
     { rule_any = { type = { "normal", "dialog" } },
       properties = { titlebars_enabled = true }
     }
#+end_src

****** Dialogues
:PROPERTIES:
:ID:       5585ab78-2bff-4036-b64b-79ddf96116db
:END:

#+name: awesome-default-dialog-rule
#+begin_src lua :tangle no
     { rule = { type = "dialog" },
       properties = {
	  floating = true
       }
     }
#+end_src
****** Emacs
:PROPERTIES:
:ID:       7b419cc6-d53b-40d3-b140-b77d2cacd77e
:END:

#+name: awesome-default-emacs-rule
#+begin_src lua :tangle no
     { rule = { class = "Emacs", name = "Helm frame"},
       properties = {
	  floating = true,
          placement = awful.placement.centered,
          skip_taskbar = true,
          ontop = true,
          maximized_horizontal = true,
          height = 800,
	  titlebars_enabled = false,
	  border_width = 1.0,
	  opacity = 0.9,
       },
       callback = function(c)
	  gears.apply_shape_bounding(c, gears.shape.rounded_rect, 15)
       end,
     }
#+end_src

****** Qutebrowser
:PROPERTIES:
:ID:       4c23ea4d-ef24-4e42-a17b-edc3000fc34a
:END:

#+name: awesome-default-qutebrowser-rule
#+begin_src lua :tangle no
     { rule = { class = "qutebrowser" },
       properties = {
	  tag = "web",
       },
     }
#+end_src

****** =Pinentry= prompt
:PROPERTIES:
:ID:       dba1742a-d1f9-4c0b-8f83-c58c9417e6dd
:END:

#+name: awesome-default-pinentry-rule
#+begin_src lua :tangle no
     { rule = { class = "Pinentry" },
       properties = {
	  floating = true,
          placement = awful.placement.centered
       },
     }
#+end_src

****** =Keyring= prompt 
:PROPERTIES:
:ID:       8d9f1025-f2e0-45ff-a562-53bfa1023ff1
:END:

#+name: awesome-default-keyring-rule
#+begin_src lua :tangle no
     { rule = { class = "gcr-prompter" },
       properties = {
	  floating = true,
          placement = awful.placement.centered
       },
     }
#+end_src

****** Kitty 
:PROPERTIES:
:ID:       531979e4-0b66-4b6e-9dce-691bdb29e3a9
:END:

#+name: awesome-default-kitty-rule
#+begin_src lua :tangle no
{ rule = {class = "kitty"},
       properties = {
	  floating = true,
	  skip_taskbar = true,
	  titlebars_enabled = false,
	  width = 1878,
	  height = 500,
	  border_width = 0
       }
     }
#+end_src

****** Gnuplot
:PROPERTIES:
:ID:       c3dd2fa2-16a4-487d-b0f5-af8672d2b5f7
:END:

#+name: awesome-default-gnuplot-rule
#+begin_src lua :tangle no
     { rule = {class = "gnuplot_qt"},
       properties = {
	  floating = true,
	  above = true,
       }
     }
#+end_src

****** Conky 
:PROPERTIES:
:ID:       0f440b7d-1090-4ed8-95f0-f4145ce69067
:END:

#+name: awesome-default-conky-rule
#+begin_src lua :tangle no
     { rule = { class = "conky" },
       properties = {
	  floating = true,
	  sticky = true,
	  ontop = false,
	  focusable = false,
	  border_width = 0,
       }
     }
#+end_src

****** MPV
:PROPERTIES:
:ID:       80b366e2-7385-4ba0-8af9-1d7ba59e5907
:END:

#+name: awesome-default-mpv-rule
#+begin_src lua :tangle no
     { rule = { class = "mpv" },
       properties = {
	  floating = true
       }
     }
#+end_src

****** Astrill
:PROPERTIES:
:ID:       c7d13b82-c2fe-4de2-a561-2babf9f336b4
:END:

#+name: awesome-default-astrill-rule
#+begin_src lua :tangle no
     { rule = { class = "Astrill" },
       properties = {
	  floating = true,
	  placement = awful.placement.top_right
       }
     }
#+end_src

****** Cool reader
:PROPERTIES:
:ID:       42486af2-87e7-4c28-947c-db14568d955f
:END:

#+name: awesome-default-cr3-rule
#+begin_src lua :tangle no
     { rule = { class = "cr3" },
       properties = {
	  fullscreen = true
       }
     }
#+end_src



***** Client signals
:PROPERTIES:
:ID:       d3976060-2ee2-47a1-8f09-93fc7b434fa6
:CATEGORY: AwesomeSig
:END:

#+BEGIN_SRC lua  
  -- {{{ Signals
  -- Signal function to execute when a new client appears.
  client.connect_signal("manage", function (c)
			   -- Set the windows at the slave,
			   -- i.e. put it at the end of others instead of setting it master.
			   -- if not awesome.startup then awful.client.setslave(c) end
			   if awesome.startup and
			      not c.size_hints.user_position
			      and not c.size_hints.program_position
			   then
			      -- Prevent clients from being unreachable after screen count changes.
			      awful.placement.no_offscreen(c)
			   end
				  end)

  -- Add a titlebar if titlebars_enabled is set to true in the rules.
  client.connect_signal("request::titlebars", function(c)
			   -- buttons for the titlebar
			   awful.titlebar(c, {position="bottom"}) : setup {
			      { -- Left
				 awful.titlebar.widget.iconwidget(c),
				 spacing,
				 buttons = buttons,
				 layout  = wibox.layout.fixed.horizontal
			      },
			      { -- Middle
				 { -- Title
				    align  = "left",
				    widget = awful.titlebar.widget.titlewidget(c)
				 },
				 buttons = buttons,
				 layout  = wibox.layout.flex.horizontal
			      },
			      spacing,
			      layout = wibox.layout.align.horizontal
									  }
					      end)

  -- Enable sloppy focus, so that focus follows mouse.
  -- client.connect_signal("mouse::enter", function(c)
  --     if awful.layout.get(c.screen) ~= awful.layout.suit.magnifier
  --         and awful.client.focus.filter(c) then
  --         client.focus = c
  --     end
  -- end)


  client.connect_signal("focus", function(c) c.border_color = beautiful.border_focus; if not c.class == "mpv" then c.above = true; end end)

  client.connect_signal("unfocus", function(c) c.border_color = beautiful.border_normal; c.above=false; end)
  -- }}}
#+END_SRC

***** Autostart \\ startup
:PROPERTIES:
:ID:       ea1344e1-a0d7-426b-93c4-f8dfff8b6177
:END:
#+BEGIN_SRC lua  
awful.spawn.with_shell("[[ -e /tmp/startup.run ]] || (mkdir -p ~/.log; ~/.config/awesome/startup >> ~/.log/awesome.log 2>&1) && touch /tmp/startup.run")
#+END_SRC

***** Helper scripts

****** Make sure that app is going to run in a single window 
:PROPERTIES:
:ID:       d1edf71c-35dd-4ed9-8e2c-0ab33a18435d
:END:

Requires [[id:fd2bc4f6-1e80-4c2b-bde0-09896a65f351][=Wmctrl=]] and [[id:6916bb34-cb1f-47fc-bdfb-04cbec940f52][xprop]]

#+BEGIN_SRC bash :tangle /home/yantar92/.local/bin/run_single_window.sh :shebang #!/bin/bash :mkdirp yes
  function help() {
      cat <<EOF
   This scripts runs a program in a single window.
  If the program is already running, it raise the focus of its window.
  USAGE: start-single-window.sh [--toggle] "program unique id without special chars and spaces" "command to run"
  --toggle: hide the command window if in focus and show it otherwise
EOF
  }

  function wmctrl_getwindowname() {
      echo "$(xprop -id $1 | grep "^WM_NAME(" | cut -d\" -f2)"
  }

  TOGGLE=""
  if [[ "$1" == "--toggle" ]]; then
      TOGGLE="1"
      shift;
  fi

  [[ "$#" -ne "2" ]] && echo "Wrong number of parameters" && help && exit

  NAME="$1"
  WINDOW_CMD="$2"

  INFO_FOLDER="/tmp"

  [[ -e "$INFO_FOLDER/$NAME" ]] && WINDOW_ID=`cat $INFO_FOLDER/$NAME` || WINDOW_ID=""
  if [ -z "$WINDOW_ID" ]
  then
      rm -f $INFO_FOLDER/$NAME
  else
      [[ -z "`wmctrl -l | grep $WINDOW_ID`" ]] && rm $INFO_FOLDER/$NAME
  fi

  if [ -e "$INFO_FOLDER/$NAME" ]
  then
      [[ "$(xdotool search --class "$NAME" | tail -n1)" =~ "$(xdotool getwindowfocus)" ]] && xdotool windowminimize $(xdotool getwindowfocus) || (wmctrl -iR "$WINDOW_ID"; wmctrl -iR "$WINDOW_ID";)
  else
      NUM_WINDOWS="`wmctrl -l | wc -l`"
      $WINDOW_CMD &
      JOB_ID="`jobs -p`"
      [[ -z "`ps ax | grep $JOB_ID`" ]] && echo "Process ID not found... stopping" && exit
      echo " Job id = $JOB_ID"
      FLAG="1"
      while [[ "$FLAG" -eq "1" ]];
      do
	  notify-send -t 450 "Running" "Running $NAME..."
	  while read WINDOW_ID;
	  do
	      echo Testing $WINDOW_ID ... $JOB_ID =? `xprop -id $WINDOW_ID | grep _NET_WM_PID | cut -d\  -f3`
	      if [ "$JOB_ID" -eq "`xprop -id "$WINDOW_ID" | grep _NET_WM_PID | cut -d\  -f3`" ]
	      then
		  echo "$WINDOW_ID" > $INFO_FOLDER/$NAME
		  echo "done... $NAME: window id = $WINDOW_ID"
		  FLAG="0"
		  break
	      fi
	      [[ "$FLAG" -eq "0" ]] && break
	  done <<< "`wmctrl -l | cut -d\  -f1`"
	  perl -e 'select(undef,undef,undef,.5)'
      done
      wmctrl -ir "`cat $INFO_FOLDER/$NAME`"
  fi
#+END_SRC

*** Run/search menu via Emacs helm
:PROPERTIES:
:ID:       d5a5cf1a-7fb7-4e04-8b71-610d20efcb7a
:END:
 #launcher #runner
Inspired by [[id:Mattduckemacs_as_fuzzy_launc_and_alfred_replac6c6][[Mattduck] Emacs as a fuzzy launcher and Alfred-replacement]]
#+begin_src bash :tangle /home/yantar92/.local/bin/emacs-helm-menu :shebang #!/bin/bash
if [[ "$(getactvwindclass)" == "emacs.Emacs" ]]; then
    # Relies on my key bindings
    xdotool key --clearmodifiers --delay 60 alt+l e h;
    # release any pressed modifiers
    xdotool keyup super alt ctrl shift
else
    emacsclient -c --frame-parameters="((title . \"Helm frame\") (unsplittable . t))" -e "(let ((inhibit-message t) (helm-full-frame t) (helm-use-undecorated-frame-option nil)) (catch :quit (yant/helm-org-ql-agenda-files nil) (when (= 0 helm-exit-status) (let ((fr (selected-frame))) (make-frame) (delete-frame fr))) (unless (= 0 helm-exit-status) (user-error \"%s\" \"Exit frame\"))))";
fi
#+end_src

Credit: https://github.com/computefoundation/gnu-linux-shell-scripting/blob/master/scripts/x11_management-output_only/window_property_information/getactvwindclass
(with fixes)
#+begin_src bash :tangle /home/yantar92/.local/bin/getactvwindclass :shebang "#!/usr/bin/env bash"
# 
# File:
#   getactvwindclass
# 
# Description:
#   Get the class of the active window.
# 
# Returns:
#   Full qualified class string (class and classname; e.g. "xterm.XTerm")) of
#   window
# 

getActvWindId() {
  echo "$(xprop -root _NET_ACTIVE_WINDOW | cut -d ' ' -f 5)"
}

getWindClassById() {
  echo "$(xprop -id "${1}" WM_CLASS | sed -n \
      's/[^"]*"\([^"]*\)",\s"\([^"]*\)"/\1.\2/p')"
}

echo "$(getWindClassById "$(getActvWindId)")"
#+end_src
*** Tools

**** Rofi quick menu
:PROPERTIES:
:ID:       9220e236-6887-4b3a-82e3-a83ff1aed4a9
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-misc/rofi
#+end_src

***** Configuration
:PROPERTIES:
:ID:       c0e8eaa9-91c6-4da3-89af-29cfd2271c9f
:END:

#+begin_src conf :tangle /home/yantar92/.config/rofi/config.rasi :mkdirp yes :comments no
configuration {
        separator-style: "solid";
        scrollbar-width: 5;
        terminal: "urxvt";
        width: 35;
        lines: 7;
        padding: 10;
        run-command: "bash -c '{cmd}'";
        window-command: "wmctrl -b toggle,hidden -i -r {window}";
        font: "Adobe Garamond 15";
        kb-row-down: "Down,Control+n,Alt+j";
        kb-row-up: "Up,Control+p,Shift+Tab,Shift+ISO_Left_Tab,Alt+k";
}
@theme "/usr/share/rofi/themes/Arc-Dark.rasi"
#+end_src

***** Menu generator for rofi: menugen

****************** TODO wite ebuild
****************** END

[[file:../Dist/menugen-master/]]

****** Personal menu

******* Main menu 
:PROPERTIES:
:ID:       b317c984-18c6-498a-9107-74097331909c
:END:

#+begin_src conf :tangle /home/yantar92/.local/bin/show-menu :shebang #!/home/yantar92/.local/bin/menugen
#begin setup
PATH="$PATH:/home/yantar92/.local/bin"
ROFI_OPTS="-width 20 -lines 20 -auto-select"
#end setup

#begin main
name="Main menu"
add_item	'Pendrives list >'	'next'		'show-flash.sh'
add_link 'System tools>'            'system'
add_link 'Awesome menu>'            'awesome'
#end main

#begin system
name="System"
add_exec	'Audio Control'	'pavucontrol-qt'
add_exec	'Video Control'	'qv4l2'
add_exec	'Wifi Networks'	'sudo wpa_gui'
#end system

#begin awesome
name="Awesome"
add_exec	'Manual'		"xdg-open /usr/share/doc/awesome-4.2-r3/doc/index.html"
add_exec	'Restart Awesome'	"killall xxkb; conky-stop; echo 'awesome.restart()' | awesome-client"
add_exec	'Quit Awesome'	"killall xxkb; conky-stop; echo 'awesome.quit()' | awesome-client"
#end awesome
#+end_src

******* Pendrive menu 
:PROPERTIES:
:ID:       494968df-e006-456a-889b-2172bc6e8635
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/show-flash.sh :shebang #!/bin/bash 
menu-flash.sh > /tmp/1.sh && menugen /tmp/1.sh
#+end_src
#+begin_src bash :tangle /home/yantar92/.local/bin/menu-flash.sh :shebang #!/bin/bash
if [ $# = 1 ]; then
    echo "#begin $1"
    [ -z "`mount | grep "$1"`" ] && echo "name='$1(not mounted)'" || echo "name='$1'"
    if [ ! -z "`mount | grep "$1"`" ]; 
    then
	echo "add_exec 'Open' 'xdg-open /mnt/$1'"
	echo "add_exec 'Umount' \"sh -c 'umount+pop.sh $1'\""
    else
	#	[ "$1" = "Samba" ] && echo "prog 'Mount' - sh -c 'fusesmb.mount && notify-send Samba \" Successfully mounted\"'" && exit
	#	[ "$1" = "cdrom" ] && echo "prog 'Mount' - sh -c 'sudo mount /dev/cdrom /mnt/cdrom && notify-send Cdrom \"Successfully mounted\"'" && exit
	#   [ -d "/mnt/$1" ] && echo "prog 'Mount' - sh -c 'sudo \"`ls -l /mnt/$1/ | cut -d' ' -f 12 | tail -n1` -o utf8,gid=100,umask=002 /dev/`ls /mnt/$1/`\" /mnt/$1 && /bin/touch /tmp/$1'"
	[ -d "/mnt/$1" ] && echo "add_exec 'Mount' \"sudo `/bin/ls -l /mnt/$1 | awk '{print $11}' | tail -n1` -O utf8,gid=100,umask=002 /dev/`/bin/ls /mnt/$1` /mnt/$1 && /bin/touch /tmp/$1 && mount-pop.sh \""
    fi
    echo "#end $1"
else
    Folders="`find /mnt/ -maxdepth 1 -mindepth 1 -type d -printf "%f\n"`"
    ZZ="0"
    echo "#\!menugen"
    echo "#begin setup"
    echo "PATH=\"$PATH:/home/yantar92/.local/bin\""
    echo "ROFI_OPTS=\"-width 30 -lines 20 -auto-select -hide-scrollbar\""
    echo "#end setup"
    echo "#begin main"
    for x in $Folders; do
	echo "add_link '$x' '$x'"
	ZZ="1"
    done
    if [[ "$ZZ" = "0" ]]; then
	echo "name=\"No pendrives detected\""
	echo "numbered=false"
	echo "add_exec ' ' 'true'"
	echo "#end main"
    else
	echo "name=\"Pendrives\""
	echo "#end main"
	for x in $Folders; do
	    menu-flash.sh "$x"
	done
    fi
fi
#+end_src

Notification script

The scripts are relying on the way [[id:ea330abd-32a7-424f-ba95-1cdb7a400de4][USB automount]] is implemented.

#+begin_src bash :tangle /home/yantar92/.local/bin/umount+pop.sh :shebang #!/bin/bash
sudo umount /mnt/$1 > /tmp/umount.log 2>&1 && notify-send "$1" "Successfully unmounted" || notify-send -u critical "$1" "`cat /tmp/umount.log`" || rm /tmp/umount.log
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/mount-pop.sh :shebang #!/bin/bash
DISPLAY=:0
# export DBUS_SESSION_BUS_ADDRESS environment variable
# PID=$(pgrep awesome | head -n1)
# [[ -z "$PID" && -d "/proc/$PID" ]] && export DBUS_SESSION_BUS_ADDRESS="$(grep -z DBUS_SESSION_BUS_ADDRESS /proc/$PID/environ | tr '\0' '\n' | cut -d= -f2-)"

Folders="`find /mnt/ -maxdepth 1 -mindepth 1 -type d -printf "%f\n"`"
for x in $Folders; do
    [ -f "/tmp/$x" ] && notify-send -u critical -t 5000 "$x" "Successfully mounted" && rm "/tmp/$x";
done
#+end_src

**** Sound control: pavucontrol-qt
:PROPERTIES:
:ID:       c585d25e-a367-4252-b668-79a645f3c1d7
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-sound/pavucontrol-qt
#+end_src

**** Webcam control: v4l-utils (qv4l2)
:PROPERTIES:
:ID:       99aea26f-097f-4c07-9a82-fde5a4e4f150
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-tv/v4l-utils
#+end_src

Need to enable gui
#+begin_src conf :tangle /sudo::/etc/portage/package.use/v4l-utils
media-tv/v4l-utils qt5
#+end_src

**** Read key evens (xev)
:PROPERTIES:
:ID:       4af366b8-d9a1-4e6c-9749-cdde75f46091
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-apps/xev
#+end_src

**** =net-misc/ssh-askpass-fullscreen=
:PROPERTIES:
:ID:       4f11175e-8e12-4596-b651-f21864761e32
:END:
Required for straight.el in emacs

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-misc/ssh-askpass-fullscreen
#+end_src

**** Screenshot (=flameshot=)
:PROPERTIES:
:ID:       9b6792c1-5924-48ab-954c-7ac333a144ff
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-gfx/flameshot
#+end_src

**** Other screenshot utility: =scrot= + =gifsicle= to compress =gifs=
*** Terminal: Kitty

**** Installation
:PROPERTIES:
:ID:       66232b90-61e7-4b28-bc99-a4f452eca76c
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-terms/kitty
#+end_src

Use the cutting edge version:
[2021-04-10 Sat] Do not use it, Gentoo ebuild is not working for master now.
#+BEGIN_SRC conf :tangle /sudo::/etc/portage/package.accept_keywords/kitty
x11-terms/kitty ~amd64
x11-terms/kitty-terminfo ~amd64
#+END_SRC

Required use changes:
#+BEGIN_SRC conf :tangle /sudo::/etc/portage/package.use/kitty
media-libs/libcanberra alsa
#+END_SRC

**** Configuration

***** Appearance
:PROPERTIES:
:ID:       3a2b29f7-62da-4c70-bf0b-a995ff2b7caa
:END:
#+begin_src conf :tangle /home/yantar92/.config/kitty/kitty.conf
# vim:fileencoding=utf-8:ft=conf:foldmethod=marker

#: Fonts {{{

#: kitty has very powerful font management. You can configure
#: individual font faces and even specify special fonts for particular
#: characters.

font_family      monospace
bold_font        auto
italic_font      auto
bold_italic_font auto

#: You can specify different fonts for the bold/italic/bold-italic
#: variants. To get a full list of supported fonts use the `kitty
#: list-fonts` command. By default they are derived automatically, by
#: the OSes font system. Setting them manually is useful for font
#: families that have many weight variants like Book, Medium, Thick,
#: etc. For example::

#:     font_family      Operator Mono Book
#:     bold_font        Operator Mono Medium
#:     italic_font      Operator Mono Book Italic
#:     bold_italic_font Operator Mono Medium Italic

#font_size 11.0
font_size 15

#: Font size (in pts)

adjust_line_height  0
adjust_column_width 0

#: Change the size of each character cell kitty renders. You can use
#: either numbers, which are interpreted as pixels or percentages
#: (number followed by %), which are interpreted as percentages of the
#: unmodified values. You can use negative pixels or percentages less
#: than 100% to reduce sizes (but this might cause rendering
#: artifacts).

# symbol_map U+E0A0-U+E0A2,U+E0B0-U+E0B3 PowerlineSymbols

#: Map the specified unicode codepoints to a particular font. Useful
#: if you need special rendering for some symbols, such as for
#: Powerline. Avoids the need for patched fonts. Each unicode code
#: point is specified in the form U+<code point in hexadecimal>. You
#: can specify multiple code points, separated by commas and ranges
#: separated by hyphens. symbol_map itself can be specified multiple
#: times. Syntax is::

#:     symbol_map codepoints Font Family Name

disable_ligatures never

#: Choose how you want to handle multi-character ligatures. The
#: default is to always render them.  You can tell kitty to not render
#: them when the cursor is over them by using cursor to make editing
#: easier, or have kitty never render them at all by using always, if
#: you don't like them. The ligature strategy can be set per-window
#: either using the kitty remote control facility or by defining
#: shortcuts for it in kitty.conf, for example::

#:     map alt+1 disable_ligatures_in active always
#:     map alt+2 disable_ligatures_in all never
#:     map alt+3 disable_ligatures_in tab cursor

box_drawing_scale 0.001, 1, 1.5, 2

#: Change the sizes of the lines used for the box drawing unicode
#: characters These values are in pts. They will be scaled by the
#: monitor DPI to arrive at a pixel value. There must be four values
#: corresponding to thin, normal, thick, and very thick lines.

#: }}}

#: Cursor customization {{{

cursor #cccccc

#: Default cursor color

cursor_text_color #111111

#: Choose the color of text under the cursor. If you want it rendered
#: with the background color of the cell underneath instead, use the
#: special keyword: background

cursor_shape block

#: The cursor shape can be one of (block, beam, underline)

cursor_blink_interval -1

#: The interval (in seconds) at which to blink the cursor. Set to zero
#: to disable blinking. Negative values mean use system default. Note
#: that numbers smaller than repaint_delay will be limited to
#: repaint_delay.

cursor_stop_blinking_after 15.0

#: Stop blinking cursor after the specified number of seconds of
#: keyboard inactivity.  Set to zero to never stop blinking.

#: }}}
#+END_SRC

***** Text buffer
:PROPERTIES:
:ID:       8efcdd1d-1ca3-4330-b49e-35cd939892a0
:END:
#+BEGIN_SRC conf  :tangle /home/yantar92/.config/kitty/kitty.conf

#: Scrollback {{{

scrollback_lines 2000

#: Number of lines of history to keep in memory for scrolling back.
#: Memory is allocated on demand. Negative numbers are (effectively)
#: infinite scrollback. Note that using very large scrollback is not
#: recommended as it can slow down resizing of the terminal and also
#: use large amounts of RAM.

scrollback_pager less --chop-long-lines --RAW-CONTROL-CHARS +INPUT_LINE_NUMBER

#: Program with which to view scrollback in a new window. The
#: scrollback buffer is passed as STDIN to this program. If you change
#: it, make sure the program you use can handle ANSI escape sequences
#: for colors and text formatting. INPUT_LINE_NUMBER in the command
#: line above will be replaced by an integer representing which line
#: should be at the top of the screen.

scrollback_pager_history_size 0

#: Separate scrollback history size, used only for browsing the
#: scrollback buffer (in MB). This separate buffer is not available
#: for interactive scrolling but will be piped to the pager program
#: when viewing scrollback buffer in a separate window. The current
#: implementation stores one character in 4 bytes, so approximatively
#: 2500 lines per megabyte at 100 chars per line. A value of zero or
#: less disables this feature. The maximum allowed size is 4GB.

wheel_scroll_multiplier 5.0

#: Modify the amount scrolled by the mouse wheel. Note this is only
#: used for low precision scrolling devices, not for high precision
#: scrolling on platforms such as macOS and Wayland. Use negative
#: numbers to change scroll direction.

touch_scroll_multiplier 1.0

#: Modify the amount scrolled by a touchpad. Note this is only used
#: for high precision scrolling devices on platforms such as macOS and
#: Wayland. Use negative numbers to change scroll direction.

#: }}}
#+END_SRC

***** Mouse
:PROPERTIES:
:ID:       0f17aadb-10c1-4f04-9edb-edd1f5ae4f97
:END:
#+BEGIN_SRC conf  :tangle /home/yantar92/.config/kitty/kitty.conf

#: Mouse {{{

mouse_hide_wait 3.0

#: Hide mouse cursor after the specified number of seconds of the
#: mouse not being used. Set to zero to disable mouse cursor hiding.
#: Set to a negative value to hide the mouse cursor immediately when
#: typing text.

url_color #0087bd
url_style curly

#: The color and style for highlighting URLs on mouse-over. url_style
#: can be one of: none, single, double, curly

open_url_modifiers kitty_mod

#: The modifier keys to press when clicking with the mouse on URLs to
#: open the URL

open_url_with xdg-open

#: The program with which to open URLs that are clicked on. The
#: special value default means to use the operating system's default
#: URL handler.

copy_on_select no

#: Copy to clipboard or a private buffer on select. With this set to
#: clipboard, simply selecting text with the mouse will cause the text
#: to be copied to clipboard. Useful on platforms such as macOS that
#: do not have the concept of primary selections. You can instead
#: specify a name such as a1 to copy to a private kitty buffer
#: instead. Map a shortcut with the paste_from_buffer action to paste
#: from this private buffer. For example::

#:     map cmd+shift+v paste_from_buffer a1

#: Note that copying to the clipboard is a security risk, as all
#: programs, including websites open in your browser can read the
#: contents of the system clipboard.

strip_trailing_spaces never

#: Remove spaces at the end of lines when copying to clipboard. A
#: value of smart will do it when using normal selections, but not
#: rectangle selections. always will always do it.

rectangle_select_modifiers ctrl+alt

#: The modifiers to use rectangular selection (i.e. to select text in
#: a rectangular block with the mouse)

terminal_select_modifiers shift

#: The modifiers to override mouse selection even when a terminal
#: application has grabbed the mouse

select_by_word_characters :@-./_~?&=%+#

#: Characters considered part of a word when double clicking. In
#: addition to these characters any character that is marked as an
#: alpha-numeric character in the unicode database will be matched.

click_interval -1.0

#: The interval between successive clicks to detect double/triple
#: clicks (in seconds). Negative numbers will use the system default
#: instead, if available, or fallback to 0.5.

focus_follows_mouse no

#: Set the active window to the window under the mouse when moving the
#: mouse around

pointer_shape_when_grabbed arrow

#: The shape of the mouse pointer when the program running in the
#: terminal grabs the mouse.

#: }}}
#+END_SRC

***** Performance tuning
:PROPERTIES:
:ID:       6b4f1201-dd40-4921-81dc-0c83d20837d4
:END:
#+BEGIN_SRC conf  :tangle /home/yantar92/.config/kitty/kitty.conf

#: Performance tuning {{{

repaint_delay 10

#: Delay (in milliseconds) between screen updates. Decreasing it,
#: increases frames-per-second (FPS) at the cost of more CPU usage.
#: The default value yields ~100 FPS which is more than sufficient for
#: most uses. Note that to actually achieve 100 FPS you have to either
#: set sync_to_monitor to no or use a monitor with a high refresh
#: rate. Also, to minimize latency when there is pending input to be
#: processed, repaint_delay is ignored.

input_delay 3

#: Delay (in milliseconds) before input from the program running in
#: the terminal is processed. Note that decreasing it will increase
#: responsiveness, but also increase CPU usage and might cause flicker
#: in full screen programs that redraw the entire screen on each loop,
#: because kitty is so fast that partial screen updates will be drawn.

sync_to_monitor yes

#: Sync screen updates to the refresh rate of the monitor. This
#: prevents tearing (https://en.wikipedia.org/wiki/Screen_tearing)
#: when scrolling. However, it limits the rendering speed to the
#: refresh rate of your monitor. With a very high speed mouse/high
#: keyboard repeat rate, you may notice some slight input latency. If
#: so, set this to no.

#: }}}
#+END_SRC

***** Terminal bell
:PROPERTIES:
:ID:       021dafbb-51b7-4c95-ab60-13f7e38412ac
:END:
#+BEGIN_SRC conf  :tangle /home/yantar92/.config/kitty/kitty.conf

#: Terminal bell {{{

enable_audio_bell no

#: Enable/disable the audio bell. Useful in environments that require
#: silence.

visual_bell_duration 0.0

#: Visual bell duration. Flash the screen when a bell occurs for the
#: specified number of seconds. Set to zero to disable.

window_alert_on_bell yes

#: Request window attention on bell. Makes the dock icon bounce on
#: macOS or the taskbar flash on linux.

bell_on_tab yes

#: Show a bell symbol on the tab if a bell occurs in one of the
#: windows in the tab and the window is not the currently focused
#: window

command_on_bell none

#: Program to run when a bell occurs.

#: }}}
#+END_SRC

***** Window layout
:PROPERTIES:
:ID:       2810697d-8808-4670-83c3-ff9771ac999f
:END:
#+BEGIN_SRC conf  :tangle /home/yantar92/.config/kitty/kitty.conf

#: Window layout {{{

remember_window_size  yes
initial_window_width  640
initial_window_height 400

#: If enabled, the window size will be remembered so that new
#: instances of kitty will have the same size as the previous
#: instance. If disabled, the window will initially have size
#: configured by initial_window_width/height, in pixels. You can use a
#: suffix of "c" on the width/height values to have them interpreted
#: as number of cells instead of pixels.

enabled_layouts *

#: The enabled window layouts. A comma separated list of layout names.
#: The special value all means all layouts. The first listed layout
#: will be used as the startup layout. For a list of available
#: layouts, see the
#: https://sw.kovidgoyal.net/kitty/index.html#layouts.

window_resize_step_cells 2
window_resize_step_lines 2

#: The step size (in units of cell width/cell height) to use when
#: resizing windows. The cells value is used for horizontal resizing
#: and the lines value for vertical resizing.

window_border_width 1.0

#: The width (in pts) of window borders. Will be rounded to the
#: nearest number of pixels based on screen resolution. Note that
#: borders are displayed only when more than one window is visible.
#: They are meant to separate multiple windows.

draw_minimal_borders yes

#: Draw only the minimum borders needed. This means that only the
#: minimum needed borders for inactive windows are drawn. That is only
#: the borders that separate the inactive window from a neighbor. Note
#: that setting a non-zero window margin overrides this and causes all
#: borders to be drawn.

window_margin_width 0.0

#: The window margin (in pts) (blank area outside the border)

single_window_margin_width -1000.0

#: The window margin (in pts) to use when only a single window is
#: visible. Negative values will cause the value of
#: window_margin_width to be used instead.

window_padding_width 0.0

#: The window padding (in pts) (blank area between the text and the
#: window border)

placement_strategy center

#: When the window size is not an exact multiple of the cell size, the
#: cell area of the terminal window will have some extra padding on
#: the sides. You can control how that padding is distributed with
#: this option. Using a value of center means the cell area will be
#: placed centrally. A value of top-left means the padding will be on
#: only the bottom and right edges.

active_border_color #00ff00

#: The color for the border of the active window. Set this to none to
#: not draw borders around the active window.

inactive_border_color #cccccc

#: The color for the border of inactive windows

bell_border_color #ff5a00

#: The color for the border of inactive windows in which a bell has
#: occurred

inactive_text_alpha 1.0

#: Fade the text in inactive windows by the specified amount (a number
#: between zero and one, with zero being fully faded).

hide_window_decorations no

#: Hide the window decorations (title-bar and window borders). Whether
#: this works and exactly what effect it has depends on the window
#: manager/operating system.

resize_debounce_time 0.1

#: The time (in seconds) to wait before redrawing the screen when a
#: resize event is received. On platforms such as macOS, where the
#: operating system sends events corresponding to the start and end of
#: a resize, this number is ignored.

resize_draw_strategy static

#: Choose how kitty draws a window while a resize is in progress. A
#: value of static means draw the current window contents, mostly
#: unchanged. A value of scale means draw the current window contents
#: scaled. A value of blank means draw a blank window. A value of size
#: means show the window size in cells.

#: }}}
#+END_SRC

***** Tab bar
:PROPERTIES:
:ID:       cd314739-abcf-4075-b8f6-821f7d30487d
:END:
#+BEGIN_SRC conf  :tangle /home/yantar92/.config/kitty/kitty.conf

#: Tab bar {{{

tab_bar_edge bottom

#: Which edge to show the tab bar on, top or bottom

tab_bar_margin_width 0.0

#: The margin to the left and right of the tab bar (in pts)

tab_bar_style fade

#: The tab bar style, can be one of: fade, separator or hidden. In the
#: fade style, each tab's edges fade into the background color, in the
#: separator style, tabs are separated by a configurable separator.

tab_bar_min_tabs 2

#: The minimum number of tabs that must exist before the tab bar is
#: shown

tab_switch_strategy previous

#: The algorithm to use when switching to a tab when the current tab
#: is closed. The default of previous will switch to the last used
#: tab. A value of left will switch to the tab to the left of the
#: closed tab. A value of last will switch to the right-most tab.

tab_fade 0.25 0.5 0.75 1

#: Control how each tab fades into the background when using fade for
#: the tab_bar_style. Each number is an alpha (between zero and one)
#: that controls how much the corresponding cell fades into the
#: background, with zero being no fade and one being full fade. You
#: can change the number of cells used by adding/removing entries to
#: this list.

tab_separator " "

#: The separator between tabs in the tab bar when using separator as
#: the tab_bar_style.

tab_title_template {title}

#: A template to render the tab title. The default just renders the
#: title. If you wish to include the tab-index as well, use something
#: like: {index}: {title}. Useful if you have shortcuts mapped for
#: goto_tab N.

active_tab_foreground   #000
active_tab_background   #eee
active_tab_font_style   bold-italic
inactive_tab_foreground #444
inactive_tab_background #999
inactive_tab_font_style normal

#: Tab bar colors and styles

#: }}}
#+END_SRC

***** Color scheme
:PROPERTIES:
:ID:       26e871cf-3b07-47de-8ba4-c4cc8f876681
:END:
#+BEGIN_SRC conf  :tangle /home/yantar92/.config/kitty/kitty.conf

#: Color scheme {{{

foreground #dddddd
background #000000

#: The foreground and background colors

background_opacity 1.0

#: The opacity of the background. A number between 0 and 1, where 1 is
#: opaque and 0 is fully transparent.  This will only work if
#: supported by the OS (for instance, when using a compositor under
#: X11). Note that it only sets the default background color's
#: opacity. This is so that things like the status bar in vim,
#: powerline prompts, etc. still look good.  But it means that if you
#: use a color theme with a background color in your editor, it will
#: not be rendered as transparent.  Instead you should change the
#: default background color in your kitty config and not use a
#: background color in the editor color scheme. Or use the escape
#: codes to set the terminals default colors in a shell script to
#: launch your editor.  Be aware that using a value less than 1.0 is a
#: (possibly significant) performance hit.  If you want to dynamically
#: change transparency of windows set dynamic_background_opacity to
#: yes (this is off by default as it has a performance cost)

dynamic_background_opacity no

#: Allow changing of the background_opacity dynamically, using either
#: keyboard shortcuts (increase_background_opacity and
#: decrease_background_opacity) or the remote control facility.

dim_opacity 0.75

#: How much to dim text that has the DIM/FAINT attribute set. One
#: means no dimming and zero means fully dimmed (i.e. invisible).

selection_foreground #000000

#: The foreground for text selected with the mouse. A value of none
#: means to leave the color unchanged.

selection_background #fffacd

#: The background for text selected with the mouse.


#: The 16 terminal colors. There are 8 basic colors, each color has a
#: dull and bright version. You can also set the remaining colors from
#: the 256 color table as color16 to color255.

color0 #000000
color8 #767676

#: black

color1 #cc0403
color9 #f2201f

#: red

color2  #19cb00
color10 #23fd00

#: green

color3  #cecb00
color11 #fffd00

#: yellow

color4  #0d73cc
color12 #1a8fff

#: blue

color5  #cb1ed1
color13 #fd28ff

#: magenta

color6  #0dcdcd
color14 #14ffff

#: cyan

color7  #dddddd
color15 #ffffff

#: white

#: }}}
#+END_SRC

***** Advanced
:PROPERTIES:
:ID:       0b6f566c-4fe2-44ff-a6e9-60ec3d252226
:END:
#+BEGIN_SRC conf  :tangle /home/yantar92/.config/kitty/kitty.conf

#: Advanced {{{

shell .

#: The shell program to execute. The default value of . means to use
#: whatever shell is set as the default shell for the current user.
#: Note that on macOS if you change this, you might need to add
#: --login to ensure that the shell starts in interactive mode and
#: reads its startup rc files.

editor .

#: The console editor to use when editing the kitty config file or
#: similar tasks. A value of . means to use the environment variable
#: EDITOR. Note that this environment variable has to be set not just
#: in your shell startup scripts but system-wide, otherwise kitty will
#: not see it.

close_on_child_death no

#: Close the window when the child process (shell) exits. If no (the
#: default), the terminal will remain open when the child exits as
#: long as there are still processes outputting to the terminal (for
#: example disowned or backgrounded processes). If yes, the window
#: will close as soon as the child process exits. Note that setting it
#: to yes means that any background processes still using the terminal
#: can fail silently because their stdout/stderr/stdin no longer work.

allow_remote_control no

#: Allow other programs to control kitty. If you turn this on other
#: programs can control all aspects of kitty, including sending text
#: to kitty windows, opening new windows, closing windows, reading the
#: content of windows, etc. Note that this even works over ssh
#: connections.

# env 

#: Specify environment variables to set in all child processes. Note
#: that environment variables are expanded recursively, so if you
#: use::

#:     env MYVAR1=a
#:     env MYVAR2=${MYVAR1}/${HOME}/b

#: The value of MYVAR2 will be a/<path to home directory>/b.

update_check_interval 0

#: Periodically check if an update to kitty is available. If an update
#: is found a system notification is displayed informing you of the
#: available update. The default is to check every 24 hrs, set to zero
#: to disable.

startup_session none

#: Path to a session file to use for all kitty instances. Can be
#: overridden by using the kitty --session command line option for
#: individual instances. See
#: https://sw.kovidgoyal.net/kitty/index.html#sessions in the kitty
#: documentation for details. Note that relative paths are interpreted
#: with respect to the kitty config directory. Environment variables
#: in the path are expanded.

clipboard_control write-clipboard write-primary

#: Allow programs running in kitty to read and write from the
#: clipboard. You can control exactly which actions are allowed. The
#: set of possible actions is: write-clipboard read-clipboard write-
#: primary read-primary. You can additionally specify no-append to
#: disable kitty's protocol extension for clipboard concatenation. The
#: default is to allow writing to the clipboard and primary selection
#: with concatenation enabled. Note that enabling the read
#: functionality is a security risk as it means that any program, even
#: one running on a remote server via SSH can read your clipboard.

term xterm-kitty

#: The value of the TERM environment variable to set. Changing this
#: can break many terminal programs, only change it if you know what
#: you are doing, not because you read some advice on Stack Overflow
#: to change it. The TERM variable is used by various programs to get
#: information about the capabilities and behavior of the terminal. If
#: you change it, depending on what programs you run, and how
#: different the terminal you are changing it to is, various things
#: from key-presses, to colors, to various advanced features may not
#: work.

#: }}}
#+END_SRC

***** Keyboard shortcuts
:PROPERTIES:
:ID:       8c04a3db-d856-4520-9ca4-daadaa5fe8cc
:END:
#+BEGIN_SRC conf  :tangle /home/yantar92/.config/kitty/kitty.conf

#: Keyboard shortcuts {{{

#: For a list of key names, see: GLFW keys
#: <https://www.glfw.org/docs/latest/group__keys.html>. The name to
#: use is the part after the GLFW_KEY_ prefix. For a list of modifier
#: names, see: GLFW mods
#: <https://www.glfw.org/docs/latest/group__mods.html>

#: On Linux you can also use XKB key names to bind keys that are not
#: supported by GLFW. See XKB keys
#: <https://github.com/xkbcommon/libxkbcommon/blob/master/xkbcommon/xkbcommon-
#: keysyms.h> for a list of key names. The name to use is the part
#: after the XKB_KEY_ prefix. Note that you should only use an XKB key
#: name for keys that are not present in the list of GLFW keys.

#: Finally, you can use raw system key codes to map keys. To see the
#: system key code for a key, start kitty with the kitty --debug-
#: keyboard option. Then kitty will output some debug text for every
#: key event. In that text look for ``native_code`` the value of that
#: becomes the key name in the shortcut. For example:

#: .. code-block:: none

#:     on_key_input: glfw key: 65 native_code: 0x61 action: PRESS mods: 0x0 text: 'a'

#: Here, the key name for the A key is 0x61 and you can use it with::

#:     map ctrl+0x61 something

#: to map ctrl+a to something.

#: You can use the special action no_op to unmap a keyboard shortcut
#: that is assigned in the default configuration.

#: You can combine multiple actions to be triggered by a single
#: shortcut, using the syntax below::

#:     map key combine <separator> action1 <separator> action2 <separator> action3 ...

#: For example::

#:     map kitty_mod+e combine : new_window : next_layout

#: this will create a new window and switch to the next available
#: layout

#: You can use multi-key shortcuts using the syntax shown below::

#:     map key1>key2>key3 action

#: For example::

#:     map ctrl+f>2 set_font_size 20

kitty_mod ctrl+shift

#: The value of kitty_mod is used as the modifier for all default
#: shortcuts, you can change it in your kitty.conf to change the
#: modifiers for all the default shortcuts.

clear_all_shortcuts no

#: You can have kitty remove all shortcut definition seen up to this
#: point. Useful, for instance, to remove the default shortcuts.

#: Clipboard {{{

map kitty_mod+d copy_to_clipboard

#: There is also a copy_or_interrupt action that can be optionally
#: mapped to Ctrl+c. It will copy only if there is a selection and
#: send an interrupt otherwise.

map kitty_mod+f  paste_from_clipboard
map kitty_mod+F  paste_from_selection
map shift+insert paste_from_selection
map kitty_mod+o  pass_selection_to_program

#: You can also pass the contents of the current selection to any
#: program using pass_selection_to_program. By default, the system's
#: open program is used, but you can specify your own, the selection
#: will be passed as a command line argument to the program, for
#: example::

#:     map kitty_mod+o pass_selection_to_program firefox

#: You can pass the current selection to a terminal program running in
#: a new kitty window, by using the @selection placeholder::

#:     map kitty_mod+y new_window less @selection

#: }}}

#: Scrolling {{{

map kitty_mod+up        scroll_line_up
map kitty_mod+k         scroll_line_up
map kitty_mod+down      scroll_line_down
map kitty_mod+j         scroll_line_down
map kitty_mod+page_up   scroll_page_up
map kitty_mod+page_down scroll_page_down

map kitty_mod+l   scroll_page_up
map kitty_mod+; scroll_page_down

map kitty_mod+home      scroll_home
map kitty_mod+end       scroll_end
map kitty_mod+h         show_scrollback

#: You can pipe the contents of the current screen + history buffer as
#: STDIN to an arbitrary program using the ``pipe`` function. For
#: example, the following opens the scrollback buffer in less in an
#: overlay window::

#:     map f1 pipe @ansi overlay less +G -R

#: For more details on piping screen and buffer contents to external
#: programs, see pipe.

#: }}}

#: Window management {{{

map kitty_mod+enter new_window

#: You can open a new window running an arbitrary program, for
#: example::

#:     map kitty_mod+y      new_window mutt

#: You can open a new window with the current working directory set to
#: the working directory of the current window using::

#:     map ctrl+alt+enter    new_window_with_cwd

#: You can open a new window that is allowed to control kitty via the
#: kitty remote control facility by prefixing the command line with @.
#: Any programs running in that window will be allowed to control
#: kitty. For example::

#:     map ctrl+enter new_window @ some_program

#: You can open a new window next to the currently active window or as
#: the first window, with::

#:     map ctrl+n new_window !neighbor some_program
#:     map ctrl+f new_window !first some_program

map kitty_mod+n new_os_window
map kitty_mod+w close_window

#map kitty_mod+] next_window
#map kitty_mod+[ previous_window
map kitty_mod+j next_window
map kitty_mod+k previous_window

map kitty_mod+f move_window_forward
map kitty_mod+b move_window_backward
map kitty_mod+` move_window_to_top
map kitty_mod+r start_resizing_window
map kitty_mod+1 first_window
map kitty_mod+2 second_window
map kitty_mod+3 third_window
map kitty_mod+4 fourth_window
map kitty_mod+5 fifth_window
map kitty_mod+6 sixth_window
map kitty_mod+7 seventh_window
map kitty_mod+8 eighth_window
map kitty_mod+9 ninth_window
map kitty_mod+0 tenth_window
#: }}}

#: Tab management {{{

map kitty_mod+right next_tab
map kitty_mod+o next_tab
map kitty_mod+left  previous_tab
map kitty_mod+i  previous_tab
map kitty_mod+t     new_tab
map kitty_mod+q     close_tab
map kitty_mod+.     move_tab_forward
map kitty_mod+,     move_tab_backward
map kitty_mod+alt+t set_tab_title

#: You can also create shortcuts to go to specific tabs, with 1 being
#: the first tab, 2 the second tab and -1 being the previously active
#: tab::

#:     map ctrl+alt+1 goto_tab 1
#:     map ctrl+alt+2 goto_tab 2

#: Just as with new_window above, you can also pass the name of
#: arbitrary commands to run when using new_tab and use
#: new_tab_with_cwd. Finally, if you want the new tab to open next to
#: the current tab rather than at the end of the tabs list, use::

#:     map ctrl+t new_tab !neighbor [optional cmd to run]
#: }}}

#: Layout management {{{

map kitty_mod+space next_layout

#: You can also create shortcuts to switch to specific layouts::

#:     map ctrl+alt+t goto_layout tall
#:     map ctrl+alt+s goto_layout stack

#: Similarly, to switch back to the previous layout::

#:    map ctrl+alt+p last_used_layout
#: }}}

#: Font sizes {{{

#: You can change the font size for all top-level kitty OS windows at
#: a time or only the current one.

map kitty_mod+equal     change_font_size all +2.0
map kitty_mod+minus     change_font_size all -2.0
map kitty_mod+backspace change_font_size all 0

#: To setup shortcuts for specific font sizes::

#:     map kitty_mod+f6 change_font_size all 10.0

#: To setup shortcuts to change only the current OS window's font
#: size::

#:     map kitty_mod+f6 change_font_size current 10.0
#: }}}

#: Select and act on visible text {{{

#: Use the hints kitten to select text and either pass it to an
#: external program or insert it into the terminal or copy it to the
#: clipboard.

#map kitty_mod+e kitten hints

#: Open a currently visible URL using the keyboard. The program used
#: to open the URL is specified in open_url_with.

map kitty_mod+h>f kitten hints --type path --program default

#: Select a path/filename and insert it into the terminal. Useful, for
#: instance to run git commands on a filename output from a previous
#: git command.

#map kitty_mod+p>shift+f kitten hints --type path
map kitty_mod+h>p kitten hints --type path --program default

#: Select a path/filename and open it with the default open program.

#map kitty_mod+p>l kitten hints --type line --program -
map ctrl+shift+h>l kitten hints --type line --program *

#: Select a line of text and insert it into the terminal. Use for the
#: output of things like: ls -1

#map kitty_mod+p>w kitten hints --type word --program -
map ctrl+shift+h>w kitten hints --type word --program *

#: Select words and insert into terminal.

#: Select something that looks like a hash and insert it into the
#: terminal. Useful with git, which uses sha1 hashes to identify
#: commits


#: The hints kitten has many more modes of operation that you can map
#: to different shortcuts. For a full description see kittens/hints.
#: }}}

#: Miscellaneous {{{

map kitty_mod+f11    toggle_fullscreen
map kitty_mod+f10    toggle_maximized
map kitty_mod+u      kitten unicode_input
map kitty_mod+f2     edit_config_file
map kitty_mod+escape kitty_shell window

#: Open the kitty shell in a new window/tab/overlay/os_window to
#: control kitty using commands.

map kitty_mod+a>m    set_background_opacity +0.1
map kitty_mod+a>l    set_background_opacity -0.1
map kitty_mod+a>1    set_background_opacity 1
map kitty_mod+a>d    set_background_opacity default
map kitty_mod+delete clear_terminal reset active

#: You can create shortcuts to clear/reset the terminal. For example::

#:     # Reset the terminal
#:     map kitty_mod+f9 clear_terminal reset active
#:     # Clear the terminal screen by erasing all contents
#:     map kitty_mod+f10 clear_terminal clear active
#:     # Clear the terminal scrollback by erasing it
#:     map kitty_mod+f11 clear_terminal scrollback active
#:     # Scroll the contents of the screen into the scrollback
#:     map kitty_mod+f12 clear_terminal scroll active

#: If you want to operate on all windows instead of just the current
#: one, use all instead of active.

#: It is also possible to remap Ctrl+L to both scroll the current
#: screen contents into the scrollback buffer and clear the screen,
#: instead of just clearing the screen::

#:     map ctrl+l combine : clear_terminal scroll active : send_text normal,application \x0c


#: You can tell kitty to send arbitrary (UTF-8) encoded text to the
#: client program when pressing specified shortcut keys. For example::

#:     map ctrl+alt+a send_text all Special text

#: This will send "Special text" when you press the ctrl+alt+a key
#: combination.  The text to be sent is a python string literal so you
#: can use escapes like \x1b to send control codes or \u21fb to send
#: unicode characters (or you can just input the unicode characters
#: directly as UTF-8 text). The first argument to send_text is the
#: keyboard modes in which to activate the shortcut. The possible
#: values are normal or application or kitty or a comma separated
#: combination of them.  The special keyword all means all modes. The
#: modes normal and application refer to the DECCKM cursor key mode
#: for terminals, and kitty refers to the special kitty extended
#: keyboard protocol.

#: Another example, that outputs a word and then moves the cursor to
#: the start of the line (same as pressing the Home key)::

#:     map ctrl+alt+a send_text normal Word\x1b[H
#:     map ctrl+alt+a send_text application Word\x1bOH

#: }}}

# }}}
#+end_src

*** Mouse

**** COMMENT Disable touchpad
:PROPERTIES:
:ID:       c412a610-d374-499e-98d8-07d7ad1ece8b
:END:

I need xinput command here

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-apps/xinput
#+end_src

#+begin_src bash  :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash
xinput disable "Elan Touchpad"
#+end_src

**** Toggle trackball
:PROPERTIES:
:ID:       a910bb4c-f08e-4da7-8e52-cd50247022bd
:END:

Uses hhpc utility
[[file:../Dist/hhpc-master/]]

#+begin_src bash :tangle /home/yantar92/.local/bin/trackball-toggle.sh :shebang #!/bin/bash
[[ -f /tmp/trackball-disabled ]] && STATE="disabled" || STATE="enabled"

if [[ "$1" == "kill" ]]; then
    killall hhpc > /dev/null 2>&1;
    rm -f /tmp/trackball-disabled
    echo "mouse.coords({x=960,y=540})" | awesome-client
    exit
fi

if [[ "$1" == "status" ]]; then
    echo $STATE
    exit
fi

[[ "$STATE" == "disabled" ]] && NEW_STATE="enabled" || NEW_STATE="disabled"
[[ "$1" == "enable" ]] && NEW_STATE="enabled"
[[ "$1" == "disable" ]] && NEW_STATE="disabled"

if [[ ! -z "`pgrep hhpc`" ]]; then
    [[ "$NEW_STATE" == "$STATE" ]] && exit
fi

if [[ "$NEW_STATE" == "enabled" ]]; then
    killall hhpc 2>&1 > /dev/null;
    rm -f /tmp/trackball-disabled
    echo "mouse.coords({x=960,y=540})" | awesome-client
else
    hhpc -i 0&
    touch /tmp/trackball-disabled
fi
#+end_src

*** Clipboard ring integrated with [[id:9220e236-6887-4b3a-82e3-a83ff1aed4a9][Rofi quick menu]]: clipmenu
:PROPERTIES:
:ID:       ae1f45be-857d-41d5-81e6-a7d0ac6f1440
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-misc/clipmenu
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/clipmenu
x11-misc/clipmenu ~amd64
=x11-misc/clipnotify-1.0.2 ~amd64
#+end_src

Run daemon on startup:
#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash
DISPLAY=:0 clipmenud >/dev/null 2>&1 &
#+end_src

Script to show clipboard history and paste it at point. Uses xdotool (to actually insert) and clipmenu
#+begin_src bash :tangle /home/yantar92/.local/bin/clipmenu.sh :shebang #!/bin/bash
CM_LAUNCHER=rofi clipmenu -width -150 && xdotool key Shift+Insert
#+end_src

The script is bound in [[id:23de5ad2-4320-4f72-91f0-ca909e3abbab][Awesome WM settings]].

** App wrappers
Collection of bash script invoking default apps (with possible tweaks)

*** Music player
:PROPERTIES:
:ID:       aabe2409-9b6d-4d26-bd8c-de9c660eff53
:END:

Show playlist:
#+begin_src bash :tangle /home/yantar92/.local/bin/mingus-start.sh :shebang #!/bin/bash
emacsclient -F "'(fullscreen . maximized)" -n -c -e "(mingus)"
#+end_src
Delete currently playing song from the playlist:
#+begin_src bash :tangle /home/yantar92/.local/bin/mingus-del-current.sh :shebang #!/bin/bash 
emacsclient -e "(yant/mingus-delete-currently-playing)"
#+end_src
State popup
#+begin_src bash :tangle /home/yantar92/.local/bin/mpd_state_popup.sh :shebang #!/bin/bash
#disabled
exit;

ps aux | grep "[n]cmpcpp --current-song %a %b" && kill `ps aux | grep "[n]cmpcpp --current-song %a %b" | cut -f2 -d' '` 2>&1 > /dev/null
[[ -e /tmp/mpd_state ]] || echo "`ncmpcpp --current-song "%a %b"`" "`ncmpcpp --current-song "(%l) - %t"`" > /tmp/mpd_state
echo "`ncmpcpp --current-song "%a %b"`" "`ncmpcpp --current-song "(%l) - %t"`" > /tmp/mpd_state_new
diff /tmp/mpd_state /tmp/mpd_state_new 2>&1 > /dev/null|| if [ true ]; then
	[[ -z "`ncmpcpp --current-song | grep "mpd"`" ]] && notify-send "`ncmpcpp --current-song "%a %b"`" "`ncmpcpp --current-song "(%l) - %t"`"
	echo "`ncmpcpp --current-song "%a %b"`" "`ncmpcpp --current-song "(%l) - %t"`" > /tmp/mpd_state
fi
#+end_src
Pause/play 
#+begin_src bash :tangle /home/yantar92/.local/bin/mpd-toggle.sh :shebang #!/bin/bash
mpc -q toggle && mpd_state_popup.sh
#+end_src
Next 
#+begin_src bash :tangle /home/yantar92/.local/bin/mpd-next.sh :shebang #!/bin/bash
mpc -q next
#+end_src
Previous 
#+begin_src bash :tangle /home/yantar92/.local/bin/mpd-prev.sh :shebang #!/bin/bash
mpc -q prev
#+end_src
Next 
#+begin_src bash :tangle /home/yantar92/.local/bin/mpd-next.sh :shebang #!/bin/bash
mpc -q next
#+end_src
Mute
#+begin_src bash :tangle /home/yantar92/.local/bin/mute.sh :shebang #!/bin/bash
amixer -D pulse -q set Master toggle
volstatus_pop.sh
#+end_src
Increase volume
#+begin_src bash :tangle /home/yantar92/.local/bin/inc_volume.sh :shebang #!/bin/bash
amixer -q set Master 5%+

VOLUME="`amixer sget Master | tail -n1 | cut -d[ -f 2 | cut -d] -f 1 | cut -d% -f1 | head -n 1`"
VOLUME_STATUS="`amixer sget Master | tail -n1 | cut -d[ -f 4 | cut -d] -f1 | head -n 1`"

pacmd list-sinks | grep BATBAND && pacmd set-sink-volume $(pacmd list-sinks | grep index | tail -n1 | cut -d: -f2) $(echo "$VOLUME * 855" | bc -l) # 65536 max * 0.01
#+end_src
Decrease volume 
#+begin_src bash :tangle /home/yantar92/.local/bin/dec_volume.sh :shebang #!/bin/bash
amixer -q set Master 5%-

VOLUME="`amixer sget Master | tail -n1 | cut -d[ -f 2 | cut -d] -f 1 | cut -d% -f1 | head -n 1`"
VOLUME_STATUS="`amixer sget Master | tail -n1 | cut -d[ -f 4 | cut -d] -f1 | head -n 1`"

pacmd list-sinks | grep BATBAND && pacmd set-sink-volume $(pacmd list-sinks | grep index | tail -n1 | cut -d: -f2) $(echo "$VOLUME * 855" | bc -l) # 65536 max * 0.01
#+end_src
*** Email client
:PROPERTIES:
:ID:       0e2483aa-bc6f-4a19-beaf-28d854de2ff8
:END:

#+begin_src  bash :tangle /home/yantar92/.local/bin/notmuch-emacs-start.sh :shebang #!/bin/bash
searchstring="tag:inbox and tag:todo"
[[ "$1" == "--all" ]] && searchstring="tag:todo"

[[ "$1" == "--newsonly" ]] && searchstring="tag:listinbox and tag:todo"
[[ "$1" == "--inbox" || "$1" == "--newsonly" ]] && emacsclient -n -c -e "(progn (notmuch-search \"$searchstring\") (setq notmuch-frame t))" || emacsclient -n -c -e "(progn (notmuch-mua-new-mail) (setq notmuch-frame t))"
#+end_src

*** RSS reader
:PROPERTIES:
:ID:       274ec9fb-5d00-4dac-bb2f-fbad10eab60b
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/elfeed-start.sh :shebang #!/bin/bash
# emacsclient -F "'(fullscreen . maximized)" -c -e "(require 'elfeed-org)" -e "(elfeed-org)" -e "(elfeed)" -e "(sleep-for 0 10)" -e "(elfeed-search-update--force)"
emacsclient -F "'(fullscreen . maximized)" -c -e "(require 'elfeed-org)" -e "(elfeed-org)" -e "(elfeed)"
#+end_src

*** Text editor
:PROPERTIES:
:ID:       607c0dd3-3a0b-4575-8504-74c009c35671
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-libs/jemalloc
#+end_src

#+begin_src  bash :tangle /home/yantar92/.local/bin/emacs-start.sh :shebang #!/bin/bash
# [[ "$#" == "0" ]] && emacsclient --frame-parameters='(quote (name . "main"))' -c -n -e '(switch-to-buffer (quote "*scratch*"))' && exit
[[ "$#" == "0" ]] && emacsclient -c -n -e '(switch-to-buffer (quote "*scratch*"))' -e '(boon-set-command-state)' >>/dev/null 2>&1  || \
	#    /home/yantar92/tmp/emacs2/emacs/src/emacs && exit
	# emacs && exit
	LD_PRELOAD=/usr/lib64/libjemalloc.so.2 emacs && exit
[[ "$1" == "agenda" ]] && emacsclient -c -n -e '(org-agenda nil " ")'
#run_single_window.sh "Emacs" "sh -c emacs -name \"main\""
#+end_src

*** Browser
:PROPERTIES:
:ID:       8093fa46-44ef-4075-ad77-d23aaf4247fb
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/qutebrowser-start.sh :shebang #!/bin/bash
qutebrowser --loglevel critical --backend webengine 2>&1 | qutebrowser-logger.sh
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/qutebrowser-logger.sh :shebang #!/bin/bash
while read x; do
    [[ "$x" == *"with Emacs Client"* ]] && continue
    [[ "$x" == "Waiting for Emacs..." ]] && continue
    [[ "$x" == *"libpng warning:"* ]] && continue
    [[ "$x" == *"handshake failed; returned -1, SSL error code 1"* ]] && continue
    [[ "$x" == *"org.freedesktop.DBus.Error.ServiceUnknown: The name org.freedesktop.UPower was not provided by any .service files"* ]] && continue
    [[ "$x" == "" ]] && continue
    notify-send "Qutebrowser: $x"
    echo $(date): $x >> ~/.log/qutebrowser.log
done
#+end_src

** Mime info tools

*** xdg-utils
:PROPERTIES:
:ID:       b1bd552f-459b-4120-91f5-603f00aab25a
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-misc/xdg-utils
#+end_src

** Shell: bash

*** Configuration
:PROPERTIES:
:ID:       36cebccd-3f5a-4821-953b-0fcff4da5cb4
:END:

Common config to be used in interactive and noninteractive shells

#+begin_src bash :tangle /home/yantar92/.profile
export PATH="/home/yantar92/.local/bin:$PATH"
export DE="generic"
export GNUPLOT_LIB="~/.gnuplot/layout:$GNUPLOT_LIB"
export EDITOR="emacsclient -c"
export VISUAL="$EDITOR"

export PASSWORD_STORE_ENABLE_EXTENSIONS="true"

alias cleanlinks="true" # do not want to use it
#+end_src

Bash config 
#+begin_src bash :tangle /home/yantar92/.bashrc
source ~/.profile

# Infinite history
export HISTSIZE=-1
export HISTFILESIZE=-1
export HISTIGNORE="&:ls:[bf]g:exit"
export PROMPT_COMMAND='history -a'

shopt -s cdspell
shopt -s histappend
set bell-style none

alias ls="ls --color"
alias la="ls -a"
alias ll="ls -lh"
alias lal="la -alh"
alias sl="ls"
alias cl="cls"
alias csl="cls"
alias bc="bc -l"
alias rsync="rsync -P"

if [ -f /usr/bin/grc ]; then
    alias ping="grc ping"
    alias gcc="grc gcc"
    alias g++="grc g++"
    alias make="grc make"
    # alias cat="grc cat"
    # alias head="grc head"
    alias tail="grc tail"
    alias diff="grc diff"
fi

complete -cf sudo
complete -cf man

#trying to fix "Inappropriate ioctl for device" error from gpg
#https://github.com/keybase/keybase-issues/issues/1712
export GPG_TTY=$(tty)

#prompt
source ~/Dist/liquidprompt/liquidprompt
LP_PS1_POSTFIX="\n> "
#+end_src

[[file:../Dist/liquidprompt/]]

****************** TODO make ebuild for liquidprompt
****************** END

*** Bash completion (system-wide)
:PROPERTIES:
:ID:       3c19f64d-bc81-4666-b4f0-d2d8253531b1
:END:

Need to install bash-completion

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-shells/bash-completion
#+end_src

** Qutebrowser
:PROPERTIES:
:ID:       8f33d97b-6193-4164-b0a7-225bb7c30f75
:END:

Files to copy:
- file:~/.config/qutebrowser/bookmarks/urls
- file:~/.local/share/qutebrowser/cmd-history
- file:~/.local/share/qutebrowser/history.sqlite

#+begin_src conf :tangle /sudo::/var/lib/portage/world
www-client/qutebrowser
#+end_src

Use cutting edge version.
#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/qutebrowser
www-client/qutebrowser **
#+end_src

Use built-in scripts.
Also, enable =jumbo-build= use-flag as suggested in [[id:e650114a17f9ec488765f5da2972d6e207119349][Phate6660 [Github] issue#451 Some Gentoo recommendations]]
#+begin_src conf :tangle /sudo::/etc/portage/package.use/qutebrowser
www-client/qutebrowser scripts
dev-qt/qtwebengine jumbo-build
#+end_src

*** Userscripts
**** Open video link using mpv + youtube-dl
:PROPERTIES:
:ID:       461e5c3d-3c41-4bc8-a83d-b83b47d1780d
:END:

#+begin_src bash :tangle /home/yantar92/.local/share/qutebrowser/userscripts/mpv-qutebrowser.sh :mkdirp yes :shebang #!/bin/bash
rawurlencode() {
  local string="${1}"
  local strlen=${#string}
  local encoded=""
  local pos c o

  for (( pos=0 ; pos<strlen ; pos++ )); do
     c=${string:$pos:1}
     case "$c" in
         [-_.~a-zA-Z--0-9] ) o="${c}" ;;
	 [\[\]] ) o="|" ;;
         * )               printf -v o '%%%02x' "'$c"
     esac
     encoded+="${o}"
  done
#  echo "${encoded}"    # You can either set a return variable (FASTER) 
  REPLY="${encoded}"   #+or echo the result (EASIER)... or both... :p
}

rawurlencode "$1"
LINK="$REPLY"

echo "message-info \"Adding $QUTE_URL to mpv... \"" >> "$QUTE_FIFO" && mpv "$1" && echo "message-info \"Adding to $QUTE_URL mpv... done\"" >> "$QUTE_FIFO" || echo "message-error \"Adding $QUTE_URL to mpv... failed\"" >> "$QUTE_FIFO"
#+end_src
**** Org-mode capture
:PROPERTIES:
:ID:       63bf0108-5f95-4683-962f-9aa319f71ade
:END:

#+begin_src bash :tangle /home/yantar92/.local/share/qutebrowser/userscripts/org-protocol-add-bookmark.sh :mkdirp yes :shebang #!/bin/bash
rawurlencode() {
  local string="${1}"
  local strlen=${#string}
  local encoded=""
  local pos c o

  for (( pos=0 ; pos<strlen ; pos++ )); do
     c=${string:$pos:1}
     case "$c" in
         [-_.~a-zA-Z--0-9] ) o="${c}" ;;
	 [\[\]] ) o="|" ;;
	 ,* )               printf -v o '%%%02x' "'$c"
     esac
     encoded+="${o}"
  done
  echo "${encoded}"    # You can either set a return variable (FASTER) 
  REPLY="${encoded}"   #+or echo the result (EASIER)... or both... :p
}

# Returns a string in which the sequences with percent (%) signs followed by
# two hex digits have been replaced with literal characters.
rawurldecode() {

  # This is perhaps a risky gambit, but since all escape characters must be
  # encoded, we can replace %NN with \xNN and pass the lot to printf -b, which
  # will decode hex for us

  printf -v REPLY '%b' "${1//%/\\x}" # You can either set a return variable (FASTER)

#  echo "${REPLY}"  #+or echo the result (EASIER)... or both... :p
}


# Initialize all the option variables.
# This ensures we are not contaminated by variables from the environment.
TEMPLATE="b"
FORCE=""

while :; do
    case $1 in
	--force)       # Takes an option argument; ensure it has been specified.
	    FORCE="t"
	    shift
            ;;
        --silent)
	    TEMPLATE="B"
            shift
            ;;
        --rss)
            TEMPLATE="r"
            shift
            ;;
        ,*)
            break
    esac
    shift 
done 
 
rawurlencode "$QUTE_URL"
# QUTE_URL=$(echo $QUTE_URL | sed -r 's/^[^/]+//')
URL="$REPLY"
# URL="$QUTE_URL"
# rawurlencode "$QUTE_TITLE"
# TITLE="$REPLY"
TITLE="$(echo $QUTE_TITLE | sed -r 's/&//g')"
# rawurlencode "$QUTE_SELECTED_TEXT"
# # SELECTED_TEXT="$REPLY"
SELECTED_TEXT="$QUTE_SELECTED_TEXT"
#emacsclient "org-protocol://capture://b/$URL/$TITLE/$SELECTED_TEXT" && echo "jseval \"Bookmark saved to TODO.org/Inbox\"" >> "$QUTE_FIFO" || echo "jseval \"Bookmark not saved!\"" >> "$QUTE_FIFO"

# CHECK="$(org-check-bookmark.sh "$QUTE_URL")"

# echo "message-warning \"org-protocol://capture?template=b&url=$URL&title=$TITLE&body=$SELECTED_TEXT"\"  >> "$QUTE_FIFO"
# if [[ "$CHECK" == "ok" || "$FORCE" == "t" ]]; then 
# (emacsclient "org-protocol://capture?template=$TEMPLATE&url=$URL&title=$TITLE&body=$SELECTED_TEXT&html=$QUTE_HTML&qutebrowser-fifo=$QUTE_FIFO"\
    #      && echo "message-info '$(cat ~/Org/inbox.org | grep \* | tail -n1)'" >> "$QUTE_FIFO" || echo "message-error \"Bookmark not saved!\"" >> "$QUTE_FIFO");
emacsclient "org-protocol://capture?template=$TEMPLATE&url=$URL&title=$TITLE&body=$SELECTED_TEXT&html=$QUTE_HTML&qutebrowser-fifo=$QUTE_FIFO" && true;
# else
#     echo -e "message-warning \"$CHECK\"" >> "$QUTE_FIFO"
# fi
# grep "$QUTE_URL" ~/Org/TODO.org* ~/Org/inbox.org ~/Org/notes.org* >/dev/null && (echo "message-warning \"Url is already in TODO.org*\"" >> "$QUTE_FIFO") ||\
    #     (emacsclient "org-protocol://capture?template=b&url=$URL&title=$TITLE&body=$SELECTED_TEXT"\
    # 	 && echo "message-info \"Bookmark saved to inbox.org/Inbox\"" >> "$QUTE_FIFO" || echo "message-error \"Bookmark not saved!\"" >> "$QUTE_FIFO")
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/share/qutebrowser/userscripts/org-protocol-add-bookmark-force.sh :mkdirp yes :shebang #!/bin/bash
org-protocol-add-bookmark.sh --force
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/share/qutebrowser/userscripts/org-protocol-save-selection.sh :mkdirp yes :shebang #!/bin/bash
rawurlencode() {
    local string="${1}"
    local strlen=${#string}
    local encoded=""
    local pos c o

    for (( pos=0 ; pos<strlen ; pos++ )); do
	c=${string:$pos:1}
	case "$c" in
            [-_.~a-zA-Z--0-9] ) o="${c}" ;;
	    [\[\]] ) o="|" ;;
            * )               printf -v o '%%%02x' "'$c"
	esac
	encoded+="${o}"
    done
    echo "${encoded}"    # You can either set a return variable (FASTER) 
    REPLY="${encoded}"   #+or echo the result (EASIER)... or both... :p
}

# Returns a string in which the sequences with percent (%) signs followed by
# two hex digits have been replaced with literal characters.
rawurldecode() {

    # This is perhaps a risky gambit, but since all escape characters must be
    # encoded, we can replace %NN with \xNN and pass the lot to printf -b, which
    # will decode hex for us

    printf -v REPLY '%b' "${1//%/\\x}" # You can either set a return variable (FASTER)

    #  echo "${REPLY}"  #+or echo the result (EASIER)... or both... :p
}

rawurlencode "$QUTE_URL"
URL="$REPLY"
rawurlencode "$QUTE_TITLE"
TITLE="$REPLY"
rawurlencode "$QUTE_SELECTED_TEXT"
SELECTED_TEXT="$REPLY"
#emacsclient "org-protocol://capture://b/$URL/$TITLE/$SELECTED_TEXT" && echo "jseval \"Bookmark saved to TODO.org/Inbox\"" >> "$QUTE_FIFO" || echo "jseval \"Bookmark not saved!\"" >> "$QUTE_FIFO"
emacsclient "org-protocol://capture?template=s&url=$URL&title=$TITLE&body=$SELECTED_TEXT" && echo "message-info \"Selection saved to TODO.org/Inbox\"" >> "$QUTE_FIFO" || echo "message-error \"Selection not saved!\"" >> "$QUTE_FIFO"
#+end_src

**** COMMENT Redirect from tracking websites (youtube, reddit, twitter, etc) to open-source alternatives
:PROPERTIES:
:ID:       e9b2c5c0-e8b2-4f50-80f3-ce712b99730d
:END:

This script filters known unwanted websites to open-source ones.
Unknown URLs remain unchanged.

Credit: [[id:bdff0bde-b888-4b79-b903-375aff3e6f76][#email Andr Souza Abreu <notifications@github.com> [qutebrowser/qutebrowser] Sharing a qutebrowser script to convert urls from youtube, reddit, twitter, etc to their open-source frontends (invidious, teddit, nitter) (#6555)]]

#+begin_src python :tangle /home/yantar92/.config/qutebrowser/userscripts/untrack-url :mkdirp yes :shebang #!/usr/bin/python
import subprocess
import random
import sys
import os

DEST_DOMAINS = {
  "nitter": [
    "nitter.net",
    "nitter.42l.fr",
    "nitter.pussthecat.org",
    "nitter.nixnet.services",
    "nitter.fdn.fr",
    "nitter.1d4.us",
    "nitter.kavin.rocks",
    "nitter.vxempire.xyz",
    "nitter.unixfox.eu",
    "nitter.domain.glass",
    "nitter.eu",
    "nitter.ethibox.fr",
    "nitter.namazso.eu",
    "nitter.mailstation.de",
    "nitter.actionsack.com",
    "nitter.cattube.org",
    "nitter.40two.app",
    "nitter.skrep.in",
    "nitter.hu",
    "nitter.database.red",
    "nitter.exonip.de",
    "nitter.dark.fail",
    "nitter.moomoo.me",
    "nitter.ortion.xyz",
  ],
  "invidious": [
    "piped.kavin.rocks",
  ],
  "teddit": [
    "teddit.net",
    "teddit.zaggy.nl",
    "teddit.namazso.eu",
  ],
  "bibliogram": [
    "bibliogram.art",
    "bibliogram.snopyta.org",
    "bibliogram.pussthecat.org",
    "bibliogram.nixnet.services",
    "bibliogram.ethibox.fr",
    "insta.trom.tf",
    "bibliogram.hamster.dance",
    "bib.actionsack.com",
  ],
  "openstreetmap": [
    "www.openstreetmap.org",
  ]
}

SRC_DOMAINS = {
  "youtube": [
    "www.youtube.com",
    "m.youtube.com",
    "youtube.com",
    "youtu.be",
  ],
  "twitter" : [
    "mobile.twitter.com",
    "twitter.com",
  ],
  "instagram": [
    "www.instagram.com",
    "instagram.com",
  ],
  "reddit": [
    "www.reddit.com",
    "reddit.com",
  ],
  "googlemaps": [
    "maps.google.com",
  ]
}

SRC_TO_DEST = {
  "googlemaps": "openstreetmaps",
  "instagram": "bibliogram",
  "reddit": "teddit",
  "twitter": "nitter",
  "youtube": "invidious",
}

DEST_TO_SRC = {
  dest: src for src,dest in SRC_TO_DEST.items()
}

ROFI_CMD = "rofi -dmenu -p 'Pick up a instance' -location 2"
DMENU_CMD = "dmenu"

def src2dest(src):
  return SRC_TO_DEST[src]

def dest2src(dest):
  return DEST_TO_SRC[dest]

def get_dest_type(url):
  for src in SRC_TO_DEST:
    for domain in SRC_DOMAINS[src]:
      if domain in url:
        return src2dest(src)
  return ""

def get_untracked_url(url, dest_domain, dest_type):
  src_type = dest2src(dest_type)
  src_domains = SRC_DOMAINS[src_type]
  for domain in src_domains:
    if domain in url:
      return url.replace(domain, dest_domain)
  return ""

def get_dest_instances(dest_type):
  return DEST_DOMAINS[dest_type]

def pick_instance_from_user_selection(instances, cmd_menu):
  text = "\n".join(instances)
  cmd = f'echo -e "{text}" | {cmd_menu}'
  return subprocess.getoutput(cmd)

def pick_default_instance(instances):
  return instances[0]

def pick_random_instance(instances):
  return random.choices(instances)[0]

def pick_instance(instances, choice, cmd):
  if (choice == "user"):
    return pick_instance_from_user_selection(instances, cmd)
  if (choice == "random"):
    return pick_random_instance(instances)
  return pick_default_instance(instances)

def send_command(qute_command, untracked_url):
  QUTE_FIFO = os.environ['QUTE_FIFO']
  with open(QUTE_FIFO, 'a') as qute_fifo:
    qute_command = f"{qute_command} {untracked_url}"
    qute_fifo.write(qute_command)

def main(args):
  url = ""
  choice = "default"
  qute_command = "open"
  cmd = ROFI_CMD
  while (len(args) > 0):
    v = args[0]
    args.pop(0)
    if v == "-o":
      qute_command = "open"
    if v == "-b":
      qute_command = "open -b"
    elif v == "-O":
      qute_command = "open -t"
    elif v == "-y":
      qute_command = "yank"
    elif v == "-Y":
      qute_command = "yank-primary"
    elif v == "-r":
      choice = "random"
    elif v == "-p":
      choice = "user"
    elif v == "-d":
      choice = "user"
      cmd = DMENU_CMD
    elif v == "-R":
      choice = "user"
      cmd = ROFI_CMD
    else:
      url = v
  # validate stuff
  if (url == ""):
    exit(1)
  dest_type = get_dest_type(url)
  if (dest_type == ""):
    send_command(qute_command, url)
    exit(0)
  instances = get_dest_instances(dest_type)
  instance = pick_instance(instances, choice, cmd)
  untracked_url = get_untracked_url(url, instance, dest_type)
  send_command(qute_command, untracked_url)

args = sys.argv
args.pop(0) # first arg is the script's file name
main(args)
#+end_src

*** JS (greasemonkey) scripts
**** Force old reddit design
:PROPERTIES:
:ID:       2c18aa4c-c9b8-4c1a-b4e2-15fac23473ef
:END:

Credit: https://openuserjs.org/meta/101743/Old_Reddit.meta.js

#+begin_src js :tangle /home/yantar92/.local/share/qutebrowser/greasemonkey/old-reddit.js :mkdirp t
// ==UserScript==
// @name         Old Reddit
// @description  Force old.reddit.com regardless of signed-in status
// @author       /u/101743
// @version      1.0.1
// @match        http://*.reddit.com/*
// @match        https://*.reddit.com/*
// @license      GPL-2.0-or-later
// @updateURL    https://openuserjs.org/meta/101743/Old_Reddit.meta.js
// @icon         https://image.ibb.co/jaCbRp/icons8_reddit_52.png
// @run-at       document-start
// ==/UserScript==

var url = window.location.host;

if (url.match("old.reddit.com") === null) {
    url = window.location.href;
    if  (url.match("//www.reddit") !== null){
        url = url.replace("//www.reddit", "//old.reddit");
    } else {
    	return;
    }
    //console.log(url);
    window.location.replace(url);
}
#+end_src
**** COMMENT Redirect twitter to free frontend nitter
:PROPERTIES:
:ID:       7bbcf094-8b48-4e42-9b4e-91b10e3ed9b1
:END:

#+begin_src js :tangle /home/yantar92/.local/share/qutebrowser/greasemonkey/twitter-nitter.js :mkdirp t
// ==UserScript==
// @name         Twitter -> Nitter
// @description  Redirect twitter to nitter
// @author       yantar92
// @version      1.0.0
// @match        http://twitter.com/*
// @match        https://twitter.com/*
// @license      GPL-2.0-or-later
// @run-at       document-start
// ==/UserScript==

var url = window.location.host;

url = window.location.href;
url = url.replace("twitter.com", "nitter.net");
//console.log(url);
window.location.replace(url);
#+end_src


**** Hide ad popup in =nytimes.com=
:PROPERTIES:
:ID:       50c7c79a-50c7-4056-b608-e449daaf070d
:END:

#+begin_src js :tangle /home/yantar92/.config/qutebrowser/greasemonkey/nytimes.js :mkdirp t
function hidepopup() {
    if (window.location.host == 'www.nytimes.com' ) {
	var adPopup = document.getElementsByClassName('MAG_web_all_Monthly-Sale-dock')[0];
	if (adPopup) {
	    adPopup.parentNode.removeChild(adPopup);
	}}
};

window.addEventListener(
    'load',
    function() {window.setTimeout(hidepopup, 800)},
    true)
#+end_src

*** Quickmarks
:PROPERTIES:
:ID:       9cf18c4a-6af3-4c55-b10c-d4624aff0971
:END:

Custom high-priority bookmarks

#+begin_src conf :tangle /home/yantar92/.config/qutebrowser/quickmarks
RSSHub http://127.0.0.1:1200/
#+end_src

*** Configuration
:PROPERTIES:
:header-args:python+: :tangle /home/yantar92/.config/qutebrowser/config.py :mkdirp yes
:END:

**** Load interactively set preferences
:PROPERTIES:
:ID:       9e2c058e-42f0-4feb-b82e-87ed6b481e1c
:END:
#+begin_src python
# Uncomment this to still load settings configured via autoconfig.yml
config.load_autoconfig()
#+END_SRC

**** Ad-blocker
:PROPERTIES:
:ID:       20533172-0454-4355-8554-2853b54e4ff5
:END:
#+BEGIN_SRC python  
# Block Youtube advertisement
# Credit: https://gist.github.com/Gavinok/f9c310a66576dc00329dd7bef2b122a1
from qutebrowser.api import interceptor

"""
qutebrowser settings for video
for more settings check out
https://qutebrowser.org/doc/help/settings.html
"""

# ================== Youtube Add Blocking ======================= {{{
def filter_yt(info: interceptor.Request):
    """Block the given request if necessary."""
    url = info.request_url
    if (
        url.host() == "www.youtube.com"
        and url.path() == "/get_video_info"
        and "&adformat=" in url.query()
    ):
        info.block()


interceptor.register(filter_yt)
#+END_SRC
#+END_SRC

**** Do not open new links in separate frames
:PROPERTIES:
:ID:       dd8ddf7e-ea93-43ca-89b9-ad1567a957c5
:END:

#+begin_src python
c.new_instance_open_target="tab"
c.tabs.tabs_are_windows=False
#+end_src

**** Default page
:PROPERTIES:
:ID:       90155335-0237-44ce-8407-2d683e154c17
:END:
#+BEGIN_SRC python  
c.url.default_page = 'http://127.0.0.1:8384/'
c.url.start_pages = 'http://127.0.0.1:8384/'
#+END_SRC
**** Session
:PROPERTIES:
:ID:       d491d178-efc8-4a6d-a638-64c257cefaf1
:END:

#+BEGIN_SRC python  
# Always restore open sites when qutebrowser is reopened.
# Type: Bool
c.auto_save.session = False
#+END_SRC

**** Security
:PROPERTIES:
:ID:       ec1e0ce8-6da9-4779-b3be-db9d4c6bc9f6
:END:
#+BEGIN_SRC python  
# Automatically start playing `<video>` elements. Note: On Qt < 5.11,
# this option needs a restart and does not support URL patterns.
# Type: Bool
c.content.autoplay = False

# Allow websites to read canvas elements. Note this is needed for some
# websites to work properly.
# Type: Bool
c.content.canvas_reading = True
# True is required for youtube player to work

c.content.headers.accept_language="en-US,en;q=0.5"
c.content.headers.custom={"accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}

# Which cookies to accept. With QtWebEngine, this setting also controls
# other features with tracking capabilities similar to those of cookies;
# including IndexedDB, DOM storage, filesystem API, service workers, and
# AppCache. Note that with QtWebKit, only `all` and `never` are
# supported as per-domain values. Setting `no-3rdparty` or `no-
# unknown-3rdparty` per-domain on QtWebKit will have the same effect as
# `all`.
# Type: String
# Valid values:
#   - all: Accept all cookies.
#   - no-3rdparty: Accept cookies from the same origin only. This is known to break some sites, such as GMail.
#   - no-unknown-3rdparty: Accept cookies from the same origin only, unless a cookie is already set for the domain. On QtWebEngine, this is the same as no-3rdparty.
#   - never: Don't accept cookies at all.
c.content.cookies.accept = 'all'

# Which cookies to accept. With QtWebEngine, this setting also controls
# other features with tracking capabilities similar to those of cookies;
# including IndexedDB, DOM storage, filesystem API, service workers, and
# AppCache. Note that with QtWebKit, only `all` and `never` are
# supported as per-domain values. Setting `no-3rdparty` or `no-
# unknown-3rdparty` per-domain on QtWebKit will have the same effect as
# `all`.
# Type: String
# Valid values:
#   - all: Accept all cookies.
#   - no-3rdparty: Accept cookies from the same origin only. This is known to break some sites, such as GMail.
#   - no-unknown-3rdparty: Accept cookies from the same origin only, unless a cookie is already set for the domain. On QtWebEngine, this is the same as no-3rdparty.
#   - never: Don't accept cookies at all.
config.set('content.cookies.accept', 'all', 'chrome-devtools://*')

config.set('content.cookies.accept', 'all', 'https://127.0.0.1/*')
config.set('content.cookies.accept', 'all', 'https://*.ylab.cn/*')
config.set('content.cookies.accept', 'all', 'https://*.wechat.com/*')
config.set('content.cookies.accept', 'all', 'https://*.microsoftonline.com/*')
config.set('content.cookies.accept', 'all', 'https://*.office.com/*')
config.set('content.cookies.accept', 'all', 'https://*.amazon.cn/*')
config.set('content.cookies.accept', 'all', 'https://*.amazon.com/*')
config.set('content.cookies.accept', 'all', 'https://*.rutracker.org/*')
config.set('content.cookies.accept', 'all', 'https://*.chess.com/*')
config.set('content.cookies.accept', 'all', 'https://*.facebook.com/*')
config.set('content.cookies.accept', 'all', 'https://*.reddit.com/*')
config.set('content.cookies.accept', 'all', 'https://*.author.today/*')
config.set('content.cookies.accept', 'all', 'https://*.ficbook.net/*')
config.set('content.cookies.accept', 'all', 'https://*.github.com/*')
config.set('content.cookies.accept', 'all', 'https://*.gitlab.com/*')
config.set('content.cookies.accept', 'all', 'https://*.baidu.com/*')
config.set('content.cookies.accept', 'all', 'https://*.weibo.com/*')
config.set('content.cookies.accept', 'all', 'https://*.bilibili.com/*')
config.set('content.cookies.accept', 'all', 'https://*.google.com/*')
config.set('content.cookies.accept', 'all', 'https://*.google.com.sg/*')
config.set('content.cookies.accept', 'all', 'https://*.youtube.com/*')
config.set('content.cookies.accept', 'all', 'https://youtube.com/*')
config.set('content.cookies.accept', 'all', 'https://scholar.google.com/*')
config.set('content.cookies.accept', 'all', 'https://*.chrono.gg/*')
config.set('content.cookies.accept', 'all', 'https://*.paypal.com/*')
config.set('content.cookies.accept', 'all', 'https://*.acs.org/*')
config.set('content.cookies.accept', 'all', 'https://*.scitation.org/*')
config.set('content.cookies.accept', 'all', 'https://*.tandfonline.com/*')
config.set('content.cookies.accept', 'all', 'https://*.wiley.com/*')
config.set('content.cookies.accept', 'all', 'https://*.owncube.com/*')
config.set('content.cookies.accept', 'all', 'https://*.linkedin.com/*')

# Which cookies to accept. With QtWebEngine, this setting also controls
# other features with tracking capabilities similar to those of cookies;
# including IndexedDB, DOM storage, filesystem API, service workers, and
# AppCache. Note that with QtWebKit, only `all` and `never` are
# supported as per-domain values. Setting `no-3rdparty` or `no-
# unknown-3rdparty` per-domain on QtWebKit will have the same effect as
# `all`.
# Type: String
# Valid values:
#   - all: Accept all cookies.
#   - no-3rdparty: Accept cookies from the same origin only. This is known to break some sites, such as GMail.
#   - no-unknown-3rdparty: Accept cookies from the same origin only, unless a cookie is already set for the domain. On QtWebEngine, this is the same as no-3rdparty.
#   - never: Don't accept cookies at all.
config.set('content.cookies.accept', 'all', 'devtools://*')

# Store cookies. Note this option needs a restart with QtWebEngine on Qt
# < 5.9.
# Type: Bool
c.content.cookies.store = True

# Which cookies to accept. With QtWebEngine, this setting also controls
# other features with tracking capabilities similar to those of cookies;
# including IndexedDB, DOM storage, filesystem API, service workers, and
# AppCache. Note that with QtWebKit, only `all` and `never` are
# supported as per-domain values. Setting `no-3rdparty` or `no-
# unknown-3rdparty` per-domain on QtWebKit will have the same effect as
# `all`.
# Type: String
# Valid values:
#   - all: Accept all cookies.
#   - no-3rdparty: Accept cookies from the same origin only. This is known to break some sites, such as GMail.
#   - no-unknown-3rdparty: Accept cookies from the same origin only, unless a cookie is already set for the domain. On QtWebEngine, this is the same as no-3rdparty.
#   - never: Don't accept cookies at all.
config.set('content.cookies.accept', 'all', 'chrome-devtools://*')

# Which cookies to accept. With QtWebEngine, this setting also controls
# other features with tracking capabilities similar to those of cookies;
# including IndexedDB, DOM storage, filesystem API, service workers, and
# AppCache. Note that with QtWebKit, only `all` and `never` are
# supported as per-domain values. Setting `no-3rdparty` or `no-
# unknown-3rdparty` per-domain on QtWebKit will have the same effect as
# `all`.
# Type: String
# Valid values:
#   - all: Accept all cookies.
#   - no-3rdparty: Accept cookies from the same origin only. This is known to break some sites, such as GMail.
#   - no-unknown-3rdparty: Accept cookies from the same origin only, unless a cookie is already set for the domain. On QtWebEngine, this is the same as no-3rdparty.
#   - never: Don't accept cookies at all.
config.set('content.cookies.accept', 'all', 'devtools://*')

# Try to pre-fetch DNS entries to speed up browsing.
# Type: Bool
c.content.dns_prefetch = True



# Load images automatically in web pages.
# Type: Bool
config.set('content.images', True, 'chrome-devtools://*')

# Load images automatically in web pages.
# Type: Bool
config.set('content.images', True, 'devtools://*')

# Enable JavaScript.
# Type: Bool
c.content.javascript.enabled = True

config.set('content.javascript.enabled', True, 'https://*.amazon.cn/*')
config.set('content.javascript.enabled', True, 'https://*.amazon.com/*')
config.set('content.javascript.enabled', True, 'https://*.rutracker.org/*')
config.set('content.javascript.enabled', True, 'https://*.facebook.com/*')
config.set('content.javascript.enabled', True, 'https://fanyi.baidu.com/*')
config.set('content.javascript.enabled', True, 'https://*.bilibili.com/*')
config.set('content.javascript.enabled', True, 'https://www.fedex.com/*')
config.set('content.javascript.enabled', True, 'http://campnano.xjtu.ylab.cn/*')
config.set('content.javascript.enabled', True, 'https://www.humblebundle.com/*')
config.set('content.javascript.enabled', True, 'https://torguard.net/*')
config.set('content.javascript.enabled', True, 'https://mail.google.com/*')
config.set('content.javascript.enabled', True, 'https://docs.google.com/*')
config.set('content.javascript.enabled', True, 'https://scholar.google.com.sg/*')
config.set('content.javascript.enabled', True, 'https://duckduckgo.com/*')
config.set('content.javascript.enabled', True, 'https://author.today/*')
config.set('content.javascript.enabled', True, 'https://www.chess.com/*')
config.set('content.javascript.enabled', True, 'https://www.sciencedirect.com/*')
config.set('content.javascript.enabled', True, 'https://reader.elsevier.com/*')
config.set('content.javascript.enabled', True, 'https://*.ficbook.net/*')
config.set('content.javascript.enabled', True, 'https://www.dropbox.com/*')
config.set('content.javascript.enabled', True, 'https://www.researchgate.net/*')
config.set('content.javascript.enabled', True, 'https://litnet.com/*')
config.set('content.javascript.enabled', True, 'https://*.reddit.com/*')
config.set('content.javascript.enabled', True, 'https://mail.humblebundle.com/*')
config.set('content.javascript.enabled', True, 'https://*.dbs.com.sg/*')
config.set('content.javascript.enabled', True, 'https://www.paypal.com/*')
config.set('content.javascript.enabled', True, 'https://*.steampowered.com/*')
config.set('content.javascript.enabled', True, 'https://www.alibaba.com/*')
config.set('content.javascript.enabled', True, 'https://*.office.com/*')
config.set('content.javascript.enabled', True, 'https://*.microsoftonline.com/*')
config.set('content.javascript.enabled', True, 'https://*.mfa.gov.ua/*')
config.set('content.javascript.enabled', True, 'http://www.china-embassy.org/*')
config.set('content.javascript.enabled', True, 'https://*.sutd.edu.sg/*')
config.set('content.javascript.enabled', True, 'https://sutd.edu.sg/*')
config.set('content.javascript.enabled', True, 'https://*.grammarly.com/*')
config.set('content.javascript.enabled', True, 'https://calendly.com/*')
config.set('content.javascript.enabled', True, 'https://web.whatsapp.com/*')
config.set('content.javascript.enabled', True, 'https://www.linuxcounter.net/*')
config.set('content.javascript.enabled', True, 'http://www.editorialmanager.com/*')
config.set('content.javascript.enabled', True, 'https://www.editorialmanager.com/*')
config.set('content.javascript.enabled', True, 'https://orcid.org/*')
config.set('content.javascript.enabled', True, 'https://webshop.elsevier.com/*')
config.set('content.javascript.enabled', True, 'https://*.ica.gov.sg/*')
config.set('content.javascript.enabled', True, 'https://*.esplanade.com/*')
config.set('content.javascript.enabled', True, 'https://www.tripadvisor.com.sg/*')
config.set('content.javascript.enabled', True, 'https://www.last.fm/*')
config.set('content.javascript.enabled', True, 'https://www.twitch.tv/*')
config.set('content.javascript.enabled', True, 'https://emploi.epfl.ch/*')
config.set('content.javascript.enabled', True, 'https://www.sharelatex.com/*')
config.set('content.javascript.enabled', True, 'https://v2.overleaf.com/*')
config.set('content.javascript.enabled', True, 'https://*.express.dhl')
config.set('content.javascript.enabled', True, 'https://gitlab.com')
config.set('content.javascript.enabled', True, 'https://*.edx.org/*')
config.set('content.javascript.enabled', True, 'https://courses.edx.org/*')
config.set('content.javascript.enabled', True, 'https://edx.org')
config.set('content.javascript.enabled', True, 'https://*.patreon.com')
config.set('content.javascript.enabled', True, 'https://*.aps.org')
config.set('content.javascript.enabled', True, 'https://*.acs.org')
config.set('content.javascript.enabled', True, 'https://www.lesswrong.com')
config.set('content.javascript.enabled', True, 'https://www.skyscanner.com.sg/*')
config.set('content.javascript.enabled', True, 'https://*.booking.com')
config.set('content.javascript.enabled', True, 'https://*.fun-mooc.fr/*')
config.set('content.javascript.enabled', True, 'https://web.wechat.com/*')
config.set('content.javascript.enabled', True, 'https://www.skyscanner.net/*')
config.set('content.javascript.enabled', True, 'https://*.flyscoot.com/*')
config.set('content.javascript.enabled', True, 'https://*.chrono.gg/*')
config.set('content.javascript.enabled', True, 'https://*.owncube.com/*')
config.set('content.javascript.enabled', True, '*://*.learngitbranching.js.org/*')
config.set('content.javascript.enabled', True, '*://*.melpa.org/*')
config.set('content.javascript.enabled', True, '*://*.youtube.com/*')


# Enable JavaScript.
# Type: Bool
config.set('content.javascript.enabled', True, 'chrome-devtools://*')

# Enable JavaScript.
# Type: Bool
config.set('content.javascript.enabled', True, 'devtools://*')

# Enable JavaScript.
# Type: Bool
config.set('content.javascript.enabled', True, 'chrome://*/*')

# Enable JavaScript.
# Type: Bool
config.set('content.javascript.enabled', True, 'qute://*/*')

# Enable support for HTML 5 local storage and Web SQL.
# Type: Bool
c.content.local_storage = True

config.set('content.local_storage', True, 'https://*.ylab.cn/*')
config.set('content.local_storage', True, 'https://*.ficbook.net/*')
config.set('content.local_storage', True, 'https://*.author.today/*')
config.set('content.local_storage', True, 'https://fanyi.baidu.com/*')
config.set('content.local_storage', True, 'https://*.bilibili.com/*')
config.set('content.local_storage', True, 'https://*.chrono.gg/*')
config.set('content.local_storage', True, 'https://*.reddit.com/*')
config.set('content.local_storage', True, 'https://*.wechat.com/*')
config.set('content.local_storage', True, 'https://*.owncube.com/*')

# Enable WebGL.
# Type: Bool
c.content.webgl = False

# Monitor load requests for cross-site scripting attempts. Suspicious
# scripts will be blocked and reported in the inspector's JavaScript
# console. Note that bypasses for the XSS auditor are widely known and
# it can be abused for cross-site info leaks in some scenarios, see:
# https://www.chromium.org/developers/design-documents/xss-auditor
# Type: Bool
c.content.xss_auditing = True

#+END_SRC

**** User agent
:PROPERTIES:
:ID:       7c8ecad8-c9e8-40be-a99a-941db0447948
:END:
#+BEGIN_SRC python  

# User agent to send.  The following placeholders are defined:  *
# `{os_info}`: Something like "X11; Linux x86_64". * `{webkit_version}`:
# The underlying WebKit version (set to a fixed value   with
# QtWebEngine). * `{qt_key}`: "Qt" for QtWebKit, "QtWebEngine" for
# QtWebEngine. * `{qt_version}`: The underlying Qt version. *
# `{upstream_browser_key}`: "Version" for QtWebKit, "Chrome" for
# QtWebEngine. * `{upstream_browser_version}`: The corresponding
# Safari/Chrome version. * `{qutebrowser_version}`: The currently
# running qutebrowser version.  The default value is equal to the
# unchanged user agent of QtWebKit/QtWebEngine.  Note that the value
# read from JavaScript is always the global value.
# Type: FormatString

# config.set('content.headers.user_agent', 'Mozilla/5.0 ({os_info}) AppleWebKit/{webkit_version} (KHTML, like Gecko) {upstream_browser_key}/{upstream_browser_version} Safari/{webkit_version}', 'https://web.whatsapp.com/')
# config.set('content.headers.user_agent', 'Mozilla/5.0 ({os_info}; rv:71.0) Gecko/20100101 Firefox/71.0', 'https://accounts.google.com/*')
# config.set('content.headers.user_agent', 'Mozilla/5.0 ({os_info}) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99 Safari/537.36', 'https://*.slack.com/*')
# config.set('content.headers.user_agent', 'Mozilla/5.0 ({os_info}; rv:71.0) Gecko/20100101 Firefox/71.0', 'https://docs.google.com/*')

# config.set('content.headers.user_agent', 'Mozilla/5.0 ({os_info}; rv:71.0) Gecko/20100101 Firefox/71.0')
#+END_SRC

**** Custom host blocking
:PROPERTIES:
:ID:       627af6b5-6351-47ea-81f5-4b4d861bc046
:END:

Note that I need to set blocking method to "both" when using [[id:178b2a3c-979d-462e-8697-f4c191f6ec06][adblock]].

#+begin_src python
c.content.blocking.hosts.lists = ["https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts", "file:///home/yantar92/.config/qutebrowser/blocked-hosts"]
c.content.blocking.method = "both"
c.content.blocking.adblock.lists = ['https://easylist.to/easylist/easylist.txt', 'https://secure.fanboy.co.nz/fanboy-cookiemonster.txt']
#+end_src

**** Completion and history
:PROPERTIES:
:ID:       71a2fe05-5af9-4d19-a822-07e75dc2faf1
:END:
#+BEGIN_SRC python  

# Number of commands to save in the command history. 0: no history / -1:
# unlimited
# Type: Int
c.completion.cmd_history_max_items = -1

# Height (in pixels or as percentage of the window) of the completion.
# Type: PercOrInt
c.completion.height = '30%'

# Number of URLs to show in the web history. 0: no history / -1:
# unlimited
# Type: Int
c.completion.web_history.max_items = 20000
#+END_SRC

**** Command loop
:PROPERTIES:
:ID:       9557b045-b46f-41de-abe3-a11790620cb0
:END:

#+BEGIN_SRC python  
# Default program used to open downloads. If null, the default internal
# handler is used. Any `{}` in the string will be expanded to the
# filename, else the filename will be appended.
# Type: String
c.downloads.open_dispatcher = 'xdg-open {}'
#+END_SRC

#+BEGIN_SRC python  

# Editor (and arguments) to use for the `open-editor` command. The
# following placeholders are defined:  * `{file}`: Filename of the file
# to be edited. * `{line}`: Line in which the caret is found in the
# text. * `{column}`: Column in which the caret is found in the text. *
# `{line0}`: Same as `{line}`, but starting from index 0. * `{column0}`:
# Same as `{column}`, but starting from index 0.
# Type: ShellCommand
c.editor.command = ['emacsclient', '-c', '{}']

# Automatically enter insert mode if an editable element is focused
# after loading the page.
# Type: Bool
c.input.insert_mode.auto_load = False

# Leave insert mode if a non-editable element is clicked.
# Type: Bool
c.input.insert_mode.auto_leave = False

# Switch to insert mode when clicking flash and other plugins.
# Type: Bool
c.input.insert_mode.plugins = True

# Leave insert mode when starting a new page load. Patterns may be
# unreliable on this setting, and they may match the url you are
# navigating to, or the URL you are navigating from.
# Type: Bool
c.input.insert_mode.leave_on_load = False
#+END_SRC

**** Key bindings
:PROPERTIES:
:ID:       23465cfa-cee9-40f2-be52-1695bce7790f
:END:
#+BEGIN_SRC python  
# Translate russian keys to English bindings
# Source: https://www.reddit.com/r/qutebrowser/comments/h85sk6/hotkeys_and_different_alphabets/
c.bindings.key_mappings = {
    "<Ctrl-6>": "<Ctrl-^>",
    "<Ctrl-Enter>": "<Ctrl-Return>",
    "<Ctrl-I>": "<Tab>",
    "<Ctrl-J>": "<Return>",
    "<Ctrl-M>": "<Return>",
    "<Ctrl-[>": "<Escape>",
    "<Enter>": "<Return>",
    "<Shift-Enter>": "<Return>",
    "<Shift-Return>": "<Return>",
    '': 'Q', '': 'q',
    '': 'W', '': 'w',
    '': 'E', '': 'e',
    '': 'R', '': 'r',
    '': 'T', '': 't',
    '': 'Y', '': 'y',
    '': 'U', '': 'u',
    '': 'I', '': 'i',
    '': 'O', '': 'o',
    '': 'P', '': 'p',
    '': '{', '': '[',
    '': '}', '': ']',
    '': 'A', '': 'a',
    '': 'S', '': 's',
    '': 'D', '': 'd',
    '': 'F', '': 'f',
    '': 'G', '': 'g',
    '': 'H', '': 'h',
    '': 'J', '': 'j',
    '': 'K', '': 'k',
    '': 'L', '': 'l',
    '': ':', '': ';',
    '': '"', '': '\'',
    '': 'Z', '': 'z',
    '': 'X', '': "x",
    '': 'C', '': "c",
    '': 'V', '': "v",
    '': 'B', '': "b",
    '': 'N', '': "n",
    '': 'M', '': "m",
    '': '<', '': ",",
    '': '>', '': ".",
    }

# Bindings for normal mode
config.bind('d', 'tab-close')
config.bind('u', 'undo')
config.bind('r', 'reload')
config.bind('<', 'spawn --userscript org-protocol-add-bookmark.sh --silent')
config.bind('<Alt+l>', 'clear-keychain ;; search ;; fullscreen --leave')
config.bind('<Alt+>', 'clear-keychain ;; search ;; fullscreen --leave')
config.bind('<Ctrl+Shift+m>', 'bookmark-add')
config.bind('<Ctrl+g>', 'clear-keychain ;; search ;; fullscreen --leave')
config.bind('<Ctrl+i>', 'back')
config.bind('<Ctrl+m>', 'spawn --userscript org-protocol-add-bookmark.sh --rss')
config.bind('<Ctrl+o>', 'forward')
config.unbind('<Ctrl+x>')
config.bind('<Ctrl+>', 'clear-keychain ;; search ;; fullscreen --leave')
config.bind('<F3>', 'record-macro')
config.bind('<F4>', 'run-macro')
config.bind('<F5>', 'mode-enter set_mark')
config.bind('<F6>', 'mode-enter jump_mark')
config.bind('<Shift+>', 'scroll-page 0 -0.5')
config.bind('<Shift+>', 'tab-prev')
config.bind('<Shift+><Shift+>', 'spawn --userscript  mpv-qutebrowser.sh {url}')
config.bind('<Shift+><>', 'hint links spawn --userscript  mpv-qutebrowser.sh {hint-url}')
config.bind('<Shift+>', 'tab-next')
config.bind('<Shift+>', 'hint all tab')
config.bind('<>', 'scroll-page 0 0.5')
config.bind('<><>', 'hint all tab-bg')
config.bind('<>', 'scroll up')
config.bind('<><>', 'hint links spawn --userscript mpv-qutebrowser.sh {hint-url}')
config.bind('<>', 'scroll down')
config.bind('<>', 'set-cmd-text -s :open')
config.unbind('F')
config.bind('H', 'hint all tab')
config.bind('L', 'scroll-page 0 -0.5')
config.bind('M', 'spawn --userscript org-protocol-add-bookmark.sh')
config.bind('O', 'set-cmd-text -s :open -t')
config.bind('vO', 'spawn --userscript  mpv-qutebrowser.sh {url}')
config.bind('vd', 'set-cmd-text -s :download-open')
config.bind('vo', 'hint links spawn --userscript  mpv-qutebrowser.sh {hint-url}')
config.unbind('f')
config.bind('fM', 'spawn --userscript org-protocol-add-bookmark-force.sh')
config.bind('gL', 'open https://outline.com/{url}')
config.bind('h', 'hint')
config.bind(';b', 'hint all spawn -u untrack-url -b {hint-url}')
config.bind('<Alt+h>', 'hint all hover')
config.bind('l', 'scroll-page 0 0.5')
config.bind('o', 'set-cmd-text -s :open')
config.unbind('q')
config.unbind('v')
config.bind('vd', 'download-open')
config.bind('vi', 'mode-enter caret')
config.bind('vo', 'hint links spawn --userscript mpv-qutebrowser.sh {hint-url}')

config.bind(';D', 'hint all delete')

# Bindings for caret mode
config.bind('<Alt+l>', 'mode-leave', mode='caret')
config.bind('<Ctrl+g>', 'mode-leave', mode='caret')
config.bind('<Ctrl+>', 'mode-leave', mode='caret')
config.bind('D', 'yank selection', mode='caret')
config.bind('I', 'move-to-prev-word', mode='caret')
config.bind('O', 'move-to-next-word', mode='caret')
config.bind('P', 'scroll right', mode='caret')
config.bind('U', 'scroll left', mode='caret')
config.bind('[', 'move-to-start-of-prev-block', mode='caret')
config.bind(']', 'move-to-start-of-next-block', mode='caret')
config.bind('i', 'move-to-prev-char', mode='caret')
config.bind('n', 'reverse-selection', mode='caret')
config.bind('o', 'move-to-next-char', mode='caret')
config.bind('p', 'move-to-end-of-line', mode='caret')
config.bind('u', 'move-to-start-of-line', mode='caret')
config.bind('{', 'move-to-end-of-prev-block', mode='caret')
config.bind('}', 'move-to-end-of-next-block', mode='caret')

# Bindings for command mode
config.bind('<Alt+j>', 'completion-item-focus next', mode='command')
config.bind('<Alt+k>', 'completion-item-focus prev', mode='command')
config.bind('<Alt+l>', 'mode-leave', mode='command')
config.bind('<Ctrl+Alt+h>', 'rl-backward-kill-word', mode='command')
config.bind('<Ctrl+Shift+o>', 'completion-item-focus prev-category', mode='command')
config.bind('<Ctrl+g>', 'mode-leave', mode='command')
config.bind('<Ctrl+o>', 'completion-item-focus next-category', mode='command')
config.bind('<Ctrl+>', 'mode-leave', mode='command')

# Bindings for hint mode
config.bind('<Alt+l>', 'mode-leave', mode='hint')
config.bind('<Ctrl+g>', 'mode-leave', mode='hint')
config.bind('<Ctrl+>', 'mode-leave', mode='hint')


# Bindings for insert mode
config.bind('<Alt+l>', 'mode-leave', mode='insert')
config.bind('<Ctrl+Alt+h>', 'fake-key <Shift-Left> ;; fake-key <Backspace>', mode='insert')
config.bind('<Ctrl+g>', 'mode-leave', mode='insert')
config.bind('<Ctrl+h>', 'fake-key <Delete>', mode='insert')
config.bind('<Ctrl+y>', 'insert-text {clipboard}', mode='insert')
config.bind('<Ctrl+>', 'mode-leave', mode='insert')
config.bind('<Shift+Ins>', 'insert-text {primary}', mode='insert')

# Bindings for passthrough mode
config.bind('<Alt+l>', 'mode-leave', mode='passthrough')
config.bind('<Ctrl+g>', 'mode-leave', mode='passthrough')
config.bind('<Ctrl+y>', 'insert-text {clipboard}', mode='passthrough')
config.bind('<Ctrl+>', 'mode-leave', mode='passthrough')
config.bind('<Shift+Ins>', 'insert-text {primary}', mode='passthrough')

# Bindings for prompt mode
config.bind('<Alt+l>', 'mode-leave', mode='prompt')
config.bind('<Ctrl+Alt+h>', 'rl-backward-kill-word', mode='prompt')
config.bind('<Ctrl+d>', 'rl-delete-char', mode='prompt')
config.bind('<Ctrl+g>', 'mode-leave', mode='prompt')
config.bind('<Ctrl+>', 'mode-leave', mode='prompt')

# Bindings for register mode
config.bind('<Alt+l>', 'mode-leave', mode='register')
config.bind('<Ctrl+g>', 'mode-leave', mode='register')
config.bind('<Ctrl+>', 'mode-leave', mode='register')

#hyposes.is
config.bind('A', "jseval (function(){window.hypothesisConfig=function(){return{showHighlights:true,appType:'bookmarklet'};};var d=document,s=d.createElement('script');s.setAttribute('src','https://localhost:3001/hypothesis');d.body.appendChild(s)})();")

#+end_src
**** High DPI display
:PROPERTIES:
:ID:       75d08aa4-2e27-4f89-a5ec-544c63f93072
:END:

#+begin_src python
c.qt.highdpi = True
#+end_src

*** Bash script opening a new tab in qutebrowser depending on the url
:PROPERTIES:
:ID:       3d8b7947-d8c1-4462-9888-c5286a7b1f25
:END:

Use [[id:db6f9fac-dc50-4668-a0c4-e5ff185ec436][mpv]] for videos or [[id:269904a8-3bb6-4e9e-a385-2e2b2c980879][Archivebox]] for locally archived URLs.
The script uses scripts defined in [[id:269904a8-3bb6-4e9e-a385-2e2b2c980879][Archivebox]].

#+begin_src bash :tangle /home/yantar92/.local/bin/qutebrowser-call.sh :shebang #!/bin/bash
URL="$1"

case "$URL" in
    ,*ted.com/talks*|*bilibili.com*|*youtube.com*)
	mpv "$URL" && exit
	;;
esac

grep "$URL" ~/.data/web-mirror/sources/* >/dev/null 2>&1 &&\
    ARCHIVE_ID=$(grep "$URL" ~/.data/web-mirror/sources/* | cut -f1 -d: | cut -d- -f2 | cut -d/ -f3) &&\
    ARCHIVE_FILE=$(find ~/.data/web-mirror/archive/ | grep $ARCHIVE_ID | grep singlefile.html | tail -n1)

if [[ ! -z "$ARCHIVE_FILE" ]]; then
    URL="${ARCHIVE_FILE}"
fi

# # fi
# echo "local awful = require('awful'); local screen = awful.screen.focused(); local tag = screen.tags[2]  if tag then tag:view_only() end" | awesome-client

#from https://github.com/qutebrowser/qutebrowser/blob/master/scripts/open_url_in_instance.sh
_url="$URL"
_command=":later 4000 :jump-mark last-position"

qutebrowser "${_command}" ":spawn -u untrack-url -r -O ${_url}"

# emacsclient -c -e "(eaf-open-browser \"$URL\")"
#+end_src

*** Adblocking
:PROPERTIES:
:ID:       178b2a3c-979d-462e-8697-f4c191f6ec06
:END:

In Qutebrowser 2.0.0, there is better adblocking using python adblocking library [[notmuch:id:20210128104817.ljsjkjoxtp73e3k7@aragog.localdomain][Email from Florian Bruhin via qutebrowser-announce: [qutebrowser-announce] qutebrowser v2.0.0 released (with better adblocker)!]]

Need to install =dev-python/adblock= from =2xsaiko= overlay.

** Torbrowser
:PROPERTIES:
:ID:       a5d618f4-e304-4634-b900-4f467d34a93e
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-eselect/eselect-repository
#+end_src


Need to use =torbrowser= overlay
#+begin_src bash :tangle no :dir /sudo::/ :eval yes
eselect repository enable torbrowser
#+end_src

#+begin_src conf :tangle /sudo::/var/lib/portage/world
www-client/torbrowser-launcher
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.mask/torbrowser-repo
,*/*::torbrowser
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/torbrowser-launcher :mkdirp yes
www-client/torbrowser-launcher::torbrowser
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/torbrowser-launcher
www-client/torbrowser-launcher::torbrowser ~amd64
#+end_src

** Download manager (including torrent): Aria2
:PROPERTIES:
:ID:       4664c39d-c127-4fa9-ab4d-cd15717a1d7f
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-misc/aria2
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/aria2
net-misc/aria2 bittorrent
#+end_src

** Emacs 
:PROPERTIES:
:ID:       67aec8ba-86ff-4ef3-903a-d3f77e4bf450
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-editors/emacs
=app-editors/emacs-29.0.9999-r1
 =app-editors/emacs-28.2-r4
 =app-editors/emacs-27.2-r9
 =app-editors/emacs-26.3-r11
#+end_src

Use latest master 
#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/emacs
app-editors/emacs **
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/emacs  
app-editors/emacs cairo dbus dynamic-loading gif jpeg libxml2 png sound source svg tiff wide-int xft xwidgets harfbuzz json gui native-comp imagemagick
# required for pdf-tools
app-text/poppler cairo
#support webp
media-gfx/imagemagick jpeg tiff webp png svg xml wmf raw
#native-comp
sys-devel/gcc jit
#+end_src

Allow pdf->png conversion using imagemagick. Required for org-mode preview working properly.
[2023-01-10 Tue] Does not work - changes in sed??
#+begin_src bash :tangle no :dir /sudo::/etc/ImageMagick-7/ :eval no
sed -i  's|  <!-- <policy domain="module" rights="none" pattern="{PS,PDF,XPS}" /> -->|  <policy domain="module" rights="read|write" pattern="{PS,PDF,XPS}" />|' policy.xml
sed -i  's|<policy domain="coder" rights="none" pattern="PDF" />|<!-- <policy domain="coder" rights="none" pattern="PDF" /> -->|' policy.xml
#+end_src

Install mime handler for Emacs

#+begin_src conf :tangle /home/yantar92/.local/share/applications/emacsclient-local.desktop :mkdirp yes
[Desktop Entry]
Type=Application
Version=1.0
Name=Emacs Client
Exec=emacsclient -c %f
Icon=emacs-icon
Terminal=false
MimeType=text/css;text/english;text/html;text/plain;text/x-c;text/x-chdr;text/x-csrc;text/x-c++;text/x-c++hdr;text/x-c++src;text/x-java;text/x-makefile;text/x-moc;text/x-pascal;text/x-tcl;text/x-tex;application/x-shellscript;application/pdf;inode/directory;inode/mount-point;image/png;image/tiff;
#+end_src

Note: I need to update desktop database upon changing this file
#+begin_src bash :tangle no :dir /sudo::/ :eval yes
update-desktop-database ~/.local/share/applications
#+end_src

*** Required fonts
**** source code pro

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-fonts/source-code-pro
#+end_src

**** symbola
:PROPERTIES:
:ID:       8cd6a8c4-08bc-47aa-ab04-7ad76a181747
:END:

# Manually installed from https://dn-works.com/ufas/

#+begin_src bash :tangle no :dir /sudo::/ :results output
eselect repository enable guru
#+end_src

#+RESULTS:
: Adding guru to /etc/portage/repos.conf/eselect-repo.conf ...
: 1 repositories enabled

Do not enable any other packages from the overlay
#+begin_src conf :tangle /sudo::/etc/portage/package.mask/guru-repo
,*/*::guru
#+end_src
#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/sarasa-mono
media-fonts/symbola::guru
#+end_src

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-fonts/symbola
#+end_src

**** FontAwesome
:PROPERTIES:
:ID:       cc714fe3-1aa1-47ab-acea-8a1aa7721c04
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-fonts/fontawesome
#+end_src

**** Noto
:PROPERTIES:
:ID:       7d1ccc81-3e2f-4dc1-b143-de5778396d00
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-fonts/noto
#+end_src

**** Noto emoji, required to get colored emojis in Emacs
:PROPERTIES:
:ID:       2320f113-a4df-41b8-9c68-16b422e8fc0f
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-fonts/noto-emoji
#+end_src

**** Sarasa Gothic (for Russian monospaced text)
:PROPERTIES:
:ID:       27b7db4d-bb47-4aa0-8782-244a27d378a2
:END:

[[id:21f06900e232809e79ecdd07e0d84647f30e8975][be5invis [Github] Sarasa-Gothic: Sarasa Gothic /  /  /  /  ]]

#+begin_src bash :tangle no :dir /sudo::/ :results output
eselect repository enable gentoo-zh
#+end_src

#+RESULTS:
: Adding gentoo-zh to /etc/portage/repos.conf/eselect-repo.conf ...
: 1 repositories enabled

Do not enable any other packages from the overlay
#+begin_src conf :tangle /sudo::/etc/portage/package.mask/gentoo-zh-repo
,*/*::gentoo-zh
#+end_src
#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/sarasa-mono
media-fonts/sarasa-gothic::gentoo-zh
#+end_src

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-fonts/sarasa-gothic
#+end_src

**** =all-the-icons=

Need to run elisp:all-the-icons-install-fonts

*** Clocking management scripts 
:PROPERTIES:
:ID:       aecce8b6-734e-40de-b8c4-387f8151a7f4
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/org-clock-in-organization.sh :shebang #!/bin/bash
emacsclient -e "(yant/punch-in-organization)"
#+end_src
#+begin_src bash :tangle /home/yantar92/.local/bin/org-clock-in-bookmarks.sh :shebang #!/bin/bash
emacsclient -e "(yant/punch-in-home)"
#+end_src
#+begin_src bash :tangle /home/yantar92/.local/bin/org-clock-out.sh :shebang #!/bin/bash
emacsclient -e "(yant/punch-out)"
#+end_src

*** System wibar indicator showing currently clocked in tasks
:PROPERTIES:
:ID:       1ca4cbab-bb53-42f2-a5d4-eb59b30262a4
:END:

Works together with [[id:a086f86e-5436-4aeb-9bb2-b1d5cf0364a8][Externally controlled widgets (awesome WM)]]
The information about time balance multiplier is shown in [[id:4df7a164-25a1-4106-b610-155c5b34afd8][other script]] 
****************** TODO add links to balance multiplier and the balance script
****************** END

#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash 
while true; do org-clocked-in.sh 2>> ~/.log/org-clocked-in.log; sleep 5; done &
#+end_src
#+begin_src bash :tangle /home/yantar92/.local/bin/org-clocked-in.sh :shebang #!/bin/bash
# Make sure it exists
[[ -f "/home/yantar92/.org-clock-in" ]] || touch ~/.org-clock-in
BALANCE=""
[[ "$1" == "balance" ]] && BALANCE="1"

PID="$(pgrep awesome | head -n1)"
[[ -z "$PID" && -d "/proc/$PID" ]] || export DBUS_SESSION_BUS_ADDRESS="$(grep -z DBUS_SESSION_BUS_ADDRESS /proc/$PID/environ | tr '\0' '\n' | cut -d= -f2-)"


if [[ "$(cat ~/.org-clock-in | head -n1)" =~ "No clocked in task" ]]; then
    echo "orgstatus:set_text(\"No clocked in task\")" | awesome-client
    if [[ ! -z "$BALANCE" ]]; then
	BAL=$(cat ~/.org-clock-in  | tail -n1 | cut -d. -f1)
        BAL=$(echo "$BAL/60" | bc -l | sed -r 's/([^.]*\..).*/\1/')
	[[ "$(echo "$BAL < 0" | bc -l)" == "1" ]] && BAL_STRING="<span color=\"#FF0000\">${BAL}h</span>" \
		|| BAL_STRING="${BAL}h"
        echo ${BAL_STRING}
    fi
    exit
fi

time_string="`cat ~/.org-clock-in | cut -d[ -f2 | cut -d] -f1 | head -n1`"
time_before="`echo $time_string | cut -dh -f1`:`echo $time_string | sed -r 's/[0-9]+h //' | cut -dm -f1`"
if [[ "$time_string" =~ .+/.+ ]]; then
    effort_estimate="/`echo $time_string | sed -r 's/.+\///' | sed 's/ \([0-9]min\)/ 0\1/' | sed -r 's/h /:/' | sed -r 's/min//'`"
fi

# cat ~/.org-clock-in | cut -d[ -f2 | cut -d] -f1 | head -n1 | cut -d'(' -f1 | grep / &&\
     #     estimate="/`cat ~/.org-clock-in | cut -d[ -f2 | cut -d] -f1 | head -n1 | cut -d'(' -f1 | sed -r 's|.+/||'`"\
     # 	|| estimate=""

 time_plus="`timefromchange.sh ~/.org-clock-in | grep -Eo "[0-9]+ hours" | grep -Eo "[0-9]+" || echo 0`:`timefromchange.sh ~/.org-clock-in | grep -Eo "[0-9]+ minutes" | grep -Eo "[0-9]+" || echo 0`"
 hours_before="`echo $time_before | cut -d':' -f1 | sed -r 's/^0*([0-9]+)/\1/'`"
 hours_plus="`echo $time_plus | cut -d':' -f1 | sed -r 's/^0*([0-9]+)/\1/'`"
 minutes_before="`echo $time_before | cut -d':' -f2 | sed -r 's/^0*([0-9]+)/\1/'`"
 minutes_plus="`echo $time_plus | cut -d':' -f2 | sed -r 's/^0*([0-9]+)/\1/'`"
   hours_now="$(($hours_before + $hours_plus))"
   minutes_now="$(($minutes_before + $minutes_plus))"

   while (($minutes_now >= 60)); do
       minutes_now="$(($minutes_now - 60))";
       hours_now="$(($hours_now + 1))";
   done

   if (($minutes_now < 10)); then
       minutes_now="0$minutes_now";
   fi

time_now="$hours_now:$minutes_now"
RES="[ ${time_now}${effort_estimate} ] :: `cat ~/.org-clock-in | cut -d] -f 2- | head -n1`"
RES="$(echo "$RES" | sed -r 's/\((.*)\)/\1/')"

RES=$(echo "$RES" | sed -r "s/'/\"/g") # fix "'"

echo "orgstatus:set_text('$RES')" | awesome-client 2>&1 >>/dev/null;

if [[ ! -z "$BALANCE" ]]; then
    MULT="$(cat ~/.org-clock-in | tail -n1)";
    BAL="$(cat ~/.org-clock-in | head -n2 | tail -n1)";
    BAL_STRING=$(echo "($hours_plus * $MULT * 60 + $minutes_plus * $MULT + $BAL)/60.0" | bc -l | sed -r 's/([^.]*\..).*/\1/');
    if [[ $(echo "$BAL_STRING < 0" | bc -l) == "1" ]]; then
	BAL_STRING="<span color=\"#FF0000\">${BAL_STRING}h</span>"
        [[ ! -f /tmp/negative-time-balance ]] && notify-send -u critical "Negative time balance"
        touch /tmp/negative-time-balance
    else
	BAL_STRING="${BAL_STRING}h"
        rm -f /tmp/negative-time-balance
    fi
    [[ $(echo "$MULT < 0" | bc -l) == "1" ]] && BAL_STRING="${BAL_STRING}<span color=\"#FF0000\">"\
	    || BAL_STRING="${BAL_STRING}<span color=\"#00FF00\">"
    BAL_STRING="${BAL_STRING}<span font=\"8\">$(echo $MULT | sed -r 's/-//')x</span></span>"
    echo $BAL_STRING
fi
#+end_src

Helper script calculating time from last change of a file
#+begin_src bash :tangle /home/yantar92/.local/bin/timefromchange.sh :shebang #!/bin/bash
displaytime.sh $(expr $(date +%s) - $(date +%s -r $1))
#+end_src
#+begin_src bash :tangle /home/yantar92/.local/bin/displaytime.sh :shebang #!/bin/bash
function displaytime {
  local T=$1
  local D=$((T/60/60/24))
  local H=$((T/60/60%24))
  local M=$((T/60%60))
  local S=$((T%60))
  [[ $D > 0 ]] && printf '%d days ' $D
  [[ $H > 0 ]] && printf '%d hours ' $H
  [[ $M > 0 ]] && printf '%d minutes ' $M
  [[ $D > 0 || $H > 0 || $M > 0 ]] && printf 'and '
  printf '%d seconds\n' $S
}

displaytime $1
#+end_src

*** Spell checking (aspell)
**** Dictionaries
:PROPERTIES:
:ID:       fd8605c7-c165-413d-829a-b8e3ed43cce9
:END:

- =app-dicts/aspell-en=

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/aspell
#+end_src

*** w3m browser for rendering
:PROPERTIES:
:ID:       66a5989e-9d17-40af-b680-494ef978198b
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
www-client/w3m
#+end_src

** Testing emacs repo
:PROPERTIES:
:ID:       bcebe59b-f13d-49fc-81aa-ba9dcfe71e5e
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/emacs-test-git.sh :shebang #!/bin/bash
function yes_or_no {
    while true; do
        read -p "$* [y/n]: " yn
        case $yn in
            [Yy]*) return 0  ;;  
	    [Nn]*) echo "Aborted" ; return  1 ;;
	esac
done
}

set -e
make cleanall
make EMACS=emacs-26 $* test || (echo "Failed to run tests using $(emacs-26 --version | head -n1)"; yes_or_no " Continue?")
make cleanall
make EMACS=emacs-27 $* test || (echo "Failed to run tests using $(emacs-27 --version | head -n1)"; yes_or_no " Continue?")
make cleanall
make EMACS=emacs-28 $* test || (echo "Failed to run tests using $(emacs-28-vcs --version | head -n1)"; yes_or_no " Continue?")
make cleanall
make EMACS=emacs-29-vcs $* test || (echo "Failed to run tests using $(emacs-29-vcs --version | head -n1)"; yes_or_no " Continue?")
make cleanall
LANG="C" make EMACS=emacs-29-vcs $* test || (echo "Failed to run tests using LANG=C $(emacs-29-vcs --version | head -n1)"; yes_or_no " Continue?")
make cleanall
LANG="de_DE.UTF-8" make EMACS=emacs-29-vcs $* test || echo "Failed to run tests using LANG=de_DE.UTF-8 $(emacs-29-vcs --version | head -n1)"
#+end_src

** Silver searcher (ag)
:PROPERTIES:
:ID:       221566ca-c243-4b08-b39e-0f2074c6c59a
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-apps/the_silver_searcher
#+end_src

** Ledger
:PROPERTIES:
:ID:       cacf88b6-4f1f-4bb1-9452-8cf641877c5c
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-office/ledger
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/ledger
app-office/ledger doc
#+end_src

*** Default args
:PROPERTIES:
:ID:       27df4dfc-19e0-441b-8e84-f7400229152b
:END:

#+name: ledger-file
#+begin_src emacs-lisp :eval yes
yant/ledger-file
#+end_src

#+begin_src conf :tangle /home/yantar92/.ledgerrc :noweb tangle
--pedantic
--explicit
--file <<ledger-file()>>
--effective
--exchange <<ledger-main-currency()>>
#+end_src
*** Weekly expenses script

#+begin_src bash :tangle /home/yantar92/.local/bin/ledger-weekly-expenses.sh :shebang #!/bin/bash
ledger --no-pager -f <<ledger-file()>>  reg -X <<ledger-main-currency()>> Expenses and not Work and not Gifts and not Medical -W -n -A
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/ledger-weekly-expenses-USD.sh :shebang #!/bin/bash
ledger --no-pager -f <<ledger-file()>>  reg -X USD Expenses and not Work and not Gifts and not Medical -W -n -A
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/ledger-weekly-expenses-EUR.sh :shebang #!/bin/bash
ledger --no-pager -f <<ledger-file()>>  reg -X EUR Expenses and not Work and not Gifts and not Medical -W -n -A
#+end_src

*** Food status script
:PROPERTIES:
:ID:       16e32a4e-4314-4db3-b682-17df6f376538
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/ledger-food-status.sh :shebang #!/bin/bash
ledger --no-pager -f <<ledger-file()>>  reg --budget -X <<ledger-main-currency()>> Food  -U -p 'until tomorrow'
#+end_src

*** Continuous monitoring of budget
:PROPERTIES:
:ID:       4df7a164-25a1-4106-b610-155c5b34afd8
:END:

It is very useful to keep track of the important budget variables regularly [[id:TEDbelle2021what_your_money_habit_reveal_about_youee4][Robert A. Belle [TED] (2021) What your money habits reveal about you]].
I have an [[id:a086f86e-5436-4aeb-9bb2-b1d5cf0364a8][Awesome WM widget]] showing the most important budgets on screen.
The widget is populated using the following script. The script assumes Awesome WM markup convention.

The script also shows my [[id:38d9103d-a969-4c69-ae0e-a9a50912fba0][time budget]].

:CONSTANTS:
#+name: ledger-main-currency
#+begin_src emacs-lisp :eval yes
yant/ledger-main-currency
#+end_src
#+name: ledger-main-currency-symbol
#+begin_src emacs-lisp :eval yes
yant/ledger-main-currency-symbol
#+end_src
#+name: max-balance-food
#+begin_src emacs-lisp :eval yes
yant/ledger-max-balance-food
#+end_src
#+name: min-balance-food
#+begin_src emacs-lisp :eval yes
yant/ledger-min-balance-food
#+end_src
#+name: normal-balance-food
#+begin_src emacs-lisp :eval yes
yant/ledger-normal-balance-food
#+end_src
#+name: emergency-fund-months
#+begin_src emacs-lisp :eval yes
yant/ledger-emergency-fund-months
#+end_src
#+name: ledger-checking-account
#+begin_src emacs-lisp :eval yes
yant/ledger-checking-account
#+end_src
:END:

The idea of the script is regular reminder to not spend too much money on certain things and not forget spending enough money on others:
- Food (should not overspend)
- Emergency fund
- Small things that improve well-being, but are not strictly necessary (I keep forgetting to buy those even if I know what can make my life easier)
- Leisure (I usually go from one extreme to other: either not spend much or vice versa)
- Retirement fund
- Reminder to invest extra money
****************** TODO note how I calculate retirement account
****************** END
#+begin_src bash :tangle /home/yantar92/.local/bin/balance-monitor.sh :shebang #!/bin/bash :noweb tangle
# export DBUS_SESSION_BUS_ADDRESS environment variable
PID=$(pgrep awesome | head -n1)
[[ -z "$PID" && -d "/proc/$PID" ]] && export DBUS_SESSION_BUS_ADDRESS="$(grep -z DBUS_SESSION_BUS_ADDRESS /proc/$PID/environ | tr '\0' '\n' | cut -d= -f2-)"

UNCONVERTED_CURRENCIES="$(ledger -X  <<ledger-main-currency()>> bal Expenses | sed -E '/<<ledger-main-currency()>>|----+/d')"

if [[ ! -z "$UNCONVERTED_CURRENCIES" ]]; then
    [[ "$PROJECTING" == "1" ]] && echo "balance.markup=''" | awesome-client || echo "balance.markup=' <span color=\"#FF0000\"><b>Ledger error</b></span> <span color=\"#FF0000\">Not all currencies convertable</span> '" | awesome-client;
    exit;
fi

BAL_FOOD="$(ledger bal --budget -X <<ledger-main-currency()>> Food -p 'until tomorrow' | awk '{print $1}' | sed -r 's/[^0-9-]+//' | tail -n1)";
BAL_FRUITS="$(ledger bal --budget -X <<ledger-main-currency()>> Expenses:Fruits -p 'until tomorrow' | awk '{print $1}' | sed -r 's/[^0-9-]+//' )";
[[ -z "$BAL_FRUITS" ]] && BAL_FRUITS="0"
BAL_FRUITS="$(echo "${BAL_FRUITS}*(-1)" | bc -l)";
BAL_ENTERTAINMENT="$(ledger bal --budget -X <<ledger-main-currency()>> Entertainment  -p 'until tomorrow' | awk '{print $1}' | sed -r 's/[^0-9-]+//'  | tail -n1 | sed -r 's/,//g')";
TODAY_BAL_FOOD="$(ledger bal -X <<ledger-main-currency()>> -b `date +%F` Food | tail -n1 | sed -r 's/[^0-9-]+//'  | cut -d' ' -f 1)"
[[ -z "$TODAY_BAL_FOOD" ]] && TODAY_BAL_FOOD="0"
MAX_BAL_FOOD="<<max-balance-food()>>"
NORMAL_BAL_FOOD="<<normal-balance-food()>>"
MIN_BAL_FOOD="<<min-balance-food()>>"
under_limit="0"

if [[ -n "$BAL_FOOD" ]]; then
    BAL_FOOD="$(echo "${BAL_FOOD}*(-1)" | bc -l)";
    res="$(echo "$BAL_FOOD > $MAX_BAL_FOOD" | bc -l)";
    [[ "$res" == "1" ]] && BAL_FOOD="$MAX_BAL_FOOD";
    under_limit=$(echo "$BAL_FOOD < $MIN_BAL_FOOD" | bc -l);
    [[ "$under_limit" == "1" ]] && BAL_FOOD="$MIN_BAL_FOOD";
    # BAL_FOOD="$(echo "$BAL_FOOD - $TODAY_BAL_FOOD" | bc -l)"
else
    BAL_FOOD="N/A";
fi
under_limit=$(echo "$BAL_FOOD < $NORMAL_BAL_FOOD" | bc -l)
under_0=$(echo "$BAL_FOOD < 0" | bc -l)
BAL_FOOD=$(echo "$BAL_FOOD" | sed -r 's/^\./0./')
BAL_FOOD=$(echo "$BAL_FOOD" | sed -r 's/^-\./-0./')
if [[ "$under_0" == "1" ]]; then
    BAL_FOOD="<span color=\"#FF0000\"><<ledger-main-currency-symbol()>>$BAL_FOOD milk\!</span>"
elif [[ "$under_limit" == "1" ]]; then
    BAL_FOOD="<span color=\"#FF0000\"><<ledger-main-currency-symbol()>>$BAL_FOOD canteen\!</span>"
else
    BAL_FOOD="<<ledger-main-currency-symbol()>>$BAL_FOOD"
fi

# BAL_ENTERTAINMENT_SHORT="$(echo "$BAL_ENTERTAINMENT/1000.0*(-1)" | bc -l | grep -oE '^-?[0-9]*\.?[0-9]{0,2}')k"
# BAL_ENTERTAINMENT_SHORT="$(echo $BAL_ENTERTAINMENT_SHORT | sed -r 's/^(-?)\./\10\./')"
BAL_ENTERTAINMENT_SHORT="$(echo "$BAL_ENTERTAINMENT*(-1)" | bc -l | grep -oE '^-?[0-9]*')"
[[ "$(echo "$BAL_ENTERTAINMENT > 0" | bc -l)" == "1" ]] && BAL_ENTERTAINMENT_SHORT="<span color=\"#FF0000\"><<ledger-main-currency-symbol()>>$BAL_ENTERTAINMENT_SHORT</span>" || BAL_ENTERTAINMENT_SHORT="<<ledger-main-currency-symbol()>>$BAL_ENTERTAINMENT_SHORT"

WEEKLY_INCOME_AVG="$(ledger r -X <<ledger-main-currency()>> Income -W -n -A -p "from this year until tomorrow" | tail -n1 | sed -r 's/.+?<<ledger-main-currency()>>//' | sed -r 's/^-//' | sed -r 's/,//')" # average weekly income from the beginning of the year
[[ -z "$WEEKLY_INCOME_AVG" ]] && WEEKLY_INCOME_AVG="0"
MONTHLY_INCOME_AVG="$(echo "52.178574 / 12.0 * $WEEKLY_INCOME_AVG" | bc -l)"
# https://www.wisebread.com/figuring-the-size-of-your-emergency-fund
WEEKLY_SPENDING_AVG="$(ledger r -X <<ledger-main-currency()>> Expenses and not Work and not Gifts -W -n -A -p "from this year until tomorrow" | tail -n1 | sed -r 's/.+?<<ledger-main-currency()>>//' | sed -r 's/,//')" # average expenses from beginning last year in <<ledger-main-currency()>>
[[ -z "$WEEKLY_SPENDING_AVG" ]] && WEEKLY_SPENDING_AVG="0"
MONTHLY_SPENDING_AVG="$(echo "52.178574 / 12.0 * $WEEKLY_SPENDING_AVG" | bc -l)"

EMERGENCY_FUND="$(echo "$MONTHLY_SPENDING_AVG * <<emergency-fund-months()>>" | bc -l)"
BAL_EMERGENCY="$(ledger bal -X <<ledger-main-currency()>> Assets:Checking:<<ledger-checking-account()>> -p 'until tomorrow' | awk '{print $1}' | sed -r 's/<<ledger-main-currency()>>//')"
 if [[ "1" == "$(echo "$EMERGENCY_FUND > $BAL_EMERGENCY" | bc -l)" ]]; then
     BAL_EMERGENCY="<span color=\"#FF0000\">$(echo "($BAL_EMERGENCY - $EMERGENCY_FUND)/$MONTHLY_INCOME_AVG" | bc -l | sed -r 's/(\..{1}).+/\1/' | sed -r 's/^(-?)(\.)/\10\2/')m</span>"
 else
     if [[ "0" == "$EMERGENCY_FUND" ]]; then
	 BAL_EMERGENCY="<span color=\"#FFFF00\">N/A</span>"
     else
	 BAL_EMERGENCY="<span color=\"#00FF00\">ok</span>"
     fi
 fi


 BAL_CHECKING="$(ledger bal -X <<ledger-main-currency()>> Assets:Checking:<<ledger-checking-account()>> -p 'until tomorrow' | awk '{print $1}' | sed -r 's/<<ledger-main-currency()>>//')"
 CHECKING_EXTRA="$(echo $BAL_CHECKING - ${MONTHLY_SPENDING_AVG} - ${EMERGENCY_FUND} | bc -l)" # extra one month

 if [[ "1" == "$(echo "$CHECKING_EXTRA > 0" | bc -l)" ]]; then
     if [[ "0" == "$MONTHLY_SPENDING_AVG" ]]; then
	 EXTRA="<span color=\"#FFFF00\">N/A</span>"
     else
	 if [[ "1" == "$(echo "$CHECKING_EXTRA > $MONTHLY_SPENDING_AVG" | bc -l)" ]]; then
	     EXTRA="<span color=\"#FF0000\"><<ledger-main-currency-symbol()>>$(echo "$CHECKING_EXTRA/1000.0" | bc -l | grep -oE '^-?[0-9]*\.?[0-9]{0,1}')k</span>"
	 else
	     EXTRA="<<ledger-main-currency-symbol()>>$(echo "$CHECKING_EXTRA/1000.0" | bc -l | grep -oE '^-?[0-9]*\.?[0-9]{0,1}')k"
	 fi
     fi
 else
     EXTRA="no"
 fi

 RETIREMENT="$(ledger b -X <<ledger-main-currency()>> "Retirement Savings" -n -p 'until tomorrow' | awk '{print $1}' | sed -r 's/<<ledger-main-currency()>>//' | sed -r 's/^-//' | sed -r 's/,//g')"
 [[ -z "$RETIREMENT" ]] && RETIREMENT="0"
 ASSETS="$(ledger bal -X <<ledger-main-currency()>> "Assets" and not Reimbursements -n  -p 'until tomorrow' | awk '{print $1}' | sed -r 's/<<ledger-main-currency()>>//' | sed -r 's/,//g')"
 if [[ "1" == "$(echo "$RETIREMENT > $ASSETS" | bc -l)" ]]; then
     RETIREMENT="<span color=\"#FF0000\">$(echo "($ASSETS - $RETIREMENT)/$MONTHLY_INCOME_AVG" | bc -l | sed -r 's/(\..{1}).+/\1/' | sed -r 's/^(-?)(\.)/\10\2/')m</span>"
 else
     RETIREMENT="<span color=\"#00FF00\">ok</span>"
 fi

 OTHER="$(ledger budget Expenses:Personal:Other -X <<ledger-main-currency()>> -p "from last year until tomorrow" | tail -n1 | awk '{print $3}' | sed -r 's/<<ledger-main-currency()>>//')"
 # OTHER="$(echo "$OTHER * -1 / 1000" | bc -l)"
 # OTHER_SHORT="$(echo $OTHER | sed -r 's/(\..{1}).+/\1/' | sed -r 's/^(-?)(\.)/\10\2/')k"
 OTHER="$(echo "$OTHER * -1" | bc -l)"
 OTHER_SHORT="$(echo $OTHER | sed -r 's/(\..{1}).+/\1/')"
 if [[ "1" == "$(echo "$OTHER < 0" | bc -l)" ]]; then
     OTHER="<span color=\"#FF0000\"><<ledger-main-currency-symbol()>>$OTHER_SHORT</span>"
 else
     OTHER="<span color=\"#00FF00\"><<ledger-main-currency-symbol()>>$OTHER_SHORT</span>"
 fi

 BAL_TIME=$(org-clocked-in.sh balance)
 PROJECTING="0"
 if [[ -f ~/.log/projecting ]]; then
     [[ "$(cat ~/.log/projecting)" == "true" ]] && PROJECTING="1";
 fi
 [[ "$PROJECTING" == "1" ]] && echo "balance.markup=''" | awesome-client || echo "balance.markup=' Time:${BAL_TIME}  Food:$BAL_FOOD  Fruits:<<ledger-main-currency-symbol()>>$BAL_FRUITS  Other:$OTHER  Fun:$BAL_ENTERTAINMENT_SHORT  Retirement:$RETIREMENT  Emergency:$BAL_EMERGENCY  Extra:$EXTRA'" | awesome-client
#+end_src

The script is ran regularly
#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash
while true; do balance-monitor.sh; sleep 100; done &
#+end_src

*** Ludget - visualisation
:PROPERTIES:
:ID:       b4f36478-54ce-4ca1-93ae-dbd4e306bb67
:END:

#+begin_src bash :tangle no :dir /sudo::/ :eval yes
pip install ludget
#+end_src

** Email client (notmuch)
:PROPERTIES:
:ID:       e6408d25-2507-42b2-a4e4-d855eb9e6b13
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-mail/notmuch
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/notmuch
net-mail/notmuch doc
#+end_src
*** Config 
:PROPERTIES:
:header-args+: :tangle /home/yantar92/.notmuch-config
:ID:       dabb11b6-baee-4f73-a865-2530bcc4be15
:END:

#+begin_src conf 
[database]
path=/home/yantar92/Mail

[user]
name=Ihor Radchenko
primary_email=yantar92@posteo.net
other_email=ihor_radchenko@alumni.sutd.edu.sg;

[new]
tags=unread;inbox;todo;new;
ignore=

[search]
exclude_tags=deleted

[maildir]
synchronize_flags=true

[header]
List=List-Id
#+end_src
** Email composition (emacs)
:PROPERTIES:
:ID:       61106314-7883-432f-bd26-24d8cd404d36
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/emacs-mailto.sh :shebang #!/bin/bash 
emacsclient -c -e "(message-mailto \"$@\")"
#+end_src

#+begin_src conf :tangle /home/yantar92/.local/share/applications/emacsclient-mailto.desktop :mkdirp yes
[Desktop Entry]
Type=Application
Version=1.0
Name=Emacs Client Mailto
Exec=emacs-mailto.sh
Icon=emacs-icon
Terminal=false
MimeType=x-scheme-handler/mailto;
#+end_src

** Email sync client (mbsync from net-mail/isync)
:PROPERTIES:
:ID:       4e873d8d-9be8-4abb-ad40-46d8e912701d
:END:
*** Configuration :crypt:TANGLE:
:PROPERTIES:
:ID:       c80dbc40-d8a9-4991-8f5c-556c2d2f9699
:END:

-----BEGIN PGP MESSAGE-----

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
fM5lO28=
=mF10
-----END PGP MESSAGE-----
*** Certificates :ATTACH:
:PROPERTIES:
:ID:       b0880088-553c-4dac-b845-33cb5eb90a7e
:END:

*** Mail checker script
:PROPERTIES:
:ID:       e532176e-30fd-4eb8-b8ae-84b0a936446c
:END:

The script checks email from time to time, updates [[id:e6408d25-2507-42b2-a4e4-d855eb9e6b13][notmuch]] database and cleans spam.
Note that the script does not show notifications about incoming email. This is on purpose. Notifications are terrible for keeping attention on current task. See [[id:goodreads_digit_minim_choos_focus_life][Digital Minimalism: Choosing a Focused Life in a Noisy World By Cal Newport]] or [[id:lesswrong_benkuhn2020_tools_keepin_focus][benkuhn [lesswrong] (2020) Tools for Keeping Focused]].

#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash
while true; do mail-monitor.sh; sleep 100; done &
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/mail-monitor-logger.sh :shebang #!/bin/bash
while read x; do
    [[ "$x" == "No working address found for" ]] && continue
    [[ "$x" == *"Cannot connect to"* ]] && continue
    [[ "$x" == *"Socket error on"* ]] && continue
    [[ "$x" == *"Temporary failure in name resolution"* ]] && continue
    [[ "$x" == *"Error from IMAP server"* ]] && continue
    [[ "$x" == *"IMAP error: bogus greeting response BAD"* ]] && continue
    [[ "$x" == *"Network is unreachable"* ]] && continue
    [[ "$x" == *"IMAP error: unexpected EOF"* ]] && continue
    [[ "$x" == *"Maildir notice: sleeping due to recent directory modification"* ]] && continue
    [[ "$x" == *"No working address found"* ]] && continue
    [[ "$x" == *"No working address found for 127.0.0.1"* ]] && notify-send "Davmail not working" && continue
    [[ "$x" == *"NO LOGIN failed"* ]] && notify-send "Office365 or Hotmail account blocked. Update password via re-login in browser" && continue
    [[ "$x" == *"Account is blocked. Login to your account via a web browser to verify your identity."* ]] && notify-send "Hotmail account blocked. Login from browser" && continue
    [[ "$x" == *"error"* ]] && notify-send "Unclassified mail checker error: $x" && continue
    [[ "$x" == "" ]] && continue
    notify-send "mail-monitor: $x"
    echo $(date): $x >> ~/.log/mail-monitor.log
done
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/mail-monitor.sh :shebang #!/bin/bash

if [[ ! "$1" == "--nofetch" && ! "$PROJECTING" == "true" ]]; then
    mbsync --pull-new --push -a 2>&1 | mail-monitor-logger.sh;
    # slrnpull -h news2.neva.ru -d ~/Mail/spool/slrnpool/ 2>&1 |  mail-monitor-logger.sh;
fi

notmuch new 1>>/dev/null 2>&1
notmuch-new-messages-list.sh 2>&1 |  mail-monitor-logger.sh

if [[ "$1" == "-v" ]]; then
    # export DBUS_SESSION_BUS_ADDRESS environment variable
    PID="$(pgrep awesome | head -n1)"
    [[ -z "$PID" && -d "/proc/$PID" ]] && export DBUS_SESSION_BUS_ADDRESS="$(grep -z DBUS_SESSION_BUS_ADDRESS /proc/$PID/environ | tr '\0' '\n' | cut -d= -f2-)"
    notify-send "Mail checked"
fi
#+end_src

#+name: email-flaglist
#+begin_src emacs-lisp :results raw silent :eval yes
yant/email-flagged
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/notmuch-new-messages-list.sh :shebang #!/bin/bash  :noweb tangle
#if no new messages - exit
MESSAGES="$(notmuch search --output=messages tag:new)"
[[ -z "$MESSAGES" ]] && exit

#echo "`date`"

#delete and ignore in count all "Retrieval using the IMAP4 protocol failed for the following message:"
COUNT_IMAP4="$(notmuch count tag:inbox and \"Retrieval using the IMAP4 protocol failed for the following message:\")"
[[ "$COUNT_IMAP4" == "0" ]] || >&2 echo "Found $COUNT_IMAP4 IMAP4 fail messages"
[[ "$COUNT_IMAP4" == "0" ]] || notmuch tag +deleted -- tag:inbox and "Retrieval using the IMAP4 protocol failed for the following message:"

# clear spam
notmuch-clear-spam.sh

#add tags to the new message in thread
echo "$MESSAGES" | while read x; do
    if [ ! -z "$x" ]; then
	THREAD="`notmuch search --output=threads $x`";
	[[ -z "$THREAD" ]] || TAGS="`notmuch search --output=tags $THREAD`";
	TAGS="`echo $TAGS | sed -e 's/listinbox//g' | sed -e 's/flagged//g' | sed -e 's/draft//g' | sed -e 's/attachment//g' | sed -e 's/signed//g' | sed -e 's/sent//g' | sed -e 's/[0-9]{4}//g' | sed -e 's/forwarded//g'  | sed -e 's/replied//g'`"
	[[ -z "$TAGS" ]] || notmuch tag `echo +\`echo $TAGS | sed -r 's/^[ ]*//'\` | sed -r 's/ / +/g'` +`date | awk '{print $NF}'` -- $x
#	notmuch tag -listinbox -- tag:inbox and $x
    fi
done

#tag usenet group emails
notmuch search --output=messages tag:new | while read message; do
    if [ ! -z "$message" ]; then
	message_file="$(notmuch search --output=files $message)"
	cur_group=$(cat $message_file | grep Newsgroups | cut -d: -f2 | sed -r 's/^ +//');
	if [[ ! -z "$cur_group" ]]; then
	    cur_group="+$(echo $cur_group | sed -r 's/,/ +/g')"
	    # echo "notmuch tag +usenet $cur_group -- $message"
	    notmuch tag +usenet +listinbox -inbox $cur_group -- $message
	    notmuch tag -listinbox +inbox -- $message and tag:nolist
            notmuch tag -inbox -- $message and tag:track
	    THREAD="`notmuch search --output=threads $message`";
	    [[ -z "$THREAD" ]] || THREAD_TAGS="`notmuch search --output=tags tag:deleted and $THREAD`";
	    echo "$THREAD_TAGS" | grep "deleted" && notmuch tag +deleted -- $message
	fi
    fi
done

#tag mailing list emacs
notmuch search --output=messages tag:new | while read message; do
    if [ ! -z "$message" ]; then
	message_file="$(notmuch search --output=files $message)"
	cur_maillist="$(cat $message_file | grep -A1 -i List-Id  | grep '<' | sed -r 's/.*<(.*)>.*/\1/' | head -n1)";
	if [[ ! -z "$cur_maillist" ]]; then
	    # echo "notmuch tag +usenet $cur_maillist -- $message"
	    notmuch tag +maillist +listinbox -inbox +$cur_maillist -- $message
            notmuch tag -listinbox +inbox -- $message and tag:nolist
            notmuch tag -inbox -listinbox -- $message and tag:track
	    THREAD="`notmuch search --output=threads $message`";
	    [[ -z "$THREAD" ]] || THREAD_TAGS="`notmuch search --output=tags tag:deleted and $THREAD`";
	    echo "$THREAD_TAGS" | grep "deleted" >/dev/null && notmuch tag +deleted -- $message
	fi
    fi
done

#Tag flagged
echo "\
<<email-flaglist()>>" | while read x; do
    notmuch tag +inbox +todo +flagged -- $x and tag:new
done

#ARCHIVE some maillists
# ARCHIVE_TAGS="bug-gnu-emacs.gnu.org"
ARCHIVE_TAGS=""

echo "$ARCHIVE_TAGS" | while read x; do
    if [ ! -z "$x" ]; then
	notmuch tag -listinbox -inbox -todo -- tag:$x and tag:new
    fi
done

#Tag messages that must directly go to inbox
notmuch tag +inbox +todo -listinbox -- tag:"/^.+.yantar92.github.com$/" and tag:new
notmuch tag +inbox +todo -listinbox -- tag:emacs-orgmode.gnu.org and tag:new and not tag:track
notmuch tag +inbox +todo -listinbox -- tag:~bzg/org-build-failures.lists.sr.ht and tag:new and not tag:track
notmuch tag +inbox +todo -listinbox -- to:yantar92 and tag:new
notmuch tag +inbox +todo -listinbox -- to:Radchenko and tag:new
notmuch tag +inbox +todo -listinbox -- to:Ihor and tag:new

MESSAGES_MAIN="$(notmuch search --output=messages tag:new and not tag:sent and tag:inbox and tag:flagged)"
echo $(notmuch search --output=messages tag:new and not tag:sent and not tag:flagged) | while read message; do
    if [[ ! -z "${MESSAGE}" ]]; then
	THREAD="`notmuch search --output=threads $message`";
	if [[ ! -z "${THREAD}" ]]; then
	    [[ -z "$(notmuch search tag:flagged and $THREAD)" ]] || MESSAGES_MAIN="$MESSAGES_MAIN\n$message";
	fi
    fi
done

#done with initial tagging
notmuch tag -new -- tag:new

[[ -z "$MESSAGES_MAIN" ]] && exit
MESSAGES_NOTIFICATION="$(notmuch search $MESSAGES_MAIN | cut -d' ' -f2- | sed -r 's/^[ ]*//')"
NOTIFICATION="$MESSAGES_NOTIFICATION"
# [[ -z "$MESSAGES_NOTIFICATION" ]] && NOTIFICATION="Usenet:   $COUNT_USENET new messages\nMaillist: $COUNT_MAILLIST new messages" ||\
    # 	NOTIFICATION="Usenet:   $COUNT_USENET new messages\nMaillist: $COUNT_MAILLIST new messages\n"

# PID="$(pgrep awesome | head -n1)"
# [[ -z "$PID" && -d "/proc/$PID" ]] && export DBUS_SESSION_BUS_ADDRESS="$(grep -z DBUS_SESSION_BUS_ADDRESS /proc/$PID/environ | tr '\0' '\n' | cut -d= -f2-)"
touch ~/.log/projecting
[[ "$1" == "--silent" || "$(cat ~/.log/projecting)" == "true" ]] ||  echo "naughty.notify({ title = \"New mail\", text =\"$NOTIFICATION\", timeout = 0, preset = naughty.config.presets.critical})" | awesome-client
#+end_src

#+name: email-whitelist
#+begin_src emacs-lisp :results raw silent :eval yes
yant/email-whitelist
#+end_src
#+name: spam-keywords
#+begin_src emacs-lisp :results raw silent :eval yes
yant/spam-keywords
#+end_src

[2020-12-24 Thu] Disabling. Too many false positives.
****************** TODO Implement reliable debugger for spam filter
****************** END

#+begin_src bash :tangle /home/yantar92/.local/bin/notmuch-clear-spam.sh :shebang #!/bin/bash :noweb tangle
exit

WHITE_LIST="\
<<email-whitelist()>>"

WHITE_LIST_SEARCH_STRING=$(
    echo "$WHITE_LIST" | while read x; do
	echo " and not from:$x";
    done
			)

#delete and mark as spam all the messages from senders of messages marked as spam
# notmuch address "(tag:deleted AND tag:spam) OR (tag:spam)" | while read x; do
#     EMAIL="$(echo $x | sed -r 's/^.*<(.*)>$/\1/')"; echo "$EMAIL"; done | sort -u | while read x; do
#     [[ -n "$x" ]] && notmuch tag +deleted +spam -- tag:new and not tag:sent and from:$x $WHITE_LIST_SEARCH_STRING;
# done

SPAM_KEYWORDS="\
<<spam-keywords()>>"

echo "$SPAM_KEYWORDS" | while read x; do
    [[ -n "$x" ]] && notmuch tag +deleted +spam -- tag:new and not tag:sent and "$x" $WHITE_LIST_SEARCH_STRING;
done
# echo

#spam servers based on tag
notmuch address "(tag:deleted AND tag:spam_server) OR (tag:spam_server)" | while read x; do
    EMAIL="$(echo $x | sed -r 's/^.*<.*(@.*)>$/\1/')"; echo "$EMAIL"; done | sort -u | while read x; do
    [[ -n "$x" ]] && notmuch tag +deleted +spam -- tag:new and not tag:sent and from:$x $WHITE_LIST_SEARCH_STRING;
done
# echo

# #handle server spam tags
# notmuch search --output messages tag:new and not tag:sent | while read x; do
#     [[ -n "$x" ]] || continue;
#     FILE=$(notmuch search --output files $x)
#     grep "X-Mras: PROBABLE_SPAM" $FILE >/dev/null && notmuch tag +deleted +spam -- $x $WHITE_LIST_SEARCH_STRING
# done

# notmuch search --output files tag:new and not tag:sent | while read x; do
#     ID=$(cat $x | grep "Message-ID" -A1 | tail -n1 | sed -r 's/<//; s/>//; s/[[:space:]]//g')
#     spamassassin < $x | grep "X-Spam-Flag: YES" >/dev/null && notmuch tag +spam +spam_likely -- id:$ID
# done
#+end_src

*** COMMENT Davmail server for Exchange forced by SUTD mail server
:PROPERTIES:
:ID:       9870b79e-4ca8-4ab8-a841-4d29dd014755
:END:

[2023-01-08 Sun] SUTD disabled my last means to send email using my client. Falling back to redirect + manual WEB interface when necessary. No other options left.

I need to use Microsoft Exchange protocol (everything else was disabled) to access SUTD mail [[notmuch:id:SG2PR03MB322660872358C604CB3537EFADCF0@SG2PR03MB3226.apcprd03.prod.outlook.com][Email from IT Service Desk: RE: IMAP settings for the email server]]

The best option seems to be Davmail
[[id:e8384cfa2557dcfe939e1cf4c3ae80d5b4ae937f][[Reddit] Anyone knows a Mailbox synchronizer supporting Microsoft Exchange protocol? : Gentoo]]

It is not available in Gentoo by default, but I can use =pentoo= overlay:
#+begin_src bash :tangle no :dir /sudo::/ :results output
eselect repository enable pentoo
#+end_src
Do not enable any other packages from the overlay
#+begin_src conf :tangle /sudo::/etc/portage/package.mask/pentoo-repo
,*/*::pentoo
#+end_src
#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/davmail-bin
net-mail/davmail-bin::pentoo
acct-user/davmail::pentoo
acct-group/davmail::pentoo
#+end_src

Run as server system-wide
#+begin_src conf :tangle /sudo::/etc/portage/package.use/davmail-bin
net-mail/davmail-bin server
#+end_src
#+begin_src bash :tangle no :dir /sudo::/
rc-update add davmail default
#+end_src

I will use IMAP Port 10043 in my config.
Other important settings:
davmail.server=true and davmail.allowRemote=true

[2021-04-14 Wed] [[notmuch:id:SG2PR03MB3226925B2E536A18D77C9507AD4E9@SG2PR03MB3226.apcprd03.prod.outlook.com][Email from IT Service Desk: Re: Case ID: 77322 - Assist on EASE enrolment]]
The new two-factor authentication requires MFA authentication: =davmail.mode=O365Modern=
Details on configuration: [[id:Davmail.Sourceforge_guessantdavmail_pop_imap_smtp_caldav858][Mickael Guessant [Davmail.Sourceforge] DavMail POP/IMAP/SMTP/Caldav/Carddav/LDAP Exchange Gateway - Frequently asked questions]]

#+begin_src conf :tangle /sudo::/etc/davmail.properties
davmail.ssl.keystoreType=
davmail.ssl.keystorePass=
davmail.proxyPassword=
davmail.oauth.tenantId=
davmail.oauth.clientId=
davmail.enableKerberos=false
davmail.smtpPort=1025
davmail.folderSizeLimit=
davmail.forceActiveSyncUpdate=false
davmail.imapAutoExpunge=true
davmail.useSystemProxies=false
davmail.proxyUser=
davmail.caldavEditNotifications=false
davmail.ssl.nosecuresmtp=false
davmail.caldavPastDelay=0
davmail.ssl.keyPass=
log4j.logger.httpclient.wire=WARN
davmail.noProxyFor=
log4j.logger.org.apache.commons.httpclient=WARN
davmail.server=true
davmail.popMarkReadOnRetr=false
davmail.ssl.nosecureimap=false
davmail.disableTrayActivitySwitch=false
davmail.caldavAutoSchedule=true
davmail.enableProxy=false
davmail.proxyPort=
davmail.logFileSize=
davmail.mode=O365Modern
davmail.smtpSaveInSent=true
davmail.bindAddress=
davmail.ssl.nosecurepop=false
davmail.ssl.pkcs11Library=
log4j.rootLogger=WARN
davmail.ssl.keystoreFile=
log4j.logger.davmail=DEBUG
davmail.ssl.clientKeystoreType=
davmail.clientSoTimeout=
davmail.ssl.pkcs11Config=
davmail.ssl.clientKeystorePass=
davmail.imapPort=10043
davmail.url=https://outlook.office365.com/EWS/Exchange.asmx
davmail.sentKeepDelay=0
davmail.ssl.nosecureldap=false
davmail.imapAlwaysApproxMsgSize=false
davmail.ssl.nosecurecaldav=false
davmail.popPort=1110
davmail.defaultDomain=
davmail.showStartupBanner=true
davmail.proxyHost=
davmail.ldapPort=1389
log4j.logger.org.apache.http.wire=WARN
davmail.disableGuiNotifications=false
davmail.server.certificate.hash=
davmail.imapIdleDelay=
davmail.allowRemote=true
davmail.disableUpdateCheck=false
log4j.logger.org.apache.http=WARN
davmail.caldavPort=1080
davmail.enableKeepAlive=false
davmail.ssl.clientKeystoreFile=
davmail.logFilePath=/var/log/davmail.log
davmail.carddavReadPhoto=true
davmail.keepDelay=30
davmail.oauth.redirectUri=
davmail.caldavAlarmSound=
#+end_src

** Mailing list sync (slrn - slrnpull)
:PROPERTIES:
:ID:       508d0fad-8572-43e9-8ac7-d40432e091aa
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-nntp/slrn
#+end_src

** RSS sync client for websites not providing RSS natively (RSSHub)
:PROPERTIES:
:ID:       2242c473-3c03-459f-b0d4-9f916850dc6e
:END:

Installing using Docker
#+begin_src bash :tangle no :eval yes
docker pull diygod/rsshub
#+end_src

#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash
# docker run -d --name rsshub -p 1200:1200 diygod/rsshub
docker start rsshub
#+end_src

** Generic web-page update watcher (via diff): [[id:c711711207c4738449032aa13d464d500bc9aa95][urlwatch]]
:PROPERTIES:
:ID:       190effb6-f7cd-4281-983d-9c709a6dc761
:END:

*** Installation
:PROPERTIES:
:ID:       a88d8e0b-1880-4c70-9225-19ea1868381d
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
www-misc/urlwatch
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/urlwatch
www-misc/urlwatch ~amd64
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/urlwatch
www-misc/urlwatch doc
#+end_src

Also, need to copy file:~/.urlwatch/cache.db

*** Configuration

**** Global config 
:PROPERTIES:
:ID:       ee2cd134-9a6f-46ad-a4e6-efdb01d4815c
:END:

#+begin_src yaml :tangle /home/yantar92/.urlwatch/urlwatch.yaml :mkdirp yes
display:
  error: true
  new: true
  unchanged: false
report:
  email:
    enabled: true
    from: 'yantar92@posteo.net'
    html: true
    method: sendmail
    sendmail:
      path: sendmail
    smtp:
      host: localhost
      keyring: true
      port: 25
      starttls: true
    subject: '{count} changes: {jobs}'
    to: 'yantar92@posteo.net'
  html:
    diff: unified
  pushover:
    app: ''
    enabled: false
    user: ''
  stdout:
    color: true
    enabled: true
  text:
    details: true
    footer: true
    line_length: 75
job_defaults:
  url:
    ignore_connection_errors: true
#+end_src

**** URLs to watch :crypt:TANGLE:
:PROPERTIES:
:ID:       4792583e-f43e-4b7d-b80f-431ec6979042
:END:

-----BEGIN PGP MESSAGE-----

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
=yRLS
-----END PGP MESSAGE-----
** Mail sending (msmtp)
:PROPERTIES:
:ID:       4b35d6bf-317c-4d18-a610-b217ed557dc4
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
mail-mta/msmtp
#+end_src

*** Config :crypt:TANGLE:
:PROPERTIES:
:ID:       1fee9007-01b8-4558-b232-d6aa312dea4e
:END:

-----BEGIN PGP MESSAGE-----

hQEMA3SKBiQ2zhL6AQf/T8F95OdNGAcKq3D6zit0GT9RUDFygRf31mDNG6GdGirA
2qJguA1oe/xaXGcKj53OZN3aAL+Eh/O0kfU0ya0NtEcba0HqRR8IcEaW4DvE6VTr
iiqrN2g884tO9z/neQm4hJPlGOCi0dnlrgNYXGWqKChk3MwH4+PQLj9yrRfuqHZ9
D0ndGasszDhGy/9GiMiKqddgrONNh2+GIKmb9umNba52C6WBeQxAqy8GV0G3TvDe
KCfJS8hC+gm0ZmHM6TjsXkUxhZmSbpecQrZW0k2V2ToBw3danGvkYblNcMgah2Ct
5efiR5k4pLq83w1rmcCIdJ3OvhenekktCr1Ey0fJwtLpAUsk0Krvb9dlAOKYY4pZ
jk1LvKxkYOCsXKnwW7we5MUrytqpdP2lpmkfYAi1xqH9+vpqEglKc0iRWKVhQ+VC
d6WfxdJ1rpigcPjPF68pVAqHGGZZ2bRV7ZFkKRfwQLaGalYW8y4WVlQSWalVgk17
pfP7LUa88Se0+prKiB8A+eS26Y4ClgQPmXjnmy4KoAh5fECekOT9+4Q9c5WNC97A
ASUxSPJSRsWxcNET7O6PZOB152xdMdy/ehG8KrckN5+Tmg5aGNj/MWQp0Bt6aCO6
8BcpRbSKJZF5UhD5EtKgTYQxQqKrdzMqJIGnlxh/i4OvKcTMyEB9wLFXhokFMA/L
ueTFW9CPDgT9gXaxa6I6SwNq4sejhrXGoLniylvTe+1yjhsxa97/Ym91ZYvBIby6
N/HgmWQaSuh3668RVKgXqSVuOMHhd4VVd7RWoqC6pPs9Nw7pG4Xo2GsqTO7LSEbp
4HctRCi5gky7ZuQ5oqPze+1NBxyWhXb5UMcfBMrMa+neZm80utKRI/GdJn7Hlg0K
gW8/uvxsUCUDTjvXguIy4vOzgffmfy+yFgzY2c1Ujc+IVLTAx82MKT0Ciy30/ALJ
BCrd7HFzUostc3r8UFRI7jkCUsZk7EDG+WU8aKZZ90QxwZWbIXtqJODewXHH9u4H
zZUjAGib77NMYYlwTnvQnVqsoEaHUJI+ii/aMG8qjUp9Fv3ne3NgHySDix0VwxaF
vIWqsGgIc9fefdzVnoZG9zzhio+cPQtriWJpM/mD63ztahsMKPvjFj0o3n/T9s+W
caYNGI/WPfh4+mFiVVriqoOoXk5W9TrE+H6EydOSIEhArBnWcd88sQyKLFH4uHO8
Fw50qOIRhhnYIHr/BZdATsdvSoh1vpk2YTYkPO5/WpdPOW1jrcwApWnjx292hw==
=iYG5
-----END PGP MESSAGE-----
** Dictionary: translate-shell
:PROPERTIES:
:ID:       718fd820-8412-49f4-806a-7667fc6d12de
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-i18n/translate-shell
#+end_src

*** Show dictionary in rofi
:PROPERTIES:
:ID:       9b3691e9-2252-4f87-8871-36c52bf47f07
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/show-dictionary.sh :shebang #!/bin/bash
word="$(rofi -lines 0 -p 'dictionary: ' -dmenu)"
if [[ ! -z "$word" ]]; then
    rofi -width 800 -location 2 -e "$(trans -w 400 --no-ansi :en \\"$word\\")"
fi
#+end_src

*** Show translation in rofi
:PROPERTIES:
:ID:       75be08e9-3c61-4907-8632-4465dc1b0d33
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/show-translation.sh :shebang #!/bin/bash
word="$(rofi -lines 0 -p translate: -dmenu)"
if [[ ! -z "$word" ]]; then
    rofi -width 800 -location 2 -e "$(trans -w 400 --no-ansi :ru $word)"
fi
#+end_src

** Password storage: pass
:PROPERTIES:
:ID:       45d93214-94c2-4ba4-b46a-408687220659
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-admin/pass
#+end_src

*** Rofi integration
:PROPERTIES:
:ID:       8228182d-99d9-40ab-a7fc-96398cac246e
:END:

I have a custom script allowing to get passwords (without copying to clipboard)
Requires [[id:178a01b9-7a71-445c-8863-6f57d5908ed5][Xdotool]] and [[id:665fed18-4fb9-4787-9aa2-819c05614f03][setxkbmap]]
#+begin_src bash :tangle /home/yantar92/.local/bin/passmenu :shebang #!/usr/bin/env bash
shopt -s nullglob globstar

typeit=0
user=0
while (( $# > 0 )); do
    if [[ $1 == "--type" ]]; then
	       typeit=1
	       shift
	   fi
	   if [[ $1 == "--user" ]]; then
	       user=1
               shift
	   fi	
done

prefix=${PASSWORD_STORE_DIR-~/.password-store}
password_files=( "$prefix"/**/*.gpg )
password_files=( "${password_files[@]#"$prefix"/}" )
password_files=( "${password_files[@]%.gpg}" )

password=$(printf '%s\n' "${password_files[@]}" | rofi -dmenu -i "$@")

[[ -n $password ]] || exit

if [[ $user -eq 0 ]]; then
    if [[ $typeit -eq 0 ]]; then
	pass show -c "$password" 2>/dev/null
    else
	pass show "$password" | { read -r pass; printf %s "$pass"; } |
	    (setxkbmap us; xdotool type --clearmodifiers --file -; setxkbmap us,ua)
    fi
else
    USERNAME=$(pass show "$password" | grep -i user | cut -d: -f2 | sed 's/^[ ]*//')
    if [[ $typeit -eq 0 ]]; then
	echo "$USERNAME" | xclip 
    else
	echo "$USERNAME" | { read -r username; printf %s "$username"; } |
	    (setxkbmap us; xdotool type --clearmodifiers --file -; setxkbmap us,ua)
    fi    
fi
#+end_src

** COMMENT Office programs (wps-office)
:PROPERTIES:
:ID:       b975b51c-e283-4381-b6ce-af4c0c9d83fb
:END:

It is masked (proprietary). Last time, libreoffice did not work for me, so keep using this
#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/wps-office
app-office/wps-office ~amd64
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.license/wps-office
app-office/wps-office WPS-EULA
#+end_src

** Anki: spaced repetition software
:PROPERTIES:
:ID:       de9f3875-b96a-4d18-bc25-8f721c190ab4
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-misc/anki
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/anki
app-misc/anki ~amd64
#+end_src

[2021-04-04 Sun] Adding =dbus= use-flag for [[id:8f33d97b-6193-4164-b0a7-225bb7c30f75][qutebrowser]]
#+begin_src conf :tangle /sudo::/etc/portage/package.use/anki
dev-python/PyQt5 network webchannel printsupport opengl declarative multimedia sql dbus
#+end_src

The card database is stored in file:~/.local/share/Anki2

Also, need to install =dev-python/pyaudio= to play sounds.

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-python/pyaudio
#+end_src

** Gnuplot
:PROPERTIES:
:ID:       ae938eeb-8900-4654-b814-8351e5f7bc36
:END:

=cairo= is needed for [[id:438648e38c40bbdff091d416e59c243d44da93a5][yantar92 [Github] video-graph: A simple script to combine load/displacement data with video recording from Hysitron PI picoindenter]]

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sci-visualization/gnuplot
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/gnuplot
sci-visualization/gnuplot doc examples qt5 cairo
#+end_src

*** Configuration
:PROPERTIES:
:ID:       afc7b944-b614-48bd-8462-d67e1781535a
:END:

Based on other templates. 
****************** TODO Create reference from Dist
****************** END


#+begin_src conf :tangle /home/yantar92/.gnuplot
# palette
set palette defined (0 "violet",1 "blue",2 "cyan",3 "green",4 "yellow",5 "orange",6 "red")

# Init Variables
GRIDCOLOR = "#000000"
TEXTCOLOR = "#000000"
LINEWIDTH = 3
POINTSIZE = 0.5
# if (!exists('LOCALE')) {
#      LOCALE = system('echo $LANG')
# }

#set locale LOCALE
#set decimalsign locale LOCALE

POINTTYPE1 = 7
POINTTYPE2 = 5
POINTTYPE3 = 9
POINTTYPE4 = 13
POINTTYPE5 = 11
POINTTYPE6 = 7
POINTTYPE7 = 2
POINTSIZE1 = 1.0*POINTSIZE
POINTSIZE2 = 0.9*POINTSIZE
POINTSIZE3 = 1.2*POINTSIZE
POINTSIZE4 = 1.1*POINTSIZE
POINTSIZE5 = 1.2*POINTSIZE
POINTSIZE6 = 1.0*POINTSIZE
POINTSIZE7 = 0.9*POINTSIZE

set linetype 1 linecolor rgb "#9932CC" linewidth LINEWIDTH pointtype POINTTYPE1 pointsize POINTSIZE1
set linetype 2 linecolor rgb "#1F78B4" linewidth LINEWIDTH pointtype POINTTYPE2 pointsize POINTSIZE2
set linetype 3 linecolor rgb "#B2DF8A" linewidth LINEWIDTH pointtype POINTTYPE3 pointsize POINTSIZE3
set linetype 4 linecolor rgb "#33A02C" linewidth LINEWIDTH pointtype POINTTYPE4 pointsize POINTSIZE4
set linetype 5 linecolor rgb "#FB9A99" linewidth LINEWIDTH pointtype POINTTYPE5 pointsize POINTSIZE5
set linetype 6 linecolor rgb "#773355" linewidth LINEWIDTH dashtype 2 pointtype POINTTYPE7 pointsize POINTSIZE7
set linetype 7 linecolor rgb "#000000" linewidth LINEWIDTH dashtype 1 pointtype POINTTYPE6 pointsize POINTSIZE6

set linetype cycle 7

DATA="LINEWIDTH=0.5*POINTSIZE"
FUNC="LINEWIDTH=3"
@DATA

PNG_ORG="set term pngcairo enhanced font ',12' enhanced transparent size 1280,960 fontscale 1.7 lw 2.3 dashlength 0.5; GRIDCOLOR = \"#ffffff\"; TEXTCOLOR = \"#ffffff\"; load \"/home/yantar92/.gnuplot\""
PNG="set term pngcairo enhanced font ',12' enhanced size 1280,960 fontscale 1.7 lw 2.3 dashlength 0.5"
QT="set term qt font ',10' size 1280,960 fontscale 1.7 lw 2.3 dashlength 0.5"

unset xtics
unset ytics
unset mxtics
unset mytics
unset key
unset grid
unset border
unset xlabel
unset ylabel
unset label 100
unset label 101
unset label 200
unset label 201
unset arrow 100
unset arrow 200

unset lmargin
unset bmargin
unset tmargin
unset rmargin

set xrange [*:*]
set yrange [*:*]
set zrange [*:*]

# Tics
set xtics nomirror in scale 1,0.5 offset 0,0 autofreq textcolor rgb TEXTCOLOR
set ytics mirror in scale 1,0.5 offset 0,0 autofreq textcolor rgb TEXTCOLOR
set tics font ",12"

# Key
set key inside left top Left revers samplen 2 spacing 1.3 textcolor rgb TEXTCOLOR

# Grid
set grid noxtics ytics lt 0 lw 1 linecolor rgb GRIDCOLOR
set mxtics 5
set mytics 5

# Border
set border 11 lt -1 lw 2 linecolor rgb GRIDCOLOR

# Labels
#set label 200 '200: ylabel' at screen 0, graph 0.5 center offset 1,0 textcolor rgb TEXTCOLOR rotate by 90
#set label 201 '' at screen 1, graph 0.5 center offset -1,0 textcolor rgb TEXTCOLOR rotate by 90
#set label 100 '100: xlabel' at graph 0.5, graph 0 center offset 0,-3 textcolor rgb TEXTCOLOR
#set label 101 '' at graph 0.5, graph 1 center offset 0,3 textcolor rgb TEXTCOLOR

#Margin
set lmargin 10
set bmargin 4


# Ranges
set xrange [*<10:*]
set yrange [*<10:*]
set zrange [*<10:*]

#axes labels font size
set xlabel offset 0,0.0 textcolor rgb TEXTCOLOR font ",14"
set ylabel offset 0,0.0 textcolor rgb TEXTCOLOR font ",14"
set x2label offset 0,0.0 textcolor rgb TEXTCOLOR font ",14"
set y2label offset 0,0.0 textcolor rgb TEXTCOLOR font ",14"
set zlabel offset 0,0.0 textcolor rgb TEXTCOLOR font ",14"
set cblabel textcolor rgb TEXTCOLOR font ",14" offset char 1, 0


# for Latex Terminals load the latex settings
if (strstrt(GPVAL_TERM, 'latex') > 0) {
# Settings for Latex Terminals

set format "\\num{%g}" # Set number fomrat to siunitx

# Lables

arrowLabel(str) = sprintf("%s {\\tikz[baseline] \\draw[-latex,thick] (0,0.5ex) -- (7ex,0.5ex);}",str)

shortLabel(symb,unit) = sprintf("$%s$ in \\si{%s}",symb,unit)
shortArrowLabel(symb,unit) = arrowLabel(shortLabel(symb,unit))

longLabel(desc,symb,unit) = sprintf("%s %s",desc,shortLabel(symb,unit))
longArrowLabel(desc,symb,unit) = arrowLabel(longLabel(desc,symb,unit))

shortPuLabel(symb,unit) = sprintf("$\\nicefrac{%s}{%s}$",symb,unit)
shortPuArrowLabel(symb,unit) = arrowLabel(shortPuLabel(symb,unit))

longPuLabel(desc,symb,unit) = sprintf("%s %s",desc,shortPuLabel(symb,unit))
longPuArrowLabel(desc,symb,unit) = arrowLabel(longPuLabel(desc,symb,unit))

shortLabel(symb,unit) = sprintf("$\\nicefrac{%s}{\\si{%s}}$",symb,unit)

}

#+end_src

** Presentation: pdfpc
:PROPERTIES:
:ID:       dede8f50-961c-4ca0-b126-877f0df3d5aa
:END:

****************** TODO write custom ebuild
****************** END
Need =gstreamer= support for video. Also, need to install additional packages: gst-plugins-meta and media-plugins/gst-plugins-gtk

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-misc/pdfpc
media-plugins/gst-plugins-meta
media-plugins/gst-plugins-gtk
#+end_src

The video support for =gstreamer= can be tested using the following command [[id:644ac652e7528eb6af7fb03e3ecb168639846dbb][olivier-klein [Github] issue#547 pdfpc and Gstreamer]]: 
#+begin_src bash :tangle no
gst-play-1.0 --videosink gtksink apollo17.avi
#+end_src
The result should be playing video *and no warnings about =gtksink= creation*.

****************** TODO Some of the below flags are probably excessive
****************** END
 
#+begin_src conf :tangle /sudo::/etc/portage/package.use/pdfpc
app-misc/pdfpc gstreamer
media-plugins/gst-plugins-base theora
media-plugins/gst-plugins-meta ffmpeg theora ogg dvb
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/pdfpc 
app-misc/pdfpc ~amd64
#+end_src

** Python lib for automatic language detection: =langdetect=
:PROPERTIES:
:ID:       cbeef2db-d5ce-4a80-ba3e-276eef64bd96
:END:

Need =dev-python/pip=.
#+begin_src bash :tangle no :dir /sudo::/ :eval yes
pip install langdetect
#+end_src

** Syncthing
:PROPERTIES:
:ID:       68457017-7fb2-4028-83eb-1fe6767612b8
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-p2p/syncthing
#+end_src

Startup on load. Configuration is copied from old laptop.

#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash
syncthing -no-browser 2>&1 | syncthing-logger.sh &
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/syncthing-logger.sh :shebang #!/bin/bash
while read x; do
    [[ "$x" == *"INFO:"* ]] && continue
    [[ "$x" == "" ]] && continue
    echo $(date): $x >> ~/.log/mail-monitor.log
done
#+end_src

** Drawing

*** Gimp
:PROPERTIES:
:ID:       eefe5f80-d115-41d2-8fdf-ee479b5c3a63
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-gfx/gimp
#+end_src

*** Inkscape
:PROPERTIES:
:ID:       e593398e-113e-4169-b9df-cdd288e791d3
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-gfx/inkscape
#+end_src

[2020-12-13 Sun] Inkscape does not support tiff images by default. Adding =imagemagick= use-flag.
#+begin_src conf :tangle /sudo::/etc/portage/package.use/inkscape
# Required for installation
dev-cpp/gtkmm X
dev-cpp/cairomm X
media-gfx/inkscape imagemagick postscript jpeg inkjar svg2
#+end_src

** Git
*** Global attributes file
:PROPERTIES:
:ID:       fa1f82af-e9a1-4902-91ee-5dbd7b6998d3
:END:

#+begin_src bash :tangle no
git config --global core.attributesfile ~/.gitattributes
#+end_src

#+begin_src conf :tangle /home/yantar92/.gitattributes
,*.lisp  diff=lisp
,*.el    diff=lisp
,*.org   diff=org
#+end_src

*** Main config
:PROPERTIES:
:ID:       b35134c6-364b-499d-a740-bb4a7aeaba89
:END:

[2020-11-08 Sun] Added diff handler to name diff chunks by headline in org files
[2021-04-01 Thu] Change regexp according to [[id:7512681c13307f3005696422fa21170a171f538f][Protesilaos Stavrou: Coding blog [Protesilaos] (2021) Informative diff hunks for Emacs Lisp and Org]]; add lisp regexp

#+begin_src conf :tangle /home/yantar92/.gitconfig
[user]
	email = yantar92@posteo.net
	name = Ihor Radchenko
        signingkey = 6470762A7DA11D8B
[github]
	user = yantar92

[commit]
  gpgsign = true
  
[merge]
  conflictstyle = diff3

[format]
  thread = true

[diff "lisp"]
  xfuncname = "^(((;;;+ )|\\(|([ \t]+\\(((cl-|el-patch-)?def(un|var|macro|method|custom)|gb/))).*)$"

[diff "org"]
  xfuncname = "^(\\*+ +.*)$"
    
[core]
	attributesfile = /home/yantar92/.gitattributes
#+end_src
*** Rebase by default for new tracking branches
:PROPERTIES:
:ID:       093e21ec-60dc-4363-b593-20fa0fcfddf7
:END:

When doing feature development, it makes little sense to merge the feature branch to master explicitly using separate commit. It is better to use rebase instead of merge commit, as recommended in [[id:Stack_Overflow_autos_vs_autosb9a][[Stack Overflow] autosetuprebase vs autosetupmerge]].

#+begin_src conf :tangle /home/yantar92/.gitconfig
[branch]
  autosetupmerge = always
  autosetuprebase = always
#+end_src

** TeX \ LaTeX (texlive)
:PROPERTIES:
:ID:       a92c0e31-556b-47d5-a58e-468ab0c99a59
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/texlive
#+end_src


Use XeTeX and use many optional packages. They are not needed most of the time, but I remember myself regretting that I do not have these extra installed several times - they take a long time to install even if needed urgently.

#+begin_src conf :tangle /sudo::/etc/portage/package.use/texlive
app-text/texlive xetex games humanities publishers science pstricks png l10n_ru l10n_uk extra luatex graphics
app-text/texlive-core doc xetex
dev-texlive/texlive-publishers doc
dev-texlive/texlive-games doc 
dev-texlive/texlive-humanities doc
dev-texlive/texlive-langcjk doc
dev-texlive/texlive-langenglish doc
#+end_src

 =dev-texlive/texlive-fontsextra=

 =dev-texlive/texlive-langenglish=: Info documentation (docs) for LaTeX (inspired by [[id:ML:Org-mode-<theophilusx@gmail.com>2021-re-quick-latex-77d][Tim Cross [ML:Org mode] (2021) Re: A quick LaTeX reference guide in Org]]).

 *Important*: I had to manually install the relevant info file:
 #+begin_src bash :tangle no :dir /sudo::/ :eval yes
cd usr/share/texmf-dist/doc/info
install-info ./latex2e.info ./dir
 #+end_src
 
*** =latexmk=: easier building of TeX documents
:PROPERTIES:
:ID:       d0d3f76b-bf79-4c28-b138-77d879067455
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-tex/latexmk
#+end_src

*** Packages
**** biblatex: better citations
:PROPERTIES:
:ID:       10590568-83d5-44d7-8b36-3cfbe2af0323
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-tex/biblatex
#+end_src

**** #documentclass memoir: simple formatting :ATTACH:
:PROPERTIES:
:TITLE:    CTAN: /tex-archive/macros/latex/contrib/memoir
:BTYPE:    misc
:ID:       Ctan_ctan_tex_archiv_macros_latex_contr_memoir0a8
:CREATED:  [2021-04-04 Sun 12:23]
:HOWPUBLISHED: Ctan
:NOTE:     Online; accessed 04 April 2021
:URL:      https://www.ctan.org/tex-archive/macros/latex/contrib/memoir
:END:

 #margins #font_size #documentclass

 Manual: [[att-id:a1a9f26b-859a-419c-989a-3bd327822e0c:memoir/memman.pdf][memoir manual]]
*** =latexdiff=: View changes in generated pdf
:PROPERTIES:
:ID:       a81780d0-e515-4924-8c6a-0250281198a4
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-tex/latexdiff
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/latexdiff
dev-tex/latexdiff **
#+end_src
** Latex preview for Org =dvisvgm=
:PROPERTIES:
:ID:       1c5671ad-efb6-48e6-a1f2-92c9dc705234
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/dvisvgm
#+end_src

** Image viewer: feh
:PROPERTIES:
:ID:       6aad7973-ddd3-45be-a92c-16c4dac6d516
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-gfx/feh
#+end_src

Call wrapper: 
#+begin_src bash :tangle /home/yantar92/.local/bin/feh-open :shebang #!/bin/bash
DIRNAME="`dirname "$1"`"
if [[ -z "$DIRNAME" ]]; then DIRNAME="$PWD"; fi
FILENAME="`dirname "$1"`/`basename "$1"`"

# FILES="$(find "$DIRNAME/" -maxdepth 1 | sort)"
# FILENUMBER="$(echo "$FILES" | awk '{print NR" "$0}' | grep "$FILENAME" | cut -d' ' -f1)"
# FILENUMBER=$(echo "$FILENUMBER - 1" | bc -l)
# sxiv -n $FILENUMBER "$DIRNAME/"*
feh -d -B white --scale-down --auto-zoom --draw-exif --draw-tinted --edit --version-sort --start-at  "$FILENAME" "$DIRNAME" 2>&1 > /dev/null
#+end_src

Desktop file 
#+begin_src conf :tangle /home/yantar92/.local/share/applications/feh-open.desktop :mkdirp yes
[Desktop Entry]
Version=1.0
Type=Application
Name=feh-open
Exec=feh-open %f
TryExec=feh
Terminal=false
StartupNotify=true
MimeType=image/bmp;image/gif;image/x-tga;image/x-xbitmap;image/tiff;image/jpeg;image/x-psp;image/png;image/x-icon;image/webp;
#+end_src

** Music (mpd)
:PROPERTIES:
:ID:       f57fbfc1-caa7-4927-96e6-24201fc9d6ec
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-sound/mpd
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/mpd
media-sound/mpd libmpdclient pipe musepack wavpack
#+end_src

Also need =media-sound/mpc= to control.

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-sound/mpc
#+end_src

** Video
*** mpv
:PROPERTIES:
:ID:       db6f9fac-dc50-4668-a0c4-e5ff185ec436
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-video/mpv
#+end_src

Had to copy over the saved information from ~/.config/mpv/watch_later

#+begin_src conf :tangle /sudo::/etc/portage/package.use/mpv
media-video/mpv cli
#+end_src



**** Config
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 02:51]
:ID:       2c9568b7-4081-470c-b066-2beb126dbbed
:header-args+: :tangle no
:END:
***** Main config
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 03:08]
:header-args+: :tangle /home/yantar92/.config/mpv/mpv.conf :mkdirp yes
:END:

****** General
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 03:10]
:ID:       830c8bf2-3bd8-4002-a367-f4a075bc1826
:END:

Open window without waiting for video to load (relevant when opening online videos on high-ping connection). Do not auto-play for the same reason - sometimes I need to wait for a quite a long time and suddenly playing video would be a surprise.
#+begin_src conf
force-window=immediate
pause                                   # no autoplay
#+end_src

Save position 
#+begin_src conf
save-position-on-quit
#+end_src

Initial window placement: center
#+begin_src conf
geometry=1440x900+50%+50%
#+end_src

Save screenshots in =PNG= format into Downloads folder for further refiling. 
#+begin_src conf
screenshot-format=png
screenshot-template='~/Downloads/%F (%P) %n'
#+end_src

#+begin_src conf
keepaspect-window=no
loop-playlist=yes
msg-module                              # prepend module name to log messages
msg-color                               # color log messages on terminal
term-osd-bar                            # display a progress bar on the terminal
keep-open                               # keep the player open when a file's end is reached
#+end_src

****** Cache
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 03:10]
:ID:       87f0b98a-389f-466a-a4d6-7e9fe7719bc1
:END:

I prefer huge cache to preload online videos if possible. Connection is not always stable.
#+begin_src conf
cache=yes
cache-secs=1800                           # how many seconds of audio/video to prefetch if the cache is active
prefetch-playlist=yes
#+end_src

****** Subtitles
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 03:11]
:ID:       c082d9b8-5f57-493c-8976-45ad93e86dc7
:END:

Automatically detect subtitle file

#+begin_src conf
sub-use-margins
sub-auto=fuzzy                          # external subs don't have to match the file name exactly to autoload
sub-file-paths=ass:srt:sub:subs:subtitles    # search for external subs in the listed subdirectories
embeddedfonts=yes                       # use embedded fonts for SSA/ASS subs
sub-fix-timing=no                       # do not try to fix gaps (which might make it worse in some cases)

# the following options only apply to subtitles without own styling (i.e. not ASS but e.g. SRT)
sub-font="Helvetica"
sub-font-size=36
sub-color="#FFFFFFFF"
sub-border-color="#FF262626"
sub-border-size=3.2
sub-shadow-offset=1
sub-shadow-color="#33000000"
sub-spacing=0.5
#+end_src

****** Languages
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 03:11]
:ID:       bf046814-3fbe-4331-a186-58881064fff2
:END:

#+begin_src conf
slang=enm,en,eng,ru             # automatically select these subtitles (decreasing priority)
alang=enm,en,ang,ru       # automatically select these audio tracks (decreasing priority)
#+end_src

****** Audio
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 03:11]
:ID:       7fc2f67a-16cf-411a-8804-bd11f354309c
:END:

#+begin_src conf
af=scaletempo=speed=tempo:stride=30
audio-file-auto=fuzzy                   # external audio doesn't have to match the file name exactly to autoload
#+end_src

****** Protocols
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 03:11]
:ID:       5752739c-70b7-4bf3-9cc6-49610cd47d05
:END:

=yt-dlp=

#+begin_src conf
script-opts=ytdl_hook-ytdl_path=/usr/bin/yt-dlp
ytdl-raw-options=format="[protocol!=http_dash_segments][protocol!=rtmp]",all-subs=,mark-watched=,no-check-certificate=
ytdl-format=bestvideo[height<=1080][vcodec=vp9][fps>=60]+bestaudio/bestvideo[height<=1080][vcodec=vp9]+bestaudio/bestvideo[height<=1080]+bestaudio/best[height<=1080]/best

[360p]
ytdl-format=bestvideo[height<=360][vcodec=vp9]+bestaudio/bestvideo[height<=360]+bestaudio/best[height<=360]/best

[480p]
ytdl-format=bestvideo[height<=480][vcodec=vp9]+bestaudio/bestvideo[height<=480]+bestaudio/best[height<=480]/best

[720p]
ytdl-format=bestvideo[height<=720][vcodec=vp9][fps>=60]+bestaudio/bestvideo[height<=720][vcodec=vp9]+bestaudio/bestvideo[height<=720]+bestaudio/best[height<=720]/best
#+END_SRC

#+BEGIN_SRC conf  
[protocol.https]
user-agent='Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:47.0) Gecko/20100101 Firefox/47.0'

[protocol.http]
user-agent='Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:47.0) Gecko/20100101 Firefox/47.0'

[extension.gif]
cache=no
no-pause
loop-file=yes
#+end_src

***** Key bindings
:PROPERTIES:
:header-args+: :tangle /home/yantar92/.config/mpv/input.conf
:ID:       e7397414-188d-47eb-9388-c06bcb4dffd2
:END:

#+begin_src conf
ctrl+q quit
q ignore
#+end_src

***** User-scripts
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 02:51]
:ID:       898b5aa0-6f6e-4280-bd44-cc424436a81d
:END:
****** YouTube
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 02:51]
:ID:       81208c2c-19ef-432e-88d4-4ab7bcc3d762
:END:
******* Change quality :ATTACH:
:PROPERTIES:
:CREATED:  [2019-12-15 Sun 02:52]
:ID:       d745535d-faf9-4ab2-b39c-89b8c6087c44
:END:
****************** SOMEDAY save repo separately :SOMEDAY:
****************** END
:PROPERTIES:
:ID: edfcf73c-fdec-4173-bf83-dc0fa2e07810
:END:

=C-f= to call menu.

https://github.com/jgreco/mpv-youtube-quality

#+name: get-file
#+begin_src bash :tangle no :results output silent :var file=(concat (progn (require 'org-attach) (org-attach-dir)) "/mpv-youtube-quality/youtube-quality.lua") :cache yes :results none
cat $file
#+end_src

#+begin_src lua :tangle /home/yantar92/.config/mpv/scripts/youtube-quality.lua :mkdirp yes :noweb yes
<<get-file()>>
#+end_src

#+begin_src conf :tangle /home/yantar92/.config/mpv/lua-settings/youtube-quality.conf :mkdirp yes
# KEY BINDINGS

# invoke or dismiss the quality menu
toggle_menu_binding=ctrl+f
# move the menu cursor up
up_binding=Alt+k
# move the menu cursor down
down_binding=Alt+j
# select menu entry
select_binding=Ctrl+j

# formatting / cursors
selected_and_active= - 
selected_and_inactive= - 
unselected_and_active= - 
unselected_and_inactive= - 

# font size scales by window, if false requires larger font and padding sizes
scale_playlist_by_window=yes

# playlist ass style overrides inside curly brackets, \keyvalue is one field, extra \ for escape in lua
# example {\\fnUbuntu\\fs10\\b0\\bord1} equals: font=Ubuntu, size=10, bold=no, border=1
# read http://docs.aegisub.org/3.2/ASS_Tags/ for reference of tags
# undeclared tags will use default osd settings
# these styles will be used for the whole playlist. More specific styling will need to be hacked in
#
# (a monospaced font is recommended but not required)
style_ass_tags={\\fnmonospace}

# paddings for top left corner
text_padding_x=5
text_padding_y=5

# how many seconds until the quality menu times out
menu_timeout=10

#use youtube-dl to fetch a list of available formats (overrides quality_strings)
fetch_formats=yes

# list of ytdl-format strings to choose from
quality_strings=[ {"4320p" : "bestvideo[height<=?4320p]+bestaudio/best"}, {"2160p" : "bestvideo[height<=?2160]+bestaudio/best"}, {"1440p" : "bestvideo[height<=?1440]+bestaudio/best"}, {"1080p" : "bestvideo[height<=?1080]+bestaudio/best"}, {"720p" : "bestvideo[height<=?720]+bestaudio/best"}, {"480p" : "bestvideo[height<=?480]+bestaudio/best"}, {"360p" : "bestvideo[height<=?360]+bestaudio/best"}, {"240p" : "bestvideo[height<=?240]+bestaudio/best"}, {"144p" : "bestvideo[height<=?144]+bestaudio/best"} ]
#+end_src

#+RESULTS[33e778796fc04ae9b0a18b218e68bf5c5d3a404d]:
*** Annie - better than youtube-dl for bilibili

[[id:3ae439f24f6fba59189a9b254cab318c6fb26352][muzea [Github] annie:  Fast, simple and clean video downloader]]

*** =yt-dlp=: maintained fork of =youtube-dl=
:PROPERTIES:
:ID:       4e9a200f-ce5f-466a-bcbe-a2f70a2f21d1
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-misc/yt-dlp
#+end_src

** COMMENT =Hypothes.is= annotation server
*** Install

[[id:c469e0bf6a70756236001d62dc6c42b52285ae90][[H.Readthedocs] Installing h in a development environment  h 0.0.2 documentation]]

**** Install npm, [[id:8abca0b9-a070-4362-ab0b-abe6bafaddae][docker]], *docker-compose,* and pyenv
:PROPERTIES:
:ID:       9842c841-0a74-4dfd-8fe5-3c5f250a6a61
:END:

=pyenv= is not available in repos. Need to install manually.
[[id:8b0269a50cf6bf187c5c5616f8891c2e3d00e6b0][pyenv [Github] pyenv: Simple Python version management]]

Installing using [[id:1117a1b523eeec52a7952c4905f676407269b61e][pyenv [Github] pyenv-installer: This tool is used to install `pyenv` and friends.]]
*The notes about uninstalling are on the same page*

#+begin_src bash :tangle /home/yantar92/.bashrc
export PATH="/home/yantar92/.pyenv/bin:$PATH"
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"
#+end_src
**** Install server https://github.com/hypothesis/client/
:PROPERTIES:
:ID:       1b0737b8-fe42-4e27-850d-d518d523a419
:END:

#+begin_src bash :tangle no
make services
#+end_src

Note that docker may error-out complaining about IPv4 address. It is because VPN is running. It needs to be stopped when docker is called.


*The following does not work*
Also, need to install =psycopg=
#+begin_src bash :tangle no
make devdata
#+end_src

Need to use [[id:988dd2e65225cd72359febd3c6502c89e18d6d40][[H.Readthedocs] Manually setting up the Hypothesis client integration  h 0.0.2 documentation]]
#+begin_src bash :tangle no
make dev
#+end_src

Now, server is running at http://localhost:5000/
Need to create admin user first [[https://h.readthedocs.io/en/latest/developing/administration/][Accessing the admin interface  h 0.0.2 documentation]]
#+begin_src bash :tangle no
pyenv global 3.6.9
cd ~/Dist/h
tox -qe dev -- sh bin/hypothesis --dev user add
tox -qe dev -- sh bin/hypothesis --dev user admin yantar92
#+end_src

Username: yantar92; password:easy

Restart server
#+begin_src bash :tangle no
make dev
#+end_src
*Login from the web-page*

Open http://localhost:5000/admin/oauthclients

ID: [[id:75e9fa6a-9f31-4de0-8f85-fbaa7a41f5e5][Client id]]

#+begin_src bash :tangle no
export CLIENT_OAUTH_ID=<THE_CLIENT_ID_OF_THE_OAUTH_CLIENT_YOU_CREATED_ABOVE>
export CLIENT_URL=http://localhost:3001/hypothesis
# may need https, see below
#+end_src


***** Client id :crypt:
:PROPERTIES:
:ID:       75e9fa6a-9f31-4de0-8f85-fbaa7a41f5e5
:END:

-----BEGIN PGP MESSAGE-----

hQEMA3SKBiQ2zhL6AQf+JwMlPK4fWqyZOFjPpCm55+2rCej1M3z/vTNYMTwMj9AP
kZ4/4rzJ0G/sbxoWXjTlQCeByJjvMXBMlDTWm5iqJkSumj1vn95Ts+Iq8QPF7FiX
BPBOfvcSLgH5+mpwDXmk5qiA6LIKKAOr5Y87O5GH1td+SFHKlj9tiGfaDgBpFSFA
gio+aMYLF4BLefLNfvYHG06uapD/d4uS+sNCzVQGGd7/bEiQg8gE7Mh/fu4WaqMM
JLGiBrIhxL+G2ygm5/t/1OT1xjGwEHY6MiTLX356XwytKvx2gZ1O+e46wuaidVa5
bHrTJoSCBFUDVUADTQYpzKgsl+S6bW2XYnskg1857dJuAcnqmvUx1AgUYbyvMFxC
GM4JqJ5U1R/R0q5KGxP87EI/7Y0Zg7PRWDPedySS53pP2+CwNK0j5rBSI+yMlNvp
uvvZ5m03RfMo3JsmMBzDlsqdh7F0DshetEb5qo+JX5h6iB2x86Uy5SsYqC7ndEM=
=PIof
-----END PGP MESSAGE-----
***** API Token :crypt:

-----BEGIN PGP MESSAGE-----

hQEMA3SKBiQ2zhL6AQf/XrqdBAdAMvxU7XSy0i+ju/5mplN85Vp2P7vw2tIBaREw
uXC3LRiCGaWJb+WLVRPf0LKYdaNVCUD2pm1ohyr4fmynfjW6zb+ZlQOSw132s2r3
kzZxNMuI//i/9o0pQQBB9zRVhb5ChdS87XJVbVd4POniQ2x6leIfmlJ97aunmEQS
ugFNhsKSPwcuR0HDt50mcYWe2UXavN1tQKWP4jGy95ff4iu2sLlD0TN3ZebI7Q8N
6SCzIqOH2BSoyaIBVI/GlKeV6k2wVGc+D8c45fqPFLaDZciuu3iCUyl8J5TclmkH
PK1MJg8dmJOdLy3cW3XxWo/8SkKs1nYSTI0DTjHC19JvAd63uxnR74ywfMybK+ZG
8rMnhb9OB/Gtn8YJJ+tX6fmWbRJ51zI2rMJWt05VW7wlsIiXaRRK2TdcoFNHu19d
Ep82Sqxvm6yPDhtRnRUuvEBypmmDYssKlshMJYap+OPVdRQkXFwxamFVBjgbB+T0
=938x
-----END PGP MESSAGE-----
**** Install client  [[id:849188124da0aefe4334694a0301421b57c9b943][hypothesis [Github] client: The Hypothesis web-based annotation client.]]

[[id:7a29773fd241d87fe884443831eee02456689518][[H.Readthedocs] Developing the Client  Hypothesis Client 1.0.0 documentation]]

Need yarn.
**** Configure HTTPS access to the running server
:PROPERTIES:
:ID:       ec1a1a2b-9d3b-448f-983e-2c48bc86fb6d
:END:

This is needed because I would not be able to load javascript from local http server into https website - browser would refuse to load for security reasons.

[[id:6b3f94b8dd2f0f2a622f2f454a48873e9eee2d2f][[H.Readthedocs] Serving h over SSL in development  h 0.0.2 documentation]]

#+begin_src bash :tangle no
cd ~/Dist/h
# openssl req -newkey rsa:1024 -nodes -keyout .tlskey.pem -out .tlscsr.pem
# openssl x509 -req -in .tlscsr.pem -signkey .tlskey.pem -out .tlscert.pem
export CLIENT_OAUTH_ID=<THE_CLIENT_ID_OF_THE_OAUTH_CLIENT_YOU_CREATED_ABOVE>
export CLIENT_URL=https://localhost:3001/hypothesis
make devssl
#+end_src

#+begin_src bash :tangle no
cd ~/Dist/client
openssl req -newkey rsa:1024 -nodes -keyout .tlskey.pem -out .tlscsr.pem
openssl x509 -req -in .tlscsr.pem -signkey .tlskey.pem -out .tlscert.pem
export CLIENT_OAUTH_ID=<THE_CLIENT_ID_OF_THE_OAUTH_CLIENT_YOU_CREATED_ABOVE>
export CLIENT_URL=https://localhost:3001/hypothesis
make dev
#+end_src

**** TODO Package into docker
**** TODO Intercept annotation calls to raise capture template, add captured annotation, and push it to the hyposes.is server
**** TODO Push changes annotations from org to h-server

** Wine
:PROPERTIES:
:ID:       e509984f-3715-43a3-8d73-2bf99a82db2d
:END:

- use latest version
#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/wine
app-emulation/wine-proton ~amd64
app-emulation/wine-staging ~amd64
#+end_src

- install samba with =winbind= =useflag= - needed for some programs

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-fs/samba
app-emulation/wine-proton
app-emulation/wine-staging
app-emulation/dxvk
app-emulation/vkd3d-proton
#+end_src

#+begin_src bash :tangle no :eval no
setup_dxvk.sh install --symlink
setup_vkd3d_proton.sh install --symlink
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/samba
net-fs/samba winbind
#+end_src

** Scientific image manipulation: Fiji \ [[id:5aa36a1d631ea6266284bbc74d3591217237a36a][[Imagej] ImageJ]]
** COMMENT Archivebox
:PROPERTIES:
:ID:       269904a8-3bb6-4e9e-a385-2e2b2c980879
:END:

[[id:9598a00b34cc76a635228df65b3ecd1a9a194498][ArchiveBox [Github] ArchiveBox:  The open source self-hosted web archive. Takes browser history/bookmarks/Pocket/Pinboard/etc., saves HTML, JS, PDFs, media, and more...]]

Instruction:
[[id:a64393ccd93411fa51d5b9dc5c3438e1ddbb0fb7][ArchiveBox [Github] ArchiveBox Wiki]]

#+begin_src bash :tangle no
mkdir ~/.data/web-mirror
cd ~/.data/web-mirror
docker run -v $PWD:/data -it archivebox/archivebox init
#+end_src

Do not download youtube, and upload to archive.org (privacy)
#+begin_src bash :tangle no 
cd ~/.data/web-mirror
docker run -v $PWD:/data -it -p 8000:8000 archivebox/archivebox config --set SAVE_MEDIA=False
#+end_src

Increase default download timeout. My internet is not that fast over VPN
#+begin_src bash :tangle no 
cd ~/.data/web-mirror
docker run -v $PWD:/data -it -p 8000:8000 archivebox/archivebox config --set TIMEOUT=600
#+end_src

Script to run =archivebox=
#+begin_src bash :tangle /home/yantar92/.local/bin/archivebox :shebang #!/bin/bash
cd ~/.data/web-mirror
docker run -v $PWD:/data -it -p 8000:8000 archivebox/archivebox $*
#+end_src

Noninteractive script (suitable to pass io pipe to)
#+begin_src bash :tangle /home/yantar92/.local/bin/archivebox-cmd :shebang #!/bin/bash
cd ~/.data/web-mirror
docker run -v $PWD:/data -i -p 8000:8000 archivebox/archivebox $*
#+end_src


** Zoom (video conference) =net-im/zoom=
:PROPERTIES:
:ID:       e260391c-aa79-4d7b-a55d-6790cc94b40d
:END:
[[id:34c0096a61b89a7a56c1b8670552140048d01367][[Zoom] Video Conferencing, Web Conferencing, Webinars, Screen Sharing - Zoom]]

I don't like it, but it is what I have to use
#+begin_src conf :tangle /sudo::/etc/portage/package.license/zoom :mkdirp yes
net-im/zoom all-rights-reserved
#+end_src

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-im/zoom
#+end_src
** GNU Screen (for Org mode ob-screen testing)

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-misc/screen
#+end_src


** Music editing

*** Split =flac= file according to =cue= playlist
:PROPERTIES:
:ID:       8530661e-c109-46c4-b118-b115751f8834
:END:

Using =media-sound/shntool= 

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-sound/shntool
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/shntool
media-sound/shntool alac flac wavpack
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/flacsplit.sh :shebang #!/bin/bash :mkdirp yes
[[ $# == 2 ]] && shnsplit -f "$1" -o flac -t "%n-%t" "$2" || echo "Wrong number of arguments: specify cue file and flac file"
#+end_src

** Video editing
*** Convert video to format suitable for LibreOffice impress
:PROPERTIES:
:ID:       2549d80f-7d3f-4840-8daf-842985bd0f1b
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/video2libreoffice.sh :shebang #!/bin/bash
help() {
    echo "\
Convert video to the ogg vorbis format acceptable to insert into libreoffice imrpess presentations
Usage: $0 [-h] [-vq NUM] [-aq NUM] <input file> [output file.ogv]
-h|--help: show help
-vq <0-10>: video quality, default - 7
-au <0-10>: audio quality, default - 5"
    }
VQ="7";
AQ="5";
INPUT="";
OUTPUT=""
PARSE=0
while [[ "$PARSE" == "0" ]]; do
    case "$1" in
	-h|--help)
	    help
	    exit 1
	    ;;
	-vq)
	    shift
	    if [[ $! =~ '^[0-9]+$' ]]; then
		VQ="$1";
	    else
		echo "Not a number: $1";
		exit 1;
	    fi
	    shift
	    ;;
	-aq)
	    shift;
	    if [[ $! =~ '^[0-9]+$' ]]; then
		AQ="$1";
	    else
		echo "Not a number: $1";
		exit 1;
	    fi
	    shift
	    ;;
	*)
	    PARSE=1;
	    break
	    ;;
    esac
done
INPUT="$1";
if [[ ! -f "$INPUT" ]]; then
    echo "File does not exist: \"$INPUT\"";
    exit 1;
fi
shift;
(( $# > 0 )) && OUTPUT="$1" && shift
OUTPUT=${OUTPUT:-${INPUT%.*}.ogv}
[[ ! "${OUTPUT##*.}" == "ogv" ]] && echo "Output file \"$OUTPUT\" should have ogv extension" && exit 1
(( $# > 0 )) && echo "Too many arguments: $*" && exit 1
ffmpeg -hide_banner -i "$INPUT" -codec:v libtheora -qscale:v $VQ -codec:a libvorbis -qscale:a $AQ "$OUTPUT"
#+end_src

*** Speed up video
:PROPERTIES:
:ID:       a6f9dad3-d8dd-4644-b38b-4545865ce0a3
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/video_speed.sh :shebang #!/bin/bash
help="Change video speed
Usage: $0 [-h|--help] [-an] [-o output] [-fps FPS] input_file speed_multiplier
-an: remove audio
-o: specify output (default: [speed_multiplierx]input_file)
-fps: specify fps (default: preserve all the frames)
-h|--help: show help"
[[ $# < 2 ]] && echo "$help" && exit
while [ "$#" -gt "2" ]; do
    case "$1" in
	"-an")
	    OPT="-an"
	    shift
	    ;;
	"-o")
	    output_file="$2"
	    shift
	    shift
	    ;;
	"-fps")
	    FPS="$2"
	    [[ ! "$FPS" -eq "$FPS" ]] && echo "Not a number: $FPS" && echo "$help" && exit
	    shift
	    shift
	    ;;
	"-h"|"--help")
	    echo "$help"
	    exit
	    ;;
	,*)
	    echo "Unknow argument: #1"
	    echo "$help"
	    exit
	    ;;
    esac
done
input_file="$1"
mult="$2"
[[ -z "$output_file" ]] && output_file="[${mult}x]`basename \"$input_file\"`"
[[ -z "$FPS" ]] && FPS="`ffprobe \"$input_file\" 2>&1 | grep -oe \"[0-9]* fps\" | grep -oe \"[0-9]*\"`" && FPS="`echo \"$FPS * $mult\" | bc -l`"
INV="`echo \"1 / $mult\" | bc -l`"
if [[ "$OPT" == "-an" ]]; then
    ffmpeg -hide_banner -i "$input_file" $OPT -r $FPS -filter_complex "[0:v]setpts=$INV*PTS" "$output_file"
else
    ffmpeg -hide_banner -i "$input_file" -r $FPS -filter_complex "[0:v]setpts=$INV*PTS; [0:a]asetpts=$INV*PTS" "$output_file"
fi

#+end_src

*** Convert video to =mkv= without lossy compression
:PROPERTIES:
:ID:       9397fe0e-b247-4b79-9f42-94ec251591f3
:END:

I need this for research videos where lossy compression is not acceptable.
Assumes that =mkv= format is supported.

#+begin_src conf :tangle /sudo::/etc/portage/package.use/ffmpeg
media-video/ffmpeg x264
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/video2mkv.sh :shebang #!/bin/bash
[[ $# = 2 ]] && ffmpeg -v error -hide_banner -i "$1" -f lavfi -i "anullsrc=cl=1" -shortest -crf 0 -filter_complex  "[0:v]scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:v libx264 "$2" || echo "Wrong number of arguments. Usage: video2mkv.sh input_file output_file"
#+end_src 

*** Convert video to raw avi format without lossy compression
:PROPERTIES:
:ID:       b3926f2f-eb44-4557-96d0-2615a977c1d1
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/video2rawavi.sh :shebang #!/bin/bash
function help() {
    echo "Usage: video2rawavi.sh input_file [output_file]" 
}
if [[ $# < 1 || $#>2 ]]; then
    echo "Wrong number of arguments: $#";
    help
    exit
fi
output=""
[[ $# = 1 ]] && output="$(echo $1 | sed -r 's/\.[^.]+$/\.avi/')"
if [[ ! -f "$1" ]]; then
    echo "File \"$1\" does not exists";
    exit;
fi
[[ $# = 2 ]] && output="$2";
[[ -z "$output" ]] || ffmpeg -v error -hide_banner -i "$1" -c:v rawvideo -pix_fmt bgr24 "$output"
#+end_src

*** Concat several videos into one
:PROPERTIES:
:ID:       1f6c74af-5247-49c7-ab00-1c33705c8527
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/video_concat.sh :shebang #!/bin/bash
INPUT=""
OUTPUT=""
while [[ $# > 1 ]]; do
    [[ -z "$INPUT" ]] && INPUT="file '$1'" || INPUT="${INPUT}
file '${1}'"
    shift
done
OUTPUT="$1"
echo -e "$INPUT" > list.txt
ffmpeg -f concat -safe 0 -i list.txt -c copy "$OUTPUT"
rm list.txt
#+end_src

*** Extract segment from a video
:PROPERTIES:
:ID:       c4839d2a-239b-4d0a-8395-9440bc98917f
:END:

#+begin_src bash :tangle /home/yantar92/.local/bin/video_cut.sh :shebang #!/bin/bash
#!/bin/bash
function help() {
    echo "$(basename $0): Clip video
    Usage: $0 [-o output] [--from start_position] file duration
    Defaults: start_position=0, output=[clipped]file"
}
[[ $# < 2 ]] && echo "Too less arguments" && help && exit
while [[ $# > 0 ]]; do
    case "$1" in
	"-h"|"--help")
	    help
	    exit
	    ;;
        "-o")
	    output="$2"
	    shift
	    ;;
        "--from")
	    start="$2"
	    shift
	    ;;
        *)
	    file="$1"
	    if [[ ! -f "$file" ]]; then
		echo "File not found \"$file\""
                exit
	    fi		
	    duration="$2"
	    [[ -z "$output" ]] && output="$(dirname "$file")/[clipped]$(basename "$file")"
	    shift
	    ;;
    esac
    shift
done
ffmpeg $([[ -z "$start" ]] || echo "-ss $start") -i "$file" -c copy -t $duration "$output"
#+end_src

*** Extend video duration to some target
:PROPERTIES:
:ID:       b85beada-502d-4747-ab2c-19aaf01e1d0c
:END:

This is useful helper script when I need to combine several videos side-by-side.

#+begin_src bash :tangle /home/yantar92/.local/bin/video_elongate.sh :shebang #!/bin/bash
function help() {
    echo "$(basename $0): extend video duration by repeating the last frame
    Usage: $0  [-o video_output] video_file new_time
    new_time: [hours]:[minutes]:seconds
    -o: specify output file name (default: [new_time]video_file)"
}

hours=0
minutes=0
seconds=0.1

function parse_duration () {
    regexp_full="(([0-9]+):)(([0-9]+):)([0-9]+(\.[0-9]+)?)"
    regexp_nohours="(([0-9]+):)([0-9]+(\.[0-9]+)?)"
    regexp_onlyminutes="([0-9]+(\.[0-9]+)?)"
    full="$(echo "$1" | grep -E "$regexp_full")"
    nohours="$(echo "$1" | grep -E "$regexp_nohours")"
    onlyminutes="$(echo "$1" | grep -E "$regexp_onlyminutes")"
    if [[ ! -z "$full" ]]; then
	parsed_duration="$(echo "$1" | sed -r "s/$regexp_full/\2 \4 \5/")"
    elif [[ ! -z "$nohours" ]]; then
		parsed_duration="$(echo "$1" | sed -r "s/$regexp_nohours/0 \2 \3/")"
    elif [[ ! -z "$onlyminutes" ]]; then
	parsed_duration="$(echo "$1" | sed -r "s/$regexp_onlyminutes/0 0 \1/")"
    else
        echo "Wrong duration: \"$1\"" && exit
    fi
    hours=$(echo "$parsed_duration" | awk '{print $1}')
    minutes=$(echo "$parsed_duration" | awk '{print $2}')
    seconds=$(echo "$parsed_duration" | awk '{print $3}')
}

[[ $# < 2 ]] && help && exit
output_file=""
while [[ $# > 0 ]]; do
    case "$1" in
	"-o")
	    output_file="$2"
	    shift
	    shift
	    ;;
        "-h"|"--help")
	    help
	    exit
	    ;;
	*)
	    input_file="$1"
	    new_duration="$2"
	    [[ -z "$output_file" ]] && output_file="$(dirname $input_file)/[$new_duration]$(basename $input_file)"
	    shift
	    shift
	    ;;
    esac
done
if [[ ! -f "$input_file" ]]; then
    echo "File not found: \"$input_file\"";
    exit
fi

duration=$(ffprobe "$input_file" 2>&1 | grep -Eo "Duration: [^,]+" | sed -r 's/Duration: //')
parse_duration "$duration"
duration_sec=$(echo "${hours}*60*60+${minutes}*60+$seconds" | bc -l)
parse_duration "$new_duration"
new_duration_sec=$(echo "${hours}*60*60+${minutes}*60+$seconds" | bc -l)
[[ "$(echo "$new_duration_sec < $duration_sec")" == "1" ]] && echo "New duration (\"$new_duration\") is smaller than video duration (\"$duration\")" && exit

fps="$(ffprobe $input_file 2>&1 | grep -Eo "[0-9]+ fps" | cut -d' ' -f1)"
last_frame="$(echo "${fps}*${duration_sec} - 1" | bc -l | sed -r 's/\..+//')"


ffmpeg -i "$input_file"  -vf "select='eq(n,$last_frame)'" -vframes 1 /tmp/last_frame.png &&\
    ffmpeg -loop 1 -i /tmp/last_frame.png -c:v libx264 -r $fps -t $(echo "$new_duration_sec - $duration_sec" | bc -l | sed -r 's/^\./0\./') -pix_fmt yuv420p /tmp/last_frame.mp4 &&\
    video_concat.sh "$input_file" /tmp/last_frame.mp4 "$output_file" && rm /tmp/last_frame.png /tmp/last_frame.mp4
#+end_src

** Conversion

*** =djvu= to pdf
:PROPERTIES:
:ID:       6f8f6227-627f-4766-89ca-42534e816476
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/djvu
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/djvu2pdf.sh :shebang #!/bin/bash
INPUT="$1"
if [[ ! -f "$INPUT" ]]; then
   echo "File not exist \"$INPUT\""
   exit 1
fi
OUTPUT="$2"
if [[ -f "$2" ]]; then
    echo "File exists \"$2\""
    exit 1
fi
OUTPUT=${OUTPUT:-${INPUT%.*}.pdf}
djvups "$INPUT" "/tmp/$(basename \"$INPUT\").ps" && ps2pdf "/tmp/$(basename \"$INPUT\").ps" "$OUTPUT" && rm "/tmp/$(basename \"$INPUT\").ps" || (echo "Something wrong"; exit 1)
#+end_src

** Presentation setup: silence unnecessary notifications
:PROPERTIES:
:ID:       9af20ece-11c4-4db7-b4a3-5627b10b94e3
:END:

It is extremely bad idea to show distracting notifications during presentation. The script below tries to connect projector, stop all composition (to avoid any possible glitches), stops conky, and notifies all relevant scripts that projecting is in progress.

Also, I need to install =x11-apps/xrandr= to control plugged projector.

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-apps/xrandr
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/project.sh :shebang #!/bin/bash
xrandr --output HDMI-1 --auto --right-of eDP-1
pgrep conky && conky-stop
echo "true" > ~/.log/projecting
balance-monitor.sh
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/unproject.sh :shebang #!/bin/bash
xrandr --output HDMI-1 --off
# conky-start
echo "false" > ~/.log/projecting
balance-monitor.sh
#+end_src

** Backup
:PROPERTIES:
:ID:       838d522e-c654-43ab-9b90-cbb2392812c6
:END:

[2020-12-25 Fri] Switching to [[id:aa43745e-4d5a-4500-bf22-fa6db3733519][restic]]
#+name: backup-opts
#+begin_src emacs-lisp :results raw silent :eval yes
yant/backup-script-opts
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/backup-local.sh :shebang #!/bin/bash :noweb tangle
# Store to incremental backup
while true; do
    read -p "Sync with local backup? " yn
    case $yn in
        [Yy]* ) restic -r /mnt/Backup/Backup/  <<backup-opts()>> backup /home/yantar92; break;;
        [Nn]* ) break;;
        ,* ) echo "Please answer yes or no.";;
    esac
done
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/backup-remote.sh :shebang #!/bin/bash :noweb tangle
# Sync with remote
while true; do
    read -p "Sync with remote backup? " yn
    case $yn in
        [Yy]* ) restic -r rclone:backup:Backup <<backup-opts()>> --password-command "gpg -q  --for-your-eyes-only -d /home/yantar92/.password-store/restic-remote.gpg" backup /home/yantar92/; break;;
        [Nn]* ) break;;
        ,* ) echo "Please answer yes or no.";;
    esac
done
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/backup-archive-to-remote.sh :shebang #!/bin/bash :noweb tangle
# Upload local archive to remote
while true; do
    read -p "Copy archive to remote backup? " yn
    case $yn in
        [Yy]* ) rclone /mnt/Backup/Archive/ archive:; break;;
        [Nn]* ) break;;
        ,* ) echo "Please answer yes or no.";;
    esac
done
#+end_src


#+begin_src bash :tangle ~/.local/bin/backup-full.sh :shebang #!/bin/bash
backup-mount.sh
/home/yantar92/.local/bin/backup-local.sh
/home/yantar92/.local/bin/backup-archive-to-remote.sh
backup-umount.sh
/home/yantar92/.local/bin/backup-remote.sh
#+end_src

#+begin_src bash :tangle /sudo::/etc/cron.daily/backup :shebang #!/bin/bash :noweb tangle
SHELL=/bin/bash
PATH=/bin:/usr/bin:/home/yantar92/.local/bin
HOME=/home/yantar92
DISPLAY=:0
echo "yes" | /home/yantar92/.local/bin/backup-remote.sh
#+end_src


[2020-12-22 Tue] trying encrypted backup using [[id:aa43745e-4d5a-4500-bf22-fa6db3733519][restic]].

*** Mounting the backup drive :crypt:TANGLE:
:PROPERTIES:
:ID:       6670b7af-3aac-440a-ad6e-033daae3c22e
:END:

-----BEGIN PGP MESSAGE-----

hQEMA3SKBiQ2zhL6AQf/drFWf6lMeo3Be7S5/RxwKq9F0fK24yFjIXTV/cRLu6/9
m7b9t2JIwqU73+WtIOaHzWLxueMGCstS/tR0qIJQZ9AmHrDeH4BhbysI6wREB/xU
xy6Rp62CvhPnCBKYHPUEXRTuTJEdvXGdXjEzJfbIVQ0+GqrurFNnxfEQwNMvkR7a
IW+ynV4uoSdZ5YV0cCUu11BlozFo4fyuRkI4a3JKfXUEUm6F3bjfGXoTOPfKIPQb
qOOQVxYHVTfaw54O6XYh5/+uCrN0VFpsWiYOev/f/cOJ32mUleFEyRtorT0Pw+XI
SPi18qbE79JR2KVpNc+UsrOyLbB+Qyaq8xLlaN/cfdLArgE7q68Z+UKJ7p6/r8IZ
ltjgQtIxtSzwT0t5tvQesgSo4n5mOIngEmgH9odACDPYDYeVOx9PBUXIWXfxUwmv
0QR7D5G1ZnfHzrHI/wuIqAlv2F4MlPF/yC5leZXKXkRBZB1CH/nlRrXJiAVQPwep
81ovQFgXoXfIpIwTr+O1gkQy8HZy+27z41hpwKEOf0txzkVNlKFCN3WQQds05bwS
2w+NpgiJKnoILVq/NzGLhlcxHwKkb8H/6dFcnb0yrm+Op1DTG3fyg2A1p2pF0TCS
hlNn2TNwekNK7DWbCXRRtDgV/Hl2LE9q+uPMzjmT3W7tPw96b/3To6HUOZhyK0DJ
wCseE5UPFgpfs56IxbdzpaQVqjykV3i8L5wTxwg/ZidAZDQaOA9PcvNDKkzaOoV9
LlnqNEL7U4g7ueEr9S4LArkfyiSqedTJwg+u5vXUFCbSXFqx+PiOUW90mg1NJEem
WD/2EaTlhY+Jr0BLCQazZQ==
=ANDB
-----END PGP MESSAGE-----
*** Mounting Nextcloud via davfs
:PROPERTIES:
:ID:       f44a5bbf-158b-40b2-b0ad-227c8204afe8
:END:
Need =net-fs/davfs2=

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-fs/davfs2
#+end_src

*** Syncing backup with remote via =net-misc/rclone=
:PROPERTIES:
:ID:       31cd89eb-259a-4539-bc63-c8076244eab1
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-misc/rclone
#+end_src

** Midnight commander
:PROPERTIES:
:ID:       2b9cffa1-fe20-4d50-89cf-721fa415db3b
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-misc/mc
#+end_src

Mostly used to access ftp.
****************** TODO Should figure out how to used dired
****************** END

** Screencasting
:PROPERTIES:
:ID:       ce5a7514-0660-4ffe-b1bf-f74175ff06ff
:END:

Using (pip) =screenkey= + =media-video/peek=

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-video/peek
#+end_src

#+begin_src bash :dir /sudo::/ :eval yes
pip install screenkey
#+end_src

****************** TODO Note the screenkey repo
****************** END

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/peek
media-video/peek ~amd64
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/screencast :shebang #!/bin/bash
screenkey &
peek;
ps aux | grep screenkey | awk '{print $2}' | xargs kill
#+end_src

** =Coolreader=: reading =fb2= and other ebooks
:PROPERTIES:
:ID:       739ebe05-104f-4648-87ab-b4ee05bf49e9
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/coolreader
#+end_src

** pdf manipulation: pdftk
:PROPERTIES:
:ID:       65ac0940-11aa-4d3b-8f61-6333801ff02a
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/pdftk
#+end_src

** xyscan: analyse scientific plot images to extract data
:PROPERTIES:
:ID:       2a24f3e4-26ff-46f0-bd53-7a40777461f4
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sci-visualization/xyscan
#+end_src

** pandoc: convert between text and document formats
:PROPERTIES:
:ID:       43223a1f-02b7-4ae7-a69f-281837257115
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/pandoc
#+end_src

** =app-text/djvu= for rare cases when I need to read of convert djvu files
:PROPERTIES:
:ID:       41575d24-fe6e-402b-9588-17d048e7774e
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/djvu
#+end_src
** =www-client/surfraw= for [[id:d388e4f5-214e-4697-a53a-be6fb6c24411][Emacs helm]] integration
:PROPERTIES:
:ID:       1b4c94d2-1748-40b1-8daf-cf49b11b7fa1
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
www-client/surfraw
#+end_src

** Remap control, shift, and caps (using =x11-aps/xmodmap=)
:PROPERTIES:
:ID:       4746b326-3ecf-4ba8-a8a2-c784bc4c9cc9
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-apps/xmodmap
#+end_src

[[id:Emacswiki_emacs_swap_contr_alt_and_caps_lockfef][[Emacswiki] EmacsWiki: Swap Control Alt And Caps Lock]]:

- Caps_Lock <-> Control

#+name: get-keycode
#+begin_src bash :var key="Caps_Lock" :tangle no
xmodmap -pke | grep "$key" | awk '{print $2}'
#+end_src

#+begin_src conf :tangle /home/yantar92/.xmodmap :comments no
! First clear all modifiers, caps lock & control
clear lock
clear control

keycode  66 = Control_L

! We need to set keycodes first, as some programs (emacs!) read
! the key names and seem to ignore what's below.
add control = Control_R Control_L
#+end_src

#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash 
xmodmap ~/.xmodmap
#+end_src
** =x11-apps/mesa-progs=: testing 3d acceleration
:PROPERTIES:
:ID:       d885ca05-6b8f-4866-8527-290788160322
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
x11-apps/mesa-progs
#+end_src

** =app-text/languagetool=: Grammar checking
:PROPERTIES:
:ID:       d6766e50-9870-46a4-b70f-19d977a0bbb6
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/languagetool
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/languagetool
app-text/languagetool ~amd64
#+end_src

** =media-gfx/graphviz=: LaTeX for diagrams
:PROPERTIES:
:ID:       069366f4-0eac-4d23-b186-7020185e1bcb
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-gfx/graphviz
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/graphviz
media-gfx/graphviz svg doc
#+end_src
** =app-text/diffpdf=
:PROPERTIES:
:ID:       61837011-1bce-41d6-8aa5-27bc4335466d
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-text/diffpdf
#+end_src

Compare pdfs visually and/or textually
** =redshift=: colour adjustment according to time of day :crypt:TANGLE:

-----BEGIN PGP MESSAGE-----

hQEMA3SKBiQ2zhL6AQgAnFo9ZDDZwWxfba1y/Yn0qjegwwDgpde50ORulRQHlEJ/
j5okKGhI7Nqw+wfxwzCFQlY6OQzeYMsaPSvlRuYgP80/tRUPasHisLn9eej1FEK7
IQHHLpVdd5iyFLlOzMxnKoOLcGb2C/paclPjj3HRCNk94hod6iWnn2aqf+82tVu+
ouTzWAKiQLPnajmUBYTtQ6S0MyNhjCWLzumaI+p8kNT1zAqic0nWTdQUa1bkstd2
jwZN1XA9z18lmSM5Ymb9pT43wN3XA/Og2R1ISTZ7Ew6uL5gzOQnlLEkOUYkVIpK9
2nC9Gi1F0V0w/+PWjeSssLsQ4DX0bkkhpBhWgBG/ONLAHQHUIO4BflffbvFZxdKI
nAlE2hJlDaNqzlm/cHfYIYNRqCZOZMc/nQU7ew1e2aATdPGIFbllDeH3ZMT8gRgM
naovmyfzhgyZKWE/XdkCloXHPiIWDZa6aCTdMXfp6P3h35aRSA2tnbVleHS0Q8ao
wUTSKNTN4M6NnkJhD6oY+VMHuHraWR85mQeLVZXimpPRJJ9JC0Qu/5GZh2qNdZSx
y8YLkx6SMKsfAsSxMNK6F13c5AvAzGAu5RjxrFajNJqyxnwZuJBrbi3lP5cSgR7E
duhINtjDS/IzCwRpT5CD
=oFPH
-----END PGP MESSAGE-----
** =sys-fs/avfs=: browse archives
:PROPERTIES:
:ID:       2016fe14-8178-4b66-b0b6-8b98f8aa676a
:END:

Required for Emacs [[id:f14a4a86-b866-4d20-96c5-93d174a0ae6a][Browse archives with =dired-avfs=]]

#+begin_src conf :tangle /sudo::/var/lib/portage/world
sys-fs/avfs
#+end_src

** Python libs
*** =pandas=
:PROPERTIES:
:ID:       3af00999-c8c7-440c-a4ad-bbdf184b4bc1
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-python/pandas
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/pandas
dev-python/pandas doc
#+end_src

*** =numpy=
:PROPERTIES:
:ID:       3a7e9dff-dc15-44f9-ae56-0b2fbcf7607a
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-python/numpy
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/numpy
dev-python/numpy doc
#+end_src


** Games
*** =steam=
:PROPERTIES:
:ID:       701aa136-bd29-452e-8d0e-5de963a5e1f6
:END:

[[id:Wiki.Gentoosteam_gentoo_wikic95][[Wiki.Gentoo] Steam - Gentoo Wiki]]

#+begin_src bash :tangle no :dir /sudo::/ :results output :eval yes
eselect repository enable steam-overlay
#+end_src

#+RESULTS:
: Adding steam-overlay to /etc/portage/repos.conf/eselect-repo.conf ...
: 1 repositories enabled

Do not enable any other packages from the overlay
#+begin_src conf :tangle /sudo::/etc/portage/package.mask/steam-overlay-repo
,*/*::steam-overlay
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/steam-launcher
games-util/steam-launcher::steam-overlay
#+end_src 

#+begin_src conf :tangle /sudo::/var/lib/portage/world
games-util/steam-launcher
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.license/steam-launcher
games-util/steam-launcher ValveSteamLicense
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/steam-launcher
games-util/steam-launcher ~amd64
#+end_src

*** Need =media-video/rtmpdump= for =Loop hero=
:PROPERTIES:
:ID:       e3e64e2a-4796-4228-82cc-27e03c3a0bb6
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-video/rtmpdump
#+end_src

** obs-studio - recording
:PROPERTIES:
:ID:       aa9e60f6-4367-4450-9eed-8006a9356740
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-video/obs-studio
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/obs
media-video/obs-studio v4l
#+end_src
#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/obs
media-video/obs-studio ~amd64
#+end_src

** shotcut - video editing
:PROPERTIES:
:ID:       affdb0c5-d0d2-4a9c-bc29-3ad008beccf5
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
media-video/shotcut
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/shotcut
media-video/shotcut ~amd64
#+end_src
#+begin_src conf :tangle /sudo::/etc/portage/package.use/shotcut
media-libs/opencv contrib
#+end_src
** COMMENT diction - command line text style checker
** =app-admin/killproc=: For usleep
:PROPERTIES:
:ID:       b5256619-1f92-4552-b40d-2d477d289da9
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-admin/killproc
#+end_src

** COMMENT =app-portage/pfl= search Tex packages and package files in Gentoo

** =app-portage/gentoolkit= for =equary= and =revdep-rebuild= commands

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-portage/gentoolkit
#+end_src

** =app-portage/eix= quickly search portage packages

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-portage/eix
#+end_src


** perf: Performance debugging
:PROPERTIES:
:ID:       03f7e6f3-cff0-4df8-976c-92338a9304b5
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
dev-util/perf
#+end_src
** =app-dicts/wordnet= package
:PROPERTIES:
:ID:       0ce5f9c5-7c71-46dc-94ef-3cf7ed51fba4
:END:

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-dicts/wordnet
#+end_src
** Libreoffice

#+begin_src conf :tangle /sudo::/var/lib/portage/world
app-office/libreoffice-bin
#+end_src

** Firefox (needed for jitsi that does not work well with [[id:8f33d97b-6193-4164-b0a7-225bb7c30f75][Qutebrowser]])

#+begin_src conf :tangle /sudo::/var/lib/portage/world
www-client/firefox-bin
#+end_src

** COMMENT pantalaimon: end-to-end encryption server for matrix
:PROPERTIES:
:ID:       871f0af1-da9b-4fc0-8275-24f59dd6318e
:END:

#+begin_src bash :tangle no :dir /sudo::/ :results output :eval yes
eselect repository enable src_prepare-overlay
#+end_src

We only enable packages from the foreign repository selectively
#+begin_src conf :tangle /sudo::/etc/portage/package.mask/src_prepare-overlay-repo
,*/*::src_prepare-overlay
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/pantalaimon
net-im/pantalaimon::src_prepare-overlay
#+end_src 

#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/pantalaimon
net-im/pantalaimon::src_prepare-overlay ~amd64
#+end_src 

#+begin_src conf :tangle /sudo::/var/lib/portage/world
net-im/pantalaimon
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.use/pantalaimon
net-im/pantalaimon panctl dbus
#+end_src

Configuration [[id:Cogitri-setting-up-pantalaimon-a80][[Cogitri] Setting up Pantalaimon for usage with Matrix clients and using panctl - Cogitri's blog]]

#+begin_src conf :tangle /home/yantar92/.config/pantalaimon/pantalaimon.conf :mkdirp yes
[local-matrix]
Homeserver = https://matrix.org
ListenAddress = localhost
ListenPort = 8010
#+end_src

Autostart

#+begin_src bash :tangle /home/yantar92/.config/awesome/startup :shebang #!/bin/bash
pantalaimon --log-level warning 2>&1 | pantalaimon-logger.sh &
#+end_src

#+begin_src bash :tangle /home/yantar92/.local/bin/pantalaimon-logger.sh :shebang #!/bin/bash
while read x; do
    [[ "$x" == "" ]] && continue
    echo $(date): $x >> ~/.log/paintalaimon-monitor.log
done
#+end_src



* Archived

** COMMENT Compositor (compton) :COMMON:@home:HOLD:
:PROPERTIES:
:ID:       47146ef7-67fd-4f69-a9e1-a0a8290ae45d
:ARCHIVE_TIME: 2023-01-25 Wed 13:48
:ARCHIVE_FILE: ~/Org/system-config.org
:ARCHIVE_OLPATH: System: Gentoo Linux/GUI/X window system
:ARCHIVE_CATEGORY: system-config
:ARCHIVE_ITAGS: COMMON @home HOLD
:END:

#+begin_src conf :tangle /sudo::/etc/portage/package.use/compton
x11-misc/compton opengl
#+end_src

Run at startup 

#+begin_src bash :tangle /home/yantar92/.xinitrc
compton &
#+end_src
*** Configuration
:PROPERTIES:
:ID:       f9cd45f6-7aff-4415-a206-fc2200a00dc7
:END:

#+begin_src conf :tangle /home/yantar92/.config/compton.conf
# Shadow
shadow = false;
no-dnd-shadow = true;
no-dock-shadow = true;
clear-shadow = true;
shadow-radius = 7;
shadow-offset-x = -7;
shadow-offset-y = -7;
# shadow-opacity = 0.7;
# shadow-red = 0.0;
# shadow-green = 0.0;
# shadow-blue = 0.0;
shadow-exclude = [ "name = 'Notification'", "class_g = 'Conky'", "class_g ?= 'Notify-osd'", "class_g = 'Cairo-clock'" ];
# shadow-exclude = "n:e:Notification";
shadow-ignore-shaped = false;
# shadow-exclude-reg = "x10+0+0";
# xinerama-shadow-crop = true;

# Opacity
menu-opacity = 0.9;
#inactive-opacity = 0.9;
# active-opacity = 0.5;
#frame-opacity = 0.8;
inactive-opacity-override = false;
alpha-step = 0.06;
# inactive-dim = 0.2;
# inactive-dim-fixed = true;
# blur-background = true;
# blur-background-frame = true;
blur-kern = "3x3box"
# blur-kern = "5,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1"
# blur-background-fixed = true;
blur-background-exclude = [ "window_type = 'dock'", "window_type = 'desktop'", "n:a:Gnuplot" ];
# opacity-rule = [ "80:class_g = 'URxvt'" ];

# Fading
fading = false;
fade-delta = 30;
fade-in-step = 0.1;
fade-out-step = 0.1;
# no-fading-openclose = true;

# Other
#backend = "xrender"
backend = "glx"
mark-wmwin-focused = true;
mark-ovredir-focused = true;
use-ewmh-active-win = true;
detect-rounded-corners = true;
detect-client-opacity = true;
refresh-rate = 0;
vsync = "opengl-swc";
dbe = false;
paint-on-overlay = true;
 sw-opti = true;
 unredir-if-possible = true;
 unredir-if-possible-delay = 5000;
# unredir-if-possible-exclude = [ ];
focus-exclude = [ "class_g = 'Cairo-clock'" ];
detect-transient = true;
detect-client-leader = true;
invert-color-include = [ ];
# resize-damage = 1;

# GLX backend
# glx-no-stencil = true;
glx-copy-from-front = false;
# glx-use-copysubbuffermesa = true;
# glx-no-rebind-pixmap = true;
glx-swap-method = "undefined";
glx-use-gpushader4 = true;

transition-length = 100

# Window type settings
wintypes:
{
  tooltip = { fade = true; shadow = false; opacity = 0.75; focus = true; };
};
#+end_src


** COMMENT Sakaki tools for system maintenance :COMMON:@home:HOLD:
:PROPERTIES:
:ARCHIVE_TIME: 2023-01-08 Sun 07:55
:ARCHIVE_FILE: ~/Org/system-config.org
:ARCHIVE_OLPATH: System: Gentoo Linux/Basic toolchain/Portage
:ARCHIVE_CATEGORY: system-config
:ARCHIVE_ITAGS: COMMON @home HOLD
:END:
*** Installation
:PROPERTIES:
:ID:       72efea6f-fc9b-4ae4-be32-643b678e0912
:END:

The tools are located in github repository overlay.
#+begin_src conf :tangle /sudo::/etc/portage/repos.conf/sakaki-tools.conf
[sakaki-tools]

# Various utility ebuilds for Gentoo on EFI
# Maintainer: sakaki (sakaki@deciban.com)

location = /var/db/repos/sakaki-tools
sync-type = git
sync-uri = https://github.com/sakaki-/sakaki-tools.git
priority = 50
auto-sync = yes
#+end_src

We only enable packages from the foreign repository selectively
#+begin_src conf :tangle /sudo::/etc/portage/package.mask/sakaki-tools-repo
,*/*::sakaki-tools
#+end_src
#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/sakaki-tools-repo
,*/*::sakaki-tools ~amd64
#+end_src


We need the following tools: 
- =buildkernel= :: for automatic kernel build into external drive, building initramfs for decryption of root, and splash screen
- =efitools= :: for EFI management
- =genup= :: for automatic system updates
- =showem= :: for installation progress display
- =staticgpg= :: required to build the kernel with decryption

#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/buildkernel
sys-kernel/buildkernel::sakaki-tools
#+end_src 
#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/efitools
app-crypt/efitools::sakaki-tools
#+end_src 
#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/genup
app-portage/genup::sakaki-tools
#+end_src 
#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/showem
app-portage/showem::sakaki-tools
#+end_src
#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/staticgpg
app-crypt/staticgpg::sakaki-tools
#+end_src

#+begin_src conf :tangle /sudo::/etc/portage/package.unmask/genkernel-next
sys-kernel/genkernel-next::sakaki-tools
#+end_src


Some use changes are also needed: enable disk encryption and splash screen (plymouth)
#+begin_src conf :tangle /sudo::/etc/portage/package.use/genkernel-next
# ensure we can generate a bootable kernel and initramfs
sys-kernel/genkernel-next cryptsetup gpg plymouth
#+end_src

Also, =genkernel= does not compile normally. Need newer =busybox=
#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/busybox
# Old genkernel-next does not compile with newer glibc because of using old busybox version (Bug 719968)
>=sys-apps/busybox-1.32.0 ~amd64
#+end_src


Firmware for Linux
#+begin_src conf  :tangle /sudo::/etc/portage/package.license/linux-firmware
sys-kernel/linux-firmware linux-fw-redistributable no-source-code
#+end_src
*** =genup=
**** Custom updaters
***** Cleanup old downloaded package sources
:PROPERTIES:
:ID:       58edad16-6cdc-4311-bb0f-1fa9d0e2100c
:END:

#+begin_src bash :tangle /sudo::/etc/genup/updaters.d/23-eclean-packages.sh :shebang #!/bin/bash
set -e
eclean --deep packages
#+end_src
***** Update live repositories (-9999)
:PROPERTIES:
:ID:       b2c9eb84-d3d2-4360-bbec-16d252258977
:END:

Requires app-portage/smart-live-rebuild

#+begin_src bash :tangle /sudo::/etc/genup/updaters.d/23-smart-live-rebuild.sh :shebang #!/bin/bash
set -e
smart-live-rebuild
#+end_src
**** TODO Genkernel config

[2021-04-03 Sat] Instead of setting busybox version manually, may as well just use latest automatically? But how?


** COMMENT =dev-util/git-delta=: better diff viewer [[id:ccf5be93-81a8-4566-a30c-b11b29df9c64][Emacs: Use dandavison [Github] dandavison/delta: A viewer for git and diff output to show diffs]] :COMMON:HOLD:
:PROPERTIES:
:SUMMARY:  Performance in Emacs is too low
:ARCHIVE_TIME: 2021-08-13 Fri 15:10
:ARCHIVE_FILE: ~/Org/system-config.org
:ARCHIVE_OLPATH: System: Gentoo Linux
:ARCHIVE_CATEGORY: system-config
:ARCHIVE_ITAGS: COMMON HOLD
:END:
- Note taken on [2021-08-13 Fri 15:09] \\
  Performance in Emacs is too low

** COMMENT youtube-dl :COMMON:HOLD:
:PROPERTIES:
:ID:       196911f2-6730-4bf0-aea1-1090f1cb21bb
:SUMMARY:  unmaintained and countered by youtube now
:ARCHIVE_TIME: 2021-10-18 Mon 11:52
:ARCHIVE_FILE: ~/Org/system-config.org
:ARCHIVE_OLPATH: System: Gentoo Linux/Video
:ARCHIVE_CATEGORY: system-config
:ARCHIVE_ITAGS: COMMON HOLD
:END:

- Note taken on [2021-10-18 Mon 11:52] \\
  unmaintained and countered by youtube now
Use the latest version to make sure that everything works.
#+begin_src conf :tangle /sudo::/etc/portage/package.accept_keywords/youtube-dl
net-misc/youtube-dl **
#+end_src
** COMMENT Old IceWM config :ATTACH:note:
:PROPERTIES:
:CREATED:  [2020-05-03 Sun 20:42]
:ID:       40ba3031-880e-4710-ac18-fa691fee729a
:END:
:LOGBOOK:
- Refiled on [2022-05-06 Fri 10:55]
:END:

My old config: [[attachment:Icewm/.icewm/]]

** COMMENT SELinux :COMMON:@home:HOLD:
:PROPERTIES:
:ID:       73c07da0-b330-496b-a004-2352001ef1a6
:ARCHIVE_TIME: 2023-01-07 Sat 18:27
:ARCHIVE_FILE: ~/Org/system-config.org
:ARCHIVE_OLPATH: System: Gentoo Linux/Basic toolchain/System setup
:ARCHIVE_CATEGORY: system-config
:ARCHIVE_ITAGS: COMMON @home HOLD
:END:

Following [[id:0d722188b8f0fc3fe0d95e38f7b4cac3f3967919][[Wiki.Gentoo] SELinux/Installation - Gentoo Wiki]]

#+begin_src conf :tangle /sudo::/etc/portage/make.conf
POLICY_TYPES="strict"
USE="peer_perms open_perms"
#+end_src

#+begin_src conf :tangle /sudo::/etc/selinux/config
# This file controls the state of SELinux on the system on boot.

# SELINUX can take one of these three values:
#	enforcing - SELinux security policy is enforced.
#	permissive - SELinux prints warnings instead of enforcing.
#	disabled - No SELinux policy is loaded.
SELINUX=permissive

# SELINUXTYPE can take one of these four values:
#	targeted - Only targeted network daemons are protected.
#	strict   - Full SELinux protection.
#	mls      - Full SELinux protection with Multi-Level Security
#	mcs      - Full SELinux protection with Multi-Category Security 
#	           (mls, but only one sensitivity level)
SELINUXTYPE=strict
#+end_src

[2020-12-13 Sun] The current version of Gentoo Wiki does not show how to enable SELinux in newer kernels (5.4.80). I found [[id:0dd53ee83c9bfbb28c750acc10c432a771455a9b][torvalds [Github] LSM: Revive CONFIG_DEFAULT_SECURITY_* for "make oldconfig"]] showing that default value of "A comma-separated list of LSMs, in initialization order" should be changed when setting SELinux.


** COMMENT VPN service - old :COMMON:@home:HOLD:crypt:TANGLE:
:PROPERTIES:
:ID:       c9763353-b69f-44f9-800d-c4c1dd79c095
:ARCHIVE_TIME: 2023-01-20 Fri 16:44
:ARCHIVE_FILE: ~/Org/system-config.org
:ARCHIVE_OLPATH: System: Gentoo Linux/Basic toolchain/Network/VPN
:ARCHIVE_CATEGORY: system-config
:ARCHIVE_ITAGS: COMMON @home HOLD
:END:

-----BEGIN PGP MESSAGE-----

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
HTSEhXTfUFX7ouiBGjS4tzGJ6A1JcA==
=asGb
-----END PGP MESSAGE-----
